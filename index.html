<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LIGMOT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* === デザインは変更していません（見た目そのまま） === */
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      color: #333;
    }
    /* ログイン画面 */
    #login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #e9ecef;
    }
    .login-box {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 300px;
    }
    .login-box h2 { margin-bottom: 1rem; }
    .login-box input {
      width: 100%;
      padding: 0.6rem;
      margin: 0.5rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .login-box button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 1rem;
      border: none;
      border-radius: 6px;
      background: #28a745;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    .login-box button:hover { background: #218838; }
    .error { color: red; font-size: 0.9rem; margin-top: 0.5rem; }

    /* メインページ（レイアウトは絶対に変えない） */
    #main-page { display: none; height: 100vh; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2c3e50;
      color: #fff;
      padding: 0.8rem 1.2rem;
    }
    .logo { font-size: 1.2rem; font-weight: bold; }
    .user-info { display:flex; align-items:center; gap:1rem; }
    #session-timer { font-size: 0.95rem; color:#f1c40f; } /* 追加表示（見た目に溶けるよう控えめ） */
    #test-timer { font-size:0.95rem; color:#2ecc71; font-weight:bold; margin-left:8px; } /* テストタイマー（右上表示） */
    .logout-btn {
      background: #e74c3c;
      border: none;
      padding: 0.4rem 0.8rem;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn:hover { background: #c0392b; }

    main { display:flex; height: calc(100vh - 50px); }
    nav {
      width: 200px;
      background: #34495e;
      color: #fff;
      padding-top: 1rem;
    }
    nav ul { list-style:none; padding:0; margin:0; }
    nav ul li {
      padding: 0.8rem 1rem;
      cursor: pointer;
    }
    nav ul li:hover { background: #3d566e; }
    nav ul li.disabled { opacity: 0.4; pointer-events: none; } /* テスト中は無効化 */
    section { flex: 1; padding: 2rem; overflow-y: auto; }

    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:16px; }
    .q-block{ border:1px solid #e7eef2; padding:12px; border-radius:8px; margin-bottom:12px; background:#fbfdff; }
    .choice-row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .choice-row input[type="text"]{ flex:1; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row input[type="number"]{ width:100px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row select{ width:120px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .btn-plain{ padding:8px 10px; border-radius:6px; border:0; cursor:pointer; }
    .btn-primary{ background:#2c3e50; color:#fff; }
    .btn-danger{ background:#e74c3c; color:#fff; }
    .hidden{ display:none !important; }

    /* small helper for edit buttons list */
    .part-item { border:1px solid #eef3f5; padding:12px; border-radius:8px; margin-bottom:12px; background:#fff; }
    .part-actions { margin-top:8px; display:flex; gap:8px; }

    /* トロフィーアニメーション */
    .trophy-anim {
      animation: shine 2s infinite linear;
      display: inline-block;
    }
    @keyframes shine {
      0%   { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
      25%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      50%  { transform: scale(1.2) rotate(5deg); filter: drop-shadow(0 0 12px rgba(255,255,255,1)); }
      75%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
    }

/* --- bnp pill --- */
#bnp-display{
  background: #fff;
  color: #2c3e50;
  padding: 6px 30px;
  border-radius: 999px; /* 半円形 */
  display:inline-flex;
  align-items:center;
  gap:8px;
  min-width:88px;
  justify-content:flex-end; /* 数字は右寄せ */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-weight:700;
  margin-right: 8px; /* user-info 内の余白 */
}
#bnp-value{ font-size:1.05em; }
#bnp-unit{ font-size:0.85em; color:#666; padding-left:4px; }

/* 文法特訓の設問文 → スペースや改行を保持 */
.grammar-question-text {
  white-space: pre-wrap;
}

/* 並べ替え問題のUI */
#answer-area {
  border:2px solid black;
  padding:8px;
  min-height:40px;
  margin-bottom:10px;
}

.word-table {
  width: 100%;
  border-collapse: collapse;
}
.word-table th, .word-table td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: left;
}
.word-table th {
  background: #f8f8f8;
  font-weight: bold;
}
.word-table td[contenteditable="true"]:focus {
  background: #fff9d6;
  outline: none;
｝

  </style>

  <!-- Font Awesome 読み込み（トロフィーアイコン用） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>


<body>
  <!-- ログイン -->
  <div id="login-page">
    <div class="login-box">
      <h2>ログイン</h2>
      <form id="login-form">
        <input type="text" id="login-id" placeholder="ユーザーID" required>
        <input type="password" id="login-password" placeholder="パスワード" required>
        <button type="submit">ログイン</button>
      </form>
      <div id="login-error" class="error"></div>
      <div style="margin-top:8px;font-size:12px;color:#666">
        IDまたはパスワードは、管理者に問い合わせてください。
      </div>
    </div>
  </div>

  <!-- メイン -->
  <div id="main-page">
    <header>
      <div class="logo">📘 LIGMOT</div>
      <div class="user-info" aria-live="polite">
<!-- 既存の .user-info の一番上（または user-name の左）に追加 -->
<div id="bnp-display" title="獲得バナポ">
  <span id="bnp-value">0</span>
  <span id="bnp-unit"> bnp</span>
</div>
        <span id="user-name">—</span>
        <span id="session-timer">残り: 60:00</span>
        <span id="test-timer" class="hidden">テスト残り: 15:00</span> <!-- テスト中のみ表示 -->
        <button id="logout-btn" class="logout-btn">ログアウト</button>
      </div>
    </header>

    <main>
      <nav>
        <ul>
          <li id="menu-userinfo">ユーザー情報</li>
          <li id="menu-test">テスト</li>
          <li id="menu-history">過去の成績</li>
          <li id="menu-mywordlist">マイ単語リスト</li>
          <li id="menu-audio">音声コンテンツ</li>
          <li id="menu-studylog">学習の記録</li>
          <li id="menu-create" class="hidden">問題作成</li>
          <li id="menu-list" class="hidden">問題一覧</li>
          <li id="menu-grammar-admin" class="hidden">文法問題作成</li>
          <li id="menu-wordlist" class="hidden">単語リスト管理</li>
          <li id="menu-useradmin" class="hidden">ユーザー管理</li>
        </ul>
      </nav>
      <section id="content">
        <div class="card"><h2>ようこそ！</h2><p>左のメニューから操作を選んでください。</p></div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK + 機能追加（モジュール） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";



    const firebaseConfig = {
      apiKey: "AIzaSyAIg8mvIn8K5qDfP_ozemtZRqKIEioTfMY",
      authDomain: "la-estacion-ymd.firebaseapp.com",
      projectId: "la-estacion-ymd",
      storageBucket: "la-estacion-ymd.firebasestorage.app",
      messagingSenderId: "996153459691",
      appId: "1:996153459691:web:5d9054f92f521fb8388fae",
      measurementId: "G-QKD7SC860Y"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const auth = getAuth(app);
let myWordList = []; // 各ユーザーごとの単語を入れる配列

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = { id: user.uid, email: user.email };
    console.log("✅ ログイン中:", currentUser.email);
    await loadMyWordListFromFirestore(); // ← Firestoreから自分の単語を読み込み
  } else {
    console.log("⚠️ ログアウト状態");
    currentUser = null;
    myWordList = [];
  }
});

    // === ユーザー固定情報 ===
    const users = {
      "aduser0110": { password: "ady84536172", role: "admin" },
      "test0110":   { password: "assalam", role: "user" },
      "user011001": { password: "assalam", role: "user" },
      "user011002": { password: "assalam", role: "user" },
      "user011003": { password: "assalam", role: "user" },
      "user011004": { password: "assalam", role: "user" },
      "user011005": { password: "assalam", role: "user" },
      "user011006": { password: "assalam", role: "user" },
      "user011007": { password: "assalam", role: "user" }
    };

    let currentUser = null;

    // ===== セッションカウントダウン（既存仕様） =====
    let idleSeconds = 60 * 60;
    let idleInterval = null;
    function startSessionCountdown(){
      idleSeconds = 60 * 60;
      if(idleInterval) clearInterval(idleInterval);
      updateSessionDisplay();
      idleInterval = setInterval(()=>{
        idleSeconds--;
        updateSessionDisplay();
        if(idleSeconds <= 0){
          clearInterval(idleInterval);
          idleInterval = null;
          alert('60分無操作のため自動ログアウトします。');
          doLogout();
        }
      }, 1000);
    }
    function updateSessionDisplay(){
      const mm = String(Math.floor(idleSeconds/60)).padStart(2,'0');
      const ss = String(idleSeconds % 60).padStart(2,'0');
      const el = document.getElementById('session-timer');
      if(el) el.textContent = `残り: ${mm}:${ss}`;
    }
    function resetIdle(){ idleSeconds = 60 * 60; updateSessionDisplay(); }
    ['mousemove','keydown','click','touchstart','scroll'].forEach(ev=>{
      document.addEventListener(ev, ()=>{ if(currentUser) resetIdle(); }, {passive:true});
    });

    // ===== ログイン =====
    document.getElementById('login-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = document.getElementById('login-id').value.trim();
      const pw = document.getElementById('login-password').value.trim();
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';
      if(!id || !pw){ errEl.textContent = 'IDとパスワードを入力してください'; return; }
      if(users[id] && users[id].password === pw){
        currentUser = { id, role: users[id].role };
        showMain();
      } else {
        errEl.textContent = 'IDまたはパスワードが違います';
      }
    });

    // ===== 表示切替（ログイン成功時） =====
    function showMain(){
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-page').style.display = 'block';
      document.getElementById('user-name').textContent = currentUser.id;
      // 管理者メニュー表示制御
      if(currentUser.role === 'admin'){
        document.getElementById('menu-create').classList.remove('hidden');
        document.getElementById('menu-list').classList.remove('hidden');
        document.getElementById('menu-useradmin').classList.remove('hidden');
        document.getElementById('menu-grammar-admin').classList.remove('hidden');
        document.getElementById('menu-wordlist').classList.remove('hidden');
      } else {
        document.getElementById('menu-create').classList.add('hidden');
        document.getElementById('menu-list').classList.add('hidden');
        document.getElementById('menu-useradmin').classList.add('hidden');
        document.getElementById('menu-grammar-admin').classList.add('hidden');
        document.getElementById('menu-wordlist').classList.add('hidden');
      }
      // start session countdown
      startSessionCountdown();
      // default content (test menu)
      renderTestMenu();
    }

    // ===== ログアウト =====
    document.getElementById('logout-btn').addEventListener('click', ()=> {
      if(confirm('ログアウトしますか？')) doLogout();
    });
    function doLogout(){
      // stop test if running
      if(testActive) {
        stopTest(); // stop timers and UI
      }
      currentUser = null;
      if(idleInterval){ clearInterval(idleInterval); idleInterval = null; }
      document.getElementById('main-page').style.display = 'none';
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('login-form').reset();
      // reset display
      document.getElementById('session-timer').textContent = '残り: 60:00';
      document.getElementById('content').innerHTML = `<div class="card"><h2>ようこそ！</h2><p>左のメニューから操作を選んでください。</p></div>`;
    }

// ===== サイドメニュー動作（そのまま） =====
document.getElementById('menu-test').addEventListener('click', ()=> { if(!testActive) renderTestMenu(); });
document.getElementById('menu-history').addEventListener('click', ()=> { if(!testActive) renderHistory(); });
document.getElementById('menu-create').addEventListener('click', ()=> { if(!testActive) renderCreateForm(); });
document.getElementById('menu-list').addEventListener('click', ()=> { if(!testActive) loadPartsList(); });

document.getElementById('menu-useradmin').addEventListener('click', ()=> { if(!testActive) renderUserManagement(); });
document.getElementById('menu-grammar-admin').addEventListener('click', ()=> { if(!testActive) renderGrammarAdminHome(); });
document.getElementById('menu-wordlist').addEventListener('click', ()=> { 
  if(!testActive) renderWordList(); 
});
document.getElementById('menu-mywordlist').addEventListener('click', ()=> {
  if (!testActive) renderMyWordList();
});

    // ===== テストメニュー（雛形） =====
// ===== テストメニュー（ピンク枠・横一列版） =====
function renderTestMenu() {
  document.getElementById('content').innerHTML = `
    <div class="card test-main-card">
      <h2 class="test-title">英語</h2>

      <div class="test-card-row">
        <div class="test-card">
          <h3>速読力測定テスト</h3>
          <button class="btn-plain btn-primary" id="start-speed">テストを始める</button>
        </div>

        <div class="test-card">
          <h3>文法特訓</h3>
          <button class="btn-plain btn-primary" id="start-grammar">特訓開始</button>
        </div>

        <div class="test-card">
          <h3>単語テスト</h3>
          <button class="btn-plain btn-primary" id="start-wordtest">テストを始める</button>
        </div>
      </div>
    </div>
  `;

  // スタイル追加
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    /* === 全体カード === */
    .test-main-card {
      max-width: 1000px;
      margin: 40px auto;
      padding: 32px 24px;
      background: #ffeef2;
      border: 3px solid #f5b5c5;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* === タイトル（左寄せ・大きく・見出し向きフォント） === */
    .test-title {
      text-align: left;
      font-size: 36px;
      color: #333;
      margin-bottom: 32px;
      font-weight: 700;
      font-family: 'Merriweather', 'Noto Serif JP', serif;
    }

    /* === 3カード横並び === */
    .test-card-row {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 24px;
      flex-wrap: nowrap;
    }

    /* === 各カード === */
    .test-card {
      flex: 1 1 280px;
      max-width: 300px;
      background: white;
      border: 2px solid #f5b5c5;
      border-radius: 16px;
      padding: 28px 16px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .test-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .test-card h3 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #333;
      font-weight: 600;
    }

    .test-card button {
      font-size: 17px;
      padding: 12px 32px;
      border-radius: 8px;
    }

    /* スマホ対応（小さい画面では縦並び） */
    @media (max-width: 768px) {
      .test-card-row {
        flex-wrap: wrap;
      }
      .test-card {
        width: 100%;
        max-width: none;
      }
    }
  `;
  document.head.appendChild(styleTag);


  // 既存の start-speed ハンドラは残す（A2 の他の場所でも拾っているが二重登録を避ける）
  const startBtn = document.getElementById('start-speed');
  if(startBtn) startBtn.addEventListener('click', async ()=> {
    if(confirm('テストを開始します。制限時間は15分です。')) await startTest();
  });

  const grammarBtn = document.getElementById('start-grammar');
  if(grammarBtn) grammarBtn.addEventListener('click', async ()=> {
    if(confirm('文法特訓を開始します。50問連続で出題されます。')) {
      await startGrammarTraining();
    }
  });
 const wordtestBtn = document.getElementById('start-wordtest');
  if(wordtestBtn) wordtestBtn.addEventListener('click', renderWordTestMenu);
}


// ===== 単語テスト：モード・レベル・出題数選択画面 =====
function renderWordTestMenu(defaultMode = 'en-ja') {
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:800px;margin:auto;padding:24px;">
      <h2 style="text-align:center;margin-bottom:24px;">単語テスト</h2>

      <!-- モード選択 -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">モードを選択してください</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
    <label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="en-ja" ${defaultMode==='en-ja'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">英 → 日</div>
    <div class="wt-card-sub">英単語から意味を選ぶ</div>
  </div>
</label>
<label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="ja-en" ${defaultMode==='ja-en'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">日 → 英</div>
    <div class="wt-card-sub">日本語から英単語を入力する</div>
  </div>
</label>
<label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="mywords" ${defaultMode==='mywords'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">MyWords</div>
    <div class="wt-card-sub">自分の苦手単語から出題</div>
  </div>
</label>
        </div>
      </div>

      <!-- レベル選択 -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">レベルを選択してください</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
          ${['A','B','C','D','E'].map(l=>`
            <label class="wt-level-btn" data-level="${l}">
              <input type="checkbox" class="wt-level" value="${l}" ${l==='A' ? 'checked':''} hidden>
              <div class="wt-level-circle">${l}</div>
            </label>
          `).join('')}
        </div>
      </div>

      <!-- 出題数選択 -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">出題数を選択してください</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
          ${[20,50,100].map(n=>`
            <label class="wt-count-card">
              <input type="radio" name="wt-count" value="${n}" ${n===20?'checked':''} hidden>
              <div class="wt-card-content">
                <div class="wt-card-title">${n}問</div>
              </div>
            </label>
          `).join('')}
        </div>
      </div>

      <!-- ボタン -->
      <div style="text-align:center;margin-top:24px;">
        <button class="btn-plain btn-primary" id="wt-start" style="padding:10px 24px;font-size:16px;">テスト開始</button>
        <button class="btn-plain" id="wt-back" style="padding:10px 24px;font-size:16px;margin-left:8px;">戻る</button>
      </div>
    </div>

    <!-- モーダル用 -->
    <div id="range-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:300px;width:100%;text-align:center;">
        <h3 style="margin-bottom:12px;">出題範囲を入力</h3>
        <div style="margin-bottom:12px;">
          <label>From: <input type="number" id="range-from" style="width:70px; height:30px; font-size:16px;"></label>
          <label style="margin-left:12px;">
To: <input type="number" id="range-to" style="width:70px; height:30px; font-size:16px;"></label>
        </div>
        <div>
          <button class="btn-plain btn-primary" id="range-ok" style="margin-right:8px;">OK</button>
          <button class="btn-plain" id="range-cancel">キャンセル</button>
        </div>
      </div>
    </div>
  `;

  // 戻るボタン
  document.getElementById('wt-back').addEventListener('click', renderTestMenu);

 // モードカード選択ハイライト
document.querySelectorAll('.wt-mode-card').forEach(label => {
  label.addEventListener('click', () => {
    document.querySelectorAll('.wt-mode-card input').forEach(inp => inp.checked = false);
    const input = label.querySelector('input');
    input.checked = true;

    // MyWords選択時はレベルボタンを無効化
    const levelBtns = document.querySelectorAll('.wt-level-btn input');
    if (input.value === 'mywords') {
      levelBtns.forEach(btn => btn.disabled = true);
      document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.add('disabled'));
    } else {
      levelBtns.forEach(btn => btn.disabled = false);
      document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.remove('disabled'));
    }
  });
});



// ページ初期表示時にMyWordsモードが選択されていたらレベルボタンを無効化
if (defaultMode === 'mywords') {
  document.querySelectorAll('.wt-level-btn input').forEach(btn => btn.disabled = true);
  document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.add('disabled'));
}

  // レベルボタン選択＆範囲モーダル
  let activeLevelInput = null;
  document.querySelectorAll('.wt-level-btn').forEach(label=>{
    label.addEventListener('click', ()=>{
      const input = label.querySelector('input');
      input.checked = !input.checked;
      label.classList.toggle('selected', input.checked);
      if(input.checked){
        activeLevelInput = input;
        const prev = input.dataset.range ? input.dataset.range.split('-') : ['1','50'];
        document.getElementById('range-from').value = prev[0];
        document.getElementById('range-to').value = prev[1];
        document.getElementById('range-modal').style.display = 'flex';
      } else {
        input.dataset.range = '';
      }
    });
  });

  // モーダルOK
  document.getElementById('range-ok').addEventListener('click', ()=>{
    if(!activeLevelInput) return;
    const from = document.getElementById('range-from').value;
    const to = document.getElementById('range-to').value;
    if(!from || !to || isNaN(from) || isNaN(to)){
      alert('正しい数字を入力してください');
      return;
    }
    activeLevelInput.dataset.range = `${from}-${to}`;
    document.getElementById('range-modal').style.display = 'none';
    activeLevelInput = null;
  });

  // モーダルキャンセル
  document.getElementById('range-cancel').addEventListener('click', ()=>{
    if(activeLevelInput){
      activeLevelInput.checked = false;
      activeLevelInput.classList.remove('selected');
      activeLevelInput = null;
    }
    document.getElementById('range-modal').style.display = 'none';
  });

  // 出題数選択カード
  document.querySelectorAll('.wt-count-card').forEach(label=>{
    label.addEventListener('click', ()=>{
      document.querySelectorAll('.wt-count-card input').forEach(inp=>inp.checked=false);
      label.querySelector('input').checked = true;
    });
  });

  // テスト開始
 document.getElementById('wt-start').addEventListener('click', () => {
  const mode = document.querySelector('input[name="wt-mode"]:checked').value;
  const count = Number(document.querySelector('input[name="wt-count"]:checked').value);

  let levels = [];
  if (mode !== 'mywords') {
    levels = Array.from(document.querySelectorAll('.wt-level:checked')).map(x => {
      const [from, to] = (x.dataset.range || '1-50').split('-');
      return { level: x.value, from: Number(from), to: Number(to) };
    });
    if (levels.length === 0) {
      alert('レベルを1つ以上選んでください');
      return;
    }
  }

  if (mode === 'mywords') {
    if (myWordList.length === 0) {
      alert('マイ単語リストに単語がありません');
      return;
    }
    // MyWordsテストは英→日固定
    startWordTest({
      mode: 'en-ja',
      levels: [{ level: '', from: 1, to: myWordList.length }],
      count: count,
      words: shuffleArray([...myWordList])  // リストからシャッフル
    });
  } else {
    startWordTest({ mode, levels, count });
  }
});


  // 元のスタイル
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    .wt-mode-card { flex: 1 1 200px; cursor: pointer; border: 2px solid #d0d7dc; border-radius: 12px; transition: all 0.2s ease; }
    .wt-mode-card:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-card-content { padding:16px; text-align:center; }
    .wt-card-title { font-weight:700; font-size:18px; margin-bottom:4px; }
    .wt-card-sub { color:#555; font-size:14px; }
    .wt-mode-card input:checked + .wt-card-content { background-color:#cce4ff; color:#003366; border-radius:10px; border-color:#80bfff; }
    .wt-level-btn { cursor: pointer; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid #d0d7dc; font-weight: bold; font-size: 18px; transition: all 0.2s ease; }
    .wt-level-btn:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-level-btn input:checked + .wt-level-circle, .wt-level-btn input:checked + div { background-color:#cce4ff; color:#003366; border-color:#80bfff; }
    .wt-level-circle { width:100%; height:100%; display:flex; align-items:center; justify-content:center; border-radius:50%; }
    .wt-count-card { flex: 1 1 80px; cursor: pointer; border: 2px solid #d0d7dc; border-radius: 12px; transition: all 0.2s ease; }
    .wt-count-card:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-count-card input:checked + .wt-card-content { background-color:#cce4ff; color:#003366; border-radius:10px; border-color:#80bfff; }
    .wt-level-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

  `;
  document.head.appendChild(styleTag);
}

// ===== Firebase & Utility =====
async function loadWordData() {
  const levels = ['A','B','C','D','E'];
  const wordData = {};
  for(const lvl of levels){
    const docRef = doc(db,'wordLists',lvl);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      wordData[lvl] = data.words || [];
    } else {
      console.warn(`レベル ${lvl} のデータが見つかりません`);
      wordData[lvl] = [];
    }
  }
  return wordData;
}
function shuffleArray(array){ return array.sort(()=>Math.random()-0.5); }

function selectWordsForTest(wordData, levels){
  const selected = [];
  for(const lvl of levels){
    const allWords = wordData[lvl.level] || [];
    const from = Math.max(0,lvl.from-1);
    const to = Math.min(allWords.length,lvl.to);
    selected.push(...allWords.slice(from,to));
  }
  return shuffleArray(selected);
}

function makeChoices(correctWord, allWords){
  // 同じ品詞の候補
  const samePOS = allWords.filter(w => w.pos === correctWord.pos && w.ja !== correctWord.ja);
  let choices = shuffleArray(samePOS).slice(0, 3);

  // もし3つに満たなければ他の単語から補充
  if (choices.length < 3) {
    const others = allWords.filter(w => w.ja !== correctWord.ja && !choices.includes(w));
    const needed = 3 - choices.length;
    choices.push(...shuffleArray(others).slice(0, needed));
  }

  return shuffleArray([correctWord.ja, ...choices.map(w => w.ja)]);
}

// ===== テスト本体 =====
let testWords = [];
let currentIndex = 0;
let score = 0;
let userAnswers = [];
let testMode = "en-ja";
let streakCount = 0;

async function startWordTest({ mode, levels, count, words = null }) {
  let selectedWords;
  if (words) {
    selectedWords = words.slice(0, count);
  } else {
    const wordData = await loadWordData();
    selectedWords = selectWordsForTest(wordData, levels).slice(0, count);
  }

  testMode = mode;
  testWords = selectedWords;
  currentIndex = 0;
  score = 0;
  userAnswers = [];
  streakCount = 0;
  nextQuestion();
}

function nextQuestion() {
  // ✅ フィードバック中は次の問題を出さない
  const oldFeedback = document.getElementById('answer-feedback');
  if (oldFeedback) return;

  // ✅ 最後の問題が終わったら結果画面へ
  if (!testWords || currentIndex >= testWords.length) {
    renderTestResult();
    return;
  }

  const w = testWords[currentIndex];
  if (testMode === "en-ja") {
    const choices = makeChoices(w, testWords);
    renderWordQuestion(w.en, choices, currentIndex, testWords.length);
  } else if (testMode === "ja-en") {
    renderWordQuestionInput(w.ja, w.en, currentIndex, testWords.length);
  }
  currentIndex++;
}


// ===== 英→日 =====
function renderWordQuestion(question, choices, index, total, timeLeft = 3) {
  document.getElementById("content").innerHTML = `
    <div id="test-area" class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>問題 ${index + 1} / ${total}</h2>
      <div style="margin:16px 0;font-size:36px;font-weight:bold;">${question}</div>
      <div id="choice-container" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">
        ${choices
          .map(
            (c, i) =>
              `<button class="btn-plain btn-choice" data-choice="${i}" style="padding:20px;font-size:20px;">${c}</button>`
          )
          .join("")}
      </div>
      <div style="margin-top:20px;height:8px;background:#eee;border-radius:4px;">
        <div id="time-bar" style="height:100%;width:100%;background:#007bff;border-radius:4px;"></div>
      </div>
    </div>
  `;

  const bar = document.getElementById("time-bar");
  let start = Date.now();
  window.choiceLocked = false; // ← 新規：問題ごとにロック解除

  const timer = setInterval(() => {
    const elapsed = (Date.now() - start) / 1000;
    bar.style.width = `${Math.max(0, 100 * (1 - elapsed / timeLeft))}%`;
    if (elapsed >= timeLeft) {
      clearInterval(timer);
      if (!window.choiceLocked) {
        window.choiceLocked = true;
        disableChoices();
        checkAnswer(null, choices);
      }
    }
  }, 30);

  // 選択肢クリック処理（1回だけ回答可）
  document.querySelectorAll(".btn-choice").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (window.choiceLocked) return; // ← 新規：すでにクリック済みなら無視
      window.choiceLocked = true;

      clearInterval(timer);
      disableChoices();

      checkAnswer(btn.dataset.choice, choices);
    });
  });

  // 選択肢を無効化するヘルパー関数
  function disableChoices() {
    document.querySelectorAll(".btn-choice").forEach((b) => {
      b.style.pointerEvents = "none"; // クリック無効化
      b.style.opacity = "0.6"; // 見た目で無効っぽく
    });
  }
}

// ===== 日→英（入力形式） =====
function renderWordQuestionInput(question, answer, index, total, timeLeft = 10) {
  const masked = answer[0] + " " + "_ ".repeat(answer.length - 1);
  document.getElementById("content").innerHTML = `
    <div id="test-area" class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>問題 ${index + 1} / ${total}</h2>
      <div style="margin:16px 0;font-size:28px;">${question}</div>
      <div id="masked-display" style="margin-bottom:16px;font-size:26px;letter-spacing:6px;color:#555;">${masked}</div>
      <input id="answer-input" type="text" placeholder="英単語を入力"
        style="padding:12px;font-size:22px;width:80%;text-align:center;border:1px solid #ccc;border-radius:8px;">
      <div style="margin-top:16px;">
        <button class="btn-plain btn-primary" id="submit-answer" style="padding:10px 24px;">決定</button>
      </div>
      <div style="margin-top:20px;height:8px;background:#eee;border-radius:4px;">
        <div id="time-bar" style="height:100%;width:100%;background:#28a745;border-radius:4px;"></div>
      </div>
    </div>
  `;

  const bar = document.getElementById("time-bar");
  let start = Date.now();
  const timer = setInterval(() => {
    const elapsed = (Date.now() - start) / 1000;
    bar.style.width = `${Math.max(0, 100 * (1 - elapsed / timeLeft))}%`;
    if (elapsed >= timeLeft) {
      clearInterval(timer);
      checkAnswerInput("", answer);
    }
  }, 30);

  const input = document.getElementById("answer-input");
  const maskedDisplay = document.getElementById("masked-display");

  // 入力リアルタイム反映（2文字目から反映）
input.addEventListener("input", () => {
  const val = input.value.toLowerCase();

  // 入力の先頭文字（頭文字）は無視して、2文字目以降だけ使う
  const subVal = val.slice(1);

  let display = answer[0] + " ";
  for (let i = 1; i < answer.length; i++) {
    display += (subVal[i - 1] ? subVal[i - 1] : "_") + " ";
  }

  maskedDisplay.textContent = display.trim();
});

  document.getElementById("submit-answer").addEventListener("click", () => {
    clearInterval(timer);
    const val = input.value.trim();
    checkAnswerInput(val, answer);
  });
}


// ===== 正解・不正解判定と表示（修正版） =====
function checkAnswer(selectedIndex, choices) {
  // currentIndex は次に進むために ++ されている設計 -> 判定対象は currentIndex - 1
  if (currentIndex <= 0 || currentIndex - 1 >= testWords.length) return;
  const w = testWords[currentIndex - 1];
  const selected = selectedIndex !== null ? choices[selectedIndex] : null;
  const isCorrect = selected === w.ja;

  // 結果を記録（詳細画面用）
  userAnswers.push({ word: w, selected: selected, correct: w.ja });

  if (isCorrect) {
    // 正解
    score++;
    streakCount++;
    // MyWords に入っているなら進捗を更新（en で管理）
    updateMyWordProgress(w.en);
  } else {
    // 不正解：MyWords に自動追加（重複は addToMyWordList が弾く）
    addToMyWordList(w);
    streakCount = 0;
  }

  updateStreakDisplay();
  // フィードバック表示（〇/×）してから次の問題へ
  showAnswerFeedback(isCorrect, nextQuestion);
}

// ===== 日→英（入力形式）の判定で MyWords 更新等を行う =====
function checkAnswerInput(userInput, correct) {
  if (currentIndex <= 0 || currentIndex - 1 >= testWords.length) return;
  const isCorrect = String(userInput || "").trim().toLowerCase() === String(correct || "").trim().toLowerCase();

  // 詳細保存（英語を correct、ja は空文字かあればセット）
  userAnswers.push({ word: { en: correct, ja: "" }, selected: userInput, correct: correct });

  if (isCorrect) {
    score++;
    streakCount++;
    // ja→en モードでも MyWords が存在していたら進捗更新
    updateMyWordProgress(correct);
  } else {
    // 不正解なら MyWords に追加（ja は空だが管理上は en があれば OK）
    addToMyWordList({ en: correct, ja: "" });
    streakCount = 0;
  }

  updateStreakDisplay();
  showAnswerFeedback(isCorrect, nextQuestion);
}

// MyWords に追加する関数（重複チェックあり）
// 追加：MyWords に単語を追加（重複チェックあり） — Firestore に保存
async function addToMyWordList(wordObj) {
  if (!wordObj || !wordObj.en) return;

  // 重複チェック
  if (myWordList.some(w => w.en === wordObj.en)) {
    // 既にある -> 何もしない
    return;
  }

  // ローカルリスト更新
  myWordList.push({
    en: wordObj.en,
    ja: wordObj.ja || "",
    pos: wordObj.pos || "",
    level: wordObj.level || "",
    correctCount: 0
  });

  // Firestore に保存（非同期）
  await saveMyWordListToFirestore();
}

// 更新：正解回数を増やす（5回で削除） — Firestore に保存
async function updateMyWordProgress(en) {
  if (!en) return;
  const target = myWordList.find(item => item.en === en);
  if (!target) return;
  target.correctCount = (target.correctCount || 0) + 1;
  if (target.correctCount >= 5) {
    // リストから削除
    myWordList = myWordList.filter(item => item.en !== en);
  }
  await saveMyWordListToFirestore();
}

// ===== 正解・不正解フィードバック表示（中央配置・大きめ・重複防止＋フェードアウト後に遷移） =====
let feedbackTimeout = null; // グローバルで保持（前のタイマーを止める用）

function showAnswerFeedback(isCorrect, callback) {
  // 既存のフィードバックを強制削除
  if (document.getElementById('answer-feedback')) return;
  const oldFeedback = document.getElementById('answer-feedback');
  if (oldFeedback) oldFeedback.remove();

  // 前回のタイマーがあればリセット
  if (feedbackTimeout) clearTimeout(feedbackTimeout);

  // テスト部分の中央を基準に表示
  const testArea = document.getElementById('test-area') || document.body;
  const rect = testArea.getBoundingClientRect();

  const feedback = document.createElement('div');
  feedback.id = 'answer-feedback';
  feedback.textContent = isCorrect ? '〇' : '×';

  // ===== スタイル設定 =====
  feedback.style.position = 'absolute';
  feedback.style.left = `${rect.width / 2}px`;
  feedback.style.top = `${rect.height / 2.2}px`; // 少し上寄りに（中央近く）
  feedback.style.transform = 'translate(-50%, -50%)';
  feedback.style.fontSize = '180px'; // 大きく！
  feedback.style.fontWeight = '900';
  feedback.style.color = isCorrect
    ? 'rgba(0, 180, 0, 0.4)'
    : 'rgba(255, 0, 0, 0.4)';
  feedback.style.zIndex = '9999';
  feedback.style.pointerEvents = 'none';
  feedback.style.opacity = '1';
  feedback.style.transition = 'opacity 0.8s ease';
  feedback.style.textShadow = '0 0 20px rgba(0,0,0,0.2)';

  // ===== テスト領域内に追加 =====
  testArea.appendChild(feedback);

  // ===== フェードアウトして削除 + 次の問題へ =====
  feedbackTimeout = setTimeout(() => {
    feedback.style.opacity = '0';
    setTimeout(() => {
      feedback.remove();
      if (typeof callback === 'function') callback();
    }, 800);
  }, 800);
}


function updateStreakDisplay() {
  const card = document.querySelector('.card');
  if (!card) return; // 問題カードがない場合は何もしない

  let streakEl = document.getElementById('streak-display');
  if (!streakEl) {
    streakEl = document.createElement('div');
    streakEl.id = 'streak-display';
    streakEl.style.position = 'absolute';
    streakEl.style.top = '8px';
    streakEl.style.right = '16px';
    streakEl.style.fontSize = '16px';
    streakEl.style.fontWeight = 'bold';
    streakEl.style.color = '#28a745';
    card.style.position = 'relative'; // カードを基準に絶対配置
    card.appendChild(streakEl);
  }

  if (streakCount >= 3) {
    streakEl.textContent = `${streakCount}問連続正解中！`;
    streakEl.style.display = 'block';
  } else {
    streakEl.style.display = 'none';
  }
}

// ===== 結果・詳細画面 =====

// Firestore に結果を保存する関数
// ===== 単語テスト結果を Firestore に保存 =====
async function saveWordTestResult(score, totalQuestions, answersArray = []) {
  try {
    if (!currentUser) {
      alert("ログインしてください");
      return;
    }

    const uid = currentUser.id;

    const answers = (answersArray || []).map(q => ({
      question: q.question || q.word || '',
      selected: q.userAnswer || q.selected || '',
      correctAnswer: q.correctAnswer || q.correct || '',
      isCorrect: q.isCorrect === true || q.userAnswer === q.correctAnswer,
      score: q.isCorrect === true || q.userAnswer === q.correctAnswer ? 1 : 0
    }));

    await addDoc(collection(db, "results"), {
      uid,
      type: "単語テスト",
      score,
      fullScore: totalQuestions,
      answers,
      createdAt: new Date()
    });

    console.log("✅ 単語テスト結果をFirestoreに保存しました");
  } catch (err) {
    console.error("❌ saveWordTestResult error", err);
    alert("保存中にエラーが発生しました: " + err.message);
  }
}


// renderTestResult — 結果画面を描画し、保存を呼ぶ
function renderTestResult() {
  // streak 非表示（あれば）
  const streakEl = document.getElementById('streak-display');
  if (streakEl) streakEl.style.display = 'none';

  // Firestore に結果を保存（非同期）
  try {
    saveWordTestResult(score, testWords.length);
  } catch (e) {
    console.error('saveWordTestResult 呼び出しエラー:', e);
  }

  // 結果画面を描画
  document.getElementById("content").innerHTML = `
    <div class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>テスト終了</h2>
      <p style="font-size:28px;font-weight:bold;">正答数: ${score} / ${testWords.length}</p>
      <div style="margin-top:16px;">
        <button class="btn-plain btn-primary" id="btn-retry">もう一度</button>
        <button class="btn-plain" id="btn-menu">テストメニューに戻る</button>
        <button class="btn-plain" id="btn-details" style="margin-left:8px;">くわしく見る</button>
      </div>
    </div>
  `;

  // イベントリスナー
  document.getElementById("btn-retry").addEventListener("click", renderWordTestMenu);
  document.getElementById("btn-menu").addEventListener("click", renderTestMenu);
  document.getElementById("btn-details").addEventListener("click", renderTestDetails);
}



// ===== 解答詳細画面 =====
function renderTestDetails() {
  document.getElementById("content").innerHTML = `
    <div class="card" style="max-width:700px;margin:auto;padding:24px;">
      <h2 style="text-align:center;margin-bottom:16px;">解答詳細</h2>
      <div style="max-height:500px;overflow-y:auto;" id="detail-answers">
        <!-- 個別解答はJSで追加 -->
      </div>
      <div style="text-align:center;margin-top:16px;">
        <button class="btn-plain btn-primary" id="btn-retry-detail" style="margin-right:8px;">もう一度</button>
        <button class="btn-plain btn-primary" id="btn-result-detail">テスト結果に戻る</button>
        <button class="btn-plain btn-primary" id="btn-menu-detail" style="margin-left:8px;">テストメニューに戻る</button>
      </div>
    </div>
  `;

  // ボタンイベント
  document.getElementById("btn-retry-detail").addEventListener("click", renderWordTestMenu);
  document.getElementById("btn-result-detail").addEventListener("click", renderTestResult);
  document.getElementById("btn-menu-detail").addEventListener("click", renderTestMenu);

  // 個別解答の描画と「マイ単語リスト」ボタン設定
  const container = document.getElementById('detail-answers');
  container.innerHTML = ''; // クリア

  userAnswers.forEach((ua, i) => {
    const item = document.createElement('div');
    item.style.border = '1px solid #ddd';
    item.style.borderRadius = '8px';
    item.style.padding = '12px';
    item.style.marginBottom = '12px';
    item.style.backgroundColor = ua.selected === ua.correct ? '#d4edda' : '#f8d7da';

    const info = document.createElement('div');
    info.innerHTML = `
      <strong>Q${i+1}: ${ua.word.en}</strong><br>
      あなたの解答: <span style="font-weight:bold;">${ua.selected || '（未回答）'}</span><br>
      正解: <span style="font-weight:bold;">${ua.correct}</span><br>
      <span style="color:${ua.selected===ua.correct?'green':'red'}; font-weight:bold;">
        ${ua.selected===ua.correct?'正解':'不正解'}
      </span>
    `;

    const btn = document.createElement('button');
    btn.className = 'btn-plain btn-secondary';
    btn.style.marginTop = '6px';

    const alreadyAdded = myWordList.some(w => w.en === ua.word.en);
    if (alreadyAdded) {
      btn.textContent = '追加済み';
      btn.style.backgroundColor = '#aaa';
      btn.disabled = true;
    } else {
      btn.textContent = 'マイ単語リストに追加';
      btn.addEventListener('click', () => {
        addToMyWordList(ua.word);
        btn.textContent = '追加済み';
        btn.style.backgroundColor = '#aaa';
        btn.disabled = true;
      });
    }

    item.appendChild(info);
    item.appendChild(btn);
    container.appendChild(item);
  });
}


// ===== マイ単語リスト =====
// === Firestore に保存 / 読み込みする関数（ユーザー別 MyWords） ===

// Firestoreへ保存
async function saveMyWordListToFirestore() {
  if (!currentUser) {
    console.warn("ログインしていないので保存しません");
    return;
  }
  try {
    const uid = currentUser.id;
    await setDoc(doc(db, "myWords", uid), {
      words: myWordList,
      updatedAt: new Date()
    });
    console.log("✅ Firestoreにマイ単語リストを保存:", myWordList.length, "語");
  } catch (e) {
    console.error("❌ Firestore保存エラー:", e);
  }
}

// Firestoreから読み込み
async function loadMyWordListFromFirestore() {
  if (!currentUser) {
    console.warn('loadMyWordListFromFirestore: not logged in');
    myWordList = [];
    return [];
  }
  try {
    const uid = currentUser.id;
    const dSnap = await getDoc(doc(db, 'myWords', uid));
    if (!dSnap.exists()) {
      console.log('ℹ️ myWordsにデータなし（初回ユーザー）');
      myWordList = [];
      return myWordList;
    }
    const data = dSnap.data();
    myWordList = Array.isArray(data.words) ? data.words : [];
    console.log('✅ Firestoreからマイ単語リストを読み込み:', myWordList);
    return myWordList;
  } catch (err) {
    console.error('❌ loadMyWordListFromFirestore error', err);
    myWordList = [];
    return myWordList;
  }
}

// ✅ マイ単語リスト画面の描画（Firestoreから最新を取得して表示）
async function renderMyWordList() {
  if (!currentUser) {
    document.getElementById('content').innerHTML = `<p style="text-align:center;">ログインしてください。</p>`;
    return;
  }

  // 🔽 Firestoreから最新データをロード
  await loadMyWordListFromFirestore();

  // 🔽 表示を生成
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:800px;margin:auto;padding:24px;">
      <h2 style="text-align:center;">マイ単語リスト</h2>
      <table style="width:100%;border-collapse:collapse;margin-top:16px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="padding:8px;border:1px solid #ccc;">英語</th>
            <th style="padding:8px;border:1px solid #ccc;">日本語</th>
            <th style="padding:8px;border:1px solid #ccc;">品詞</th>
            <th style="padding:8px;border:1px solid #ccc;">レベル</th>
            <th style="padding:8px;border:1px solid #ccc;">正答数</th>
          </tr>
        </thead>
        <tbody>
          ${myWordList.length === 0
            ? `<tr><td colspan="5" style="text-align:center;padding:12px;">まだ単語がありません</td></tr>`
            : myWordList.map(w => `
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">${w.en}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.ja}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.pos || '-'}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.level || '-'}</td>
                <td style="padding:8px;border:1px solid #ccc;color:#28a745;">${'●'.repeat(w.correctCount || 0)}</td>
              </tr>
            `).join('')}
        </tbody>
      </table>
      <div style="text-align:center;margin-top:16px;">
        <button class="btn-plain btn-primary" id="mywords-test-btn">MyWordsでテスト</button>
      </div>
    </div>
  `;

// MyWordsでテストボタンの動作
document.getElementById('mywords-test-btn').addEventListener('click', () => {
  renderWordTestMenu('mywords'); // ← モード指定して画面へ遷移
});

}


// ===== 単語リスト管理画面 =====
async function renderWordList() {
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>単語リスト管理</h2>
      
      <div style="margin-bottom:12px;">
        <label>レベル選択：</label>
        <select id="wordlist-level">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
        </select>
        <button class="btn-plain btn-primary" id="load-wordlist">読み込み</button>
      </div>

      <div id="wordlist-table-container" style="margin-top:12px;">
        <table id="wordlist-table" class="word-table">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>英語</th>
              <th>日本語</th>
              <th>品詞</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-plain btn-secondary" id="add-row" style="margin-top:10px;">＋ 行を追加</button>
      </div>

      <h3 style="margin-top:20px;">Excelから貼り付け</h3>
      <p style="font-size:0.9em;color:#555;">「英語」→「日本語」→「品詞」の順にタブ区切りで貼り付けできます。</p>
      <textarea id="paste-area" rows="5" style="width:100%;"></textarea>
      <button class="btn-plain btn-secondary" id="paste-add">貼り付け内容を追加</button>

      <div style="margin-top:20px;">
        <button class="btn-plain btn-primary" id="save-wordlist">保存</button>
        <button class="btn-plain" id="back-main">戻る</button>
      </div>
    </div>
  `;

  // 戻るボタン
  document.getElementById('back-main').addEventListener('click', renderTestMenu);

  // 「行を追加」ボタン
  document.getElementById('add-row').addEventListener('click', ()=>{
    addWordRow();
  });

  // 「読み込み」ボタン
  document.getElementById('load-wordlist').addEventListener('click', async ()=>{
    const level = document.getElementById('wordlist-level').value;
    await loadWordList(level);
  });

  // 「貼り付け追加」ボタン
  document.getElementById('paste-add').addEventListener('click', ()=>{
    const text = document.getElementById('paste-area').value.trim();
    if(!text) return;
    const rows = text.split(/\n/).map(r => r.split(/\t/));
    for(const row of rows){
      if(row.length >= 2){
        addWordRow(row[0], row[1], row[2] || '');
      }
    }
  });

  // 「保存」ボタン
  document.getElementById('save-wordlist').addEventListener('click', async ()=>{
    const level = document.getElementById('wordlist-level').value;
    await saveWordList(level);
  });
}

// ===== 行を追加する関数 =====
function addWordRow(en = '', ja = '', pos = '') {
  const table = document.getElementById('wordlist-table').querySelector('tbody');
  const index = table.children.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${index}</td>
    <td contenteditable="true">${en}</td>
    <td contenteditable="true">${ja}</td>
    <td contenteditable="true">${pos}</td>
    <td><button class="btn-plain btn-danger delete-row">削除</button></td>
  `;
  table.appendChild(tr);

  tr.querySelector('.delete-row').addEventListener('click', ()=>{
    tr.remove();
    updateWordRowNumbers();
  });
}

// ===== 行番号を更新 =====
function updateWordRowNumbers(){
  const rows = document.querySelectorAll('#wordlist-table tbody tr');
  rows.forEach((tr, i)=>{
    tr.children[0].textContent = i + 1;
  });
}

// ===== 単語リスト読み込み =====
async function loadWordList(level) {
  const tableBody = document.querySelector('#wordlist-table tbody');
  tableBody.innerHTML = '読み込み中...';
  try {
    const docRef = doc(db, 'wordLists', level);
    const snap = await getDoc(docRef);
    const data = snap.exists() ? snap.data().words || [] : [];

    // 表をクリアして再描画
    tableBody.innerHTML = '';
    for(const w of data){
      addWordRow(w.en, w.ja, w.pos);
    }
  } catch(err) {
    console.error('単語リスト読み込みエラー:', err);
    tableBody.innerHTML = '<tr><td colspan="5">読み込みに失敗しました</td></tr>';
  }
}

// ===== 単語リスト保存 =====
async function saveWordList(level) {
  try {
    const rows = Array.from(document.querySelectorAll('#wordlist-table tbody tr'));
    const words = rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        en: tds[1].textContent.trim(),
        ja: tds[2].textContent.trim(),
        pos: tds[3].textContent.trim(),
      };
    });
    const docRef = doc(db, 'wordLists', level);
    await setDoc(docRef, { words });
    alert('保存しました！');
  } catch(err) {
    console.error('単語リスト保存エラー:', err);
    alert('保存に失敗しました');
  }
}



// ===== BNP リアルタイム監視 =====
function initBnpWatcher() {
  if (!currentUser || !currentUser.id) return;

  const userRef = doc(db, "users", currentUser.id);

  // ユーザードキュメントをリアルタイム監視
  onSnapshot(userRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();
    const bnpValue = data.bnp || 0;

    // #bnp-display に反映
    const el = document.getElementById('bnp-display');
    if (el) el.textContent = `${bnpValue} bnp`;
  });
}

// ===== 呼び出すタイミング =====
// currentUser がセットされた直後に呼ぶ
if(currentUser && currentUser.id){
  initBnpWatcher();
}

// もしくはログイン処理後のコールバック内で
// loginUser().then(user => { currentUser = user; initBnpWatcher(); });

    
    // ---------- 過去の成績（テスト種別選択 + 履歴表示） ----------

function renderHistory(){
  // まず種別選択カードを表示
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>過去の成績</h2>
      <p>閲覧したいテストの種類を選んでください。</p>
      <div id="history-type-cards" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
        <div class="card" style="flex:1;min-width:180px;cursor:pointer" data-type="速読力測定テスト">速読力測定テスト</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer" data-type="文法特訓">文法特訓</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer" data-type="単語テスト">単語テスト</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer;opacity:0.6">リスニング特訓（未実装）</div>
      </div>
      <div id="history-list" style="margin-top:16px;"></div>
    </div>
  `;

  // 有効なカードだけクリックを有効化
  const cardContainer = document.getElementById('history-type-cards');
  if(!cardContainer) return;
  const cards = cardContainer.querySelectorAll('div[data-type]');
  cards.forEach(card => {
    card.addEventListener('click', () => {
      // 見た目の選択ハイライト
      cards.forEach(c=> c.style.boxShadow = 'none');
      card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
      // 読み込み
      const type = card.getAttribute('data-type');
      loadHistory(type);
    });
  });
}

// --- 回答オブジェクトを正規化するヘルパ ---
function normalizeAnswer(a){
  // a: データベースから来る元のオブジェクト（古い形式・新しい形式どちらでも）
  const selected = (a && (a.selected !== undefined ? a.selected : (a.userAnswer !== undefined ? a.userAnswer : (a.selectedValue !== undefined ? a.selectedValue : null)))) || null;
  const correctAnswers = (a && (a.correctAnswer || a.correctAnswers || a.answer || []));
  // isCorrect があれば優先、なければ correct (boolean) を使う
  let isCorrect = (a && typeof a.isCorrect === 'boolean') ? a.isCorrect : (a && typeof a.correct === 'boolean' ? a.correct : null);

  if(isCorrect === null){
    // 自動判定（selected が null => 未解答とする）
    if(selected === null || selected === undefined || selected === ''){
      isCorrect = false;
    } else {
      // selected が配列かどうかで判定を分ける
      if(Array.isArray(correctAnswers) && Array.isArray(selected)){
        // 配列同士をトリムして比較（順序まで一致）
        const eq = selected.length === correctAnswers.length &&
                   selected.every((v,i)=>String(v).trim().toLowerCase() === String(correctAnswers[i]).trim().toLowerCase());
        isCorrect = !!eq;
      } else if(Array.isArray(correctAnswers)){
        // correctAnswers のいずれかに selected が一致すれば正解
        isCorrect = correctAnswers.some(c => String(c).trim().toLowerCase() === String(selected).trim().toLowerCase());
      } else {
        isCorrect = false;
      }
    }
  }

  return {
    question: a && (a.question || a.q || '') || '',
    selected,
    correctAnswers: Array.isArray(correctAnswers) ? correctAnswers : (correctAnswers ? [correctAnswers] : []),
    isCorrect: !!isCorrect,
    score: (a && (a.score || 0)) || 0
  };
}

async function showSavedResult(docId){
  if(!docId) return;
  const content = document.getElementById('content');
  if(!content) return;
  content.innerHTML = `<div class="card"><h2>詳細を読み込み中...</h2></div>`;

  try{
    const dSnap = await getDoc(doc(db,'results',docId));
    if(!dSnap.exists()){
      content.innerHTML = `<div class="card"><h2>該当の記録が見つかりません</h2></div>`;
      return;
    }
    const d = dSnap.data();
    const created = formatDateForDisplay(d.createdAt);

    let html = `<div class="card">
      <h2>テスト結果の詳細</h2>
      <div style="margin-top:8px;">
        <p><strong>テスト種別:</strong> ${escapeHtml(d.testType || d.type || '')}</p>
        <p><strong>スコア:</strong> ${escapeHtml(String(d.score || 0))} 点</p>
        <p><strong>WPM:</strong> ${Number(d.wpm || 0).toFixed(2)}</p>
        <p><strong>経過秒数:</strong> ${escapeHtml(String(d.elapsed || 0))} 秒</p>
        <p><strong>総単語数:</strong> ${escapeHtml(String(d.totalWords != null ? d.totalWords : ''))}</p>
        <p style="color:#999;"><strong>保存日時:</strong> ${escapeHtml(created)}</p>
      </div>
      <hr style="margin:12px 0;" />
      <h3>設問ごとの解答</h3>
    `;

    const answersRaw = Array.isArray(d.answers) ? d.answers : [];
    if(answersRaw.length === 0){
      html += `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">設問ごとの記録はありません。</div>`;
    } else {
      answersRaw.forEach((a, idx) => {
        const n = normalizeAnswer(a);
        const status = n.selected === null || n.selected === undefined || n.selected === '' ? '未解答' : (n.isCorrect ? '⭕ 正解' : '❌ 不正解');
        const color = n.selected === null || n.selected === undefined || n.selected === '' ? 'gray' : (n.isCorrect ? 'green' : 'red');

        html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
          <p><strong>Q${idx+1}:</strong> ${escapeHtml(n.question || '')}</p>
          <p><strong>あなたの解答:</strong> ${escapeHtml(Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'なし'))}</p>
          <p style="color:${color}; font-weight:bold;">${status}</p>
        </div>`;
      });
    }

    html += `<div style="text-align:right; margin-top:12px;">
        <button class="btn-plain btn-primary" id="back-history-btn">一覧に戻る</button>
      </div></div>`;

    content.innerHTML = html;

    document.getElementById('back-history-btn').addEventListener('click', ()=> {
      renderHistory();
    });

  }catch(err){
    console.error('showSavedResult error', err);
    content.innerHTML = `<div class="card"><h2>読み込み中にエラーが発生しました</h2><div style="color:#c00">${escapeHtml(err.message || err)}</div></div>`;
  }
}



// ヘルパ: createdAt が Timestamp か Date か判定して表示用に文字列化
function formatDateForDisplay(createdAt){
  if(!createdAt) return '';
  // Firestore Timestamp の場合
  if(typeof createdAt.toDate === 'function') {
    return createdAt.toDate().toLocaleString();
  }
  // Date オブジェクトや ISO 文字列等
  try {
    const d = (createdAt instanceof Date) ? createdAt : new Date(createdAt);
    return isNaN(d.getTime()) ? '' : d.toLocaleString();
  } catch(e){ return ''; }
}

async function loadHistory(type){
  if(!currentUser){
    alert('ログインしてください');
    return;
  }
  const container = document.getElementById('history-list');
  if(!container) return;
  container.innerHTML = '<div style="color:#666">読み込み中...</div>';

  try{
    const q = query(
      collection(db,'results'),
      where('uid','==', currentUser.id),
      where('type','==', type),
      orderBy('createdAt','desc')
    );
    const snap = await getDocs(q);
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">該当する履歴はありません。</div>`;
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const created = formatDateForDisplay(d.createdAt);
      html += `
        <div style="padding:12px;border:1px solid #eef3f5;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(type)}</div>
            <div style="font-size:14px;color:#666;margin-top:6px;">${escapeHtml(String(d.score || 0))} 点 • WPM: ${Number(d.wpm || 0).toFixed(2)} • ${escapeHtml(String(d.elapsed || 0))} 秒</div>
            <div style="font-size:12px;color:#999;margin-top:6px;">${escapeHtml(created)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn-plain" data-id="${docSnap.id}" data-action="detail">くわしく見る</button>
            <button class="btn-plain" data-id="${docSnap.id}" data-action="download" style="display:none">ダウンロード</button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;

    // attach handlers
    container.querySelectorAll('button[data-action="detail"]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSavedResult(btn.getAttribute('data-id')));
    });

  }catch(err){
    console.error('loadHistory error', err);
    container.innerHTML = `<div style="color:#c00">履歴の読み込みに失敗しました: ${escapeHtml(err.message || err)}</div>`;
  }
}

    // ===== 問題作成（以前のひな形そのまま） =====
    function renderCreateForm(){
      document.getElementById('content').innerHTML = `
        <div class="card">
          <h2>問題作成（管理者）</h2>
          <div>
            <label>英文（Passage）</label>
            <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
          </div>
          <div id="questions-area" style="margin-top:12px;"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="add-question" class="btn-plain btn-primary">設問を追加</button>
            <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">保存</button>
          </div>
        </div>
      `;
      document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
      document.getElementById('save-part').addEventListener('click', ()=> savePartToFirestore());
      addQuestionBlock();
    }

    function addQuestionBlock(){
      const qArea = document.getElementById('questions-area');
      const div = document.createElement('div');
      div.className = 'q-block';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>設問</strong>
          <div>
            <button class="btn-plain btn-danger btn-delete-q" type="button">設問を削除</button>
          </div>
        </div>
        <input class="q-text" type="text" placeholder="設問文を入力" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
        <div class="choices-area" style="margin-top:8px;"></div>
        <div style="margin-top:6px;">
          <button class="btn-plain btn-secondary btn-add-choice" type="button">選択肢を追加</button>
        </div>
      `;
      qArea.appendChild(div);
      div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
      div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
      // add two default choices
      addChoiceRow(div); addChoiceRow(div);
    }

    function addChoiceRow(qBlock, choice=null){
      const area = qBlock.querySelector('.choices-area');
      const div = document.createElement('div');
      div.className = 'choice-row';
      div.innerHTML = `
        <input type="text" class="choice-text" placeholder="選択肢テキスト"/>
        <input type="number" class="choice-score" placeholder="スコア" value="0" />
        <select class="choice-correct">
          <option value="false">不正解</option>
          <option value="true">正解</option>
        </select>
        <button class="btn-plain btn-danger btn-del-choice" type="button">削除</button>
      `;
      area.appendChild(div);
      div.querySelector('.btn-del-choice').addEventListener('click', ()=> div.remove());
      if(choice){
        div.querySelector('.choice-text').value = choice.text || '';
        div.querySelector('.choice-score').value = (choice.score!=null) ? choice.score : 0;
        div.querySelector('.choice-correct').value = choice.correct ? 'true' : 'false';
      }
    }

    // ===== Firestore: 保存（addDoc） =====
    async function savePartToFirestore(){
      const passage = document.getElementById('part-passage').value.trim();
      if(!passage){ alert('英文を入力してください'); return; }
      const qNodes = document.querySelectorAll('.q-block');
      const questions = [];
      qNodes.forEach(q=>{
        const text = q.querySelector('.q-text').value.trim();
        const choices = [];
        q.querySelectorAll('.choice-row').forEach(c=>{
          const chText = c.querySelector('.choice-text').value.trim();
          const chScore = Number(c.querySelector('.choice-score').value || 0);
          const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
          choices.push({ text: chText, score: chScore, correct: chCorrect });
        });
        if(text) questions.push({ text, choices });
      });
      if(questions.length===0){ alert('設問を入力してください'); return; }

      try{
        await addDoc(collection(db,'parts'), {
          passage,
          questions,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        alert('保存しました！');
        renderCreateForm();
      }catch(err){
        console.error(err);
        alert('保存に失敗しました: ' + (err.message || err));
      }
    }

   

// ===== テスト実装部分（改良・置換用） =====
let testActive = false;
let testStartTime = 0;
let testRemaining = 0;
let testTimerInterval = null;
let partPool = []; // all parts from Firestore
let usedIds = [];
let totalWords = 0;
let obtainedScore = 0;
let fullScore = 0;
let answers = []; // 解答ログを保存

function disableMenus(flag){
  ['menu-userinfo','menu-test','menu-history','menu-create','menu-list','menu-audio','menu-studylog'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(flag) el.classList.add('disabled'); else el.classList.remove('disabled');
  });
}

async function startTest(){
  console.log('DEBUG: startTest called');
  const snap = await getDocs(collection(db,'parts'));
  partPool = [];
  snap.forEach(doc => partPool.push({ id: doc.id, ...doc.data() }));
  if(partPool.length === 0){ alert('まだ問題が作成されていません。'); return; }

  // init
  testActive = true;
  usedIds = [];
  totalWords = 0;
  obtainedScore = 0;
  fullScore = 0;
  answers = [];
  testStartTime = Date.now();
  testRemaining = 15 * 60; // 15 minutes

  const testTimerEl = document.getElementById('test-timer');
  if (testTimerEl) testTimerEl.classList.remove('hidden');

  updateTestTimerDisplay();
  if(testTimerInterval) clearInterval(testTimerInterval);
  testTimerInterval = setInterval(()=>{
    testRemaining--;
    updateTestTimerDisplay();
    if(testRemaining <= 0){
      // タイムアップ時は結果へ
      endTest().catch(err => console.error('endTest error on timeout', err));
    }
  }, 1000);
  disableMenus(true);
  showNextPart();
}

function updateTestTimerDisplay(){
  const mm = String(Math.floor(testRemaining / 60)).padStart(2, '0');
  const ss = String(testRemaining % 60).padStart(2, '0');
  const el = document.getElementById('test-timer');
  if (el) el.textContent = `テスト残り: ${mm}:${ss}`;
}

function pickRandomPart(){
  const remaining = partPool.filter(p => !usedIds.includes(p.id));
  if(remaining.length === 0) return null;
  const idx = Math.floor(Math.random() * remaining.length);
  return remaining[idx];
}

function showNextPart(){
  if(!testActive) return;
  const part = pickRandomPart();
  if(!part){
    // no more parts → 結果へ
    endTest().catch(err => console.error('endTest error (no more parts)', err));
    return;
  }
  usedIds.push(part.id);

  // compute word count for this part and add
  const words = (part.passage || '').trim().split(/\s+/).filter(Boolean).length;
  totalWords += words;

  // compute this part's max score
  let partMax = 0;
  (part.questions || []).forEach(q=>{
    (q.choices || []).forEach(c=>{
      if(typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'){
        partMax += Number(c.score || 0);
      }
    });
  });
  fullScore += partMax;

  // render part
  let html = `<div class="card"><h2>Part</h2><div style="white-space:pre-line;margin-bottom:12px">${escapeHtml(part.passage||'')}</div>`;
  (part.questions || []).forEach((q, qi) => {
    html += `<div class="q-block"><p>${escapeHtml(q.text||'')}</p>`;
    (q.choices || []).forEach((c, ci) => {
      const scoreAttr = Number(c.score || 0);
      const correctAttr = (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true') ? 'true' : 'false';
      // data-text は生テキスト（エスケープ済）を入れておく
      html += `<div><label><input type="radio" name="q${qi}" data-score="${scoreAttr}" data-correct="${correctAttr}" data-text="${escapeHtml(c.text||'')}"> ${escapeHtml(c.text||'')}</label></div>`;
    });
    html += `</div>`;
  });
  html += `<div style="text-align:right;margin-top:10px;"><button class="btn-plain btn-primary" id="next-part-btn">次のPartへ</button></div></div>`;
  document.getElementById('content').innerHTML = html;

  // next handler
  const nextBtn = document.getElementById('next-part-btn');
  if(!nextBtn){
    console.warn('next-part-btn が見つかりません');
    return;
  }
  nextBtn.addEventListener('click', ()=> {
    console.log('DEBUG: next-part clicked for part id', part.id);
    const qCount = (part.questions || []).length;
    for(let qi=0; qi<qCount; qi++){
      const sel = document.querySelector(`input[name="q${qi}"]:checked`);
      if(sel){
        const s = Number(sel.dataset.score || 0);
        obtainedScore += s;
        const correct = (sel.dataset.correct === "true");
        const selected = sel.dataset.text || null;

        // 正しい答えを抽出（配列）
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected,
          correct,
          score: s,
          correctAnswer: correctAnswers
        });
      } else {
        // 未解答
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected: null,
          correct: false,
          score: 0,
          correctAnswer: correctAnswers
        });
      }
    }

    // 残りのパートがあれば次へ、なければ endTest
    const remaining = partPool.filter(p => !usedIds.includes(p.id));
    if(remaining.length === 0){
      endTest().catch(err => console.error('endTest error from next handler', err));
    } else {
      showNextPart();
    }
  }, { once: true }); // 複数バインドを避けるため once:true
}

async function endTest(){
  try {
    console.log('DEBUG: endTest start');
    if(!testActive) return;
    stopTest();

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;

    // ランク判定（ご指定の閾値は「超えると」なので > を使用）
    let rank = "ノーマル";
    let rankColor = "#2c3e50";
    if(obtainedScore > 75){ rank = "プラチナ"; rankColor = "#bcd"; } // 薄い色
    else if(obtainedScore > 61){ rank = "ゴールド"; rankColor = "#ffd700"; }
    else if(obtainedScore > 50){ rank = "シルバー"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 41){ rank = "ブロンズ"; rankColor = "#cd7f32"; }

    // まず画面を表示（保存は後回し）
    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });

    // 非同期で保存（失敗しても描画は止めない）
    (async () => {
      try {
        const uid = currentUser ? currentUser.id : 'guest';
        await addDoc(collection(db,"results"),{
          uid,
          type: "速読力測定テスト", // ← 追加: テスト種別
          score: obtainedScore,
          fullScore,
          elapsed: elapsedSec,
          wpm,
          rank,
          answers,
          createdAt: new Date()
        });
        await addBnp(obtainedScore);
        console.log('results saved');
      } catch(saveErr){
        console.warn('results save failed', saveErr);
      }
    })();

    disableMenus(false);
  } catch (err) {
    console.error('endTest 内で例外:', err);
    alert('結果表示でエラーが発生しました。Console を確認してください: ' + (err && err.message ? err.message : err));
  }
}

// 結果画面のレンダリングを分離（レビューへ戻る際に endTest を再実行しないため）
function renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords }){
  // ランクに応じてトロフィーを表示
  let trophyHtml = "";
  if(rank !== "ブロンズ"){ // ブロンズ以上だけ表示
    let size = "80px";
    if(rank === "シルバー"){ size = "90px"; }
    if(rank === "ゴールド"){ size = "100px"; }
    if(rank === "プラチナ"){ size = "110px"; }

    trophyHtml = `
      <div style="font-size:${size}; color:${rankColor}; text-align:center; margin-bottom:10px;">
        <i class="fas fa-trophy trophy-anim"></i>
      </div>
    `;
  }

  document.getElementById('content').innerHTML = `
    <div class="card" style="border:3px solid ${rankColor}; text-align:center; padding:20px;">
      <h2 style="color:${rankColor}; margin:0 0 8px 0;">${escapeHtml(rank)}</h2>
      ${trophyHtml}
      <div style="font-size:2.8em; font-weight:bold; color:${rankColor}; margin:10px 0;">
        ${obtainedScore}
      </div>
      <div style="text-align:right; margin-top:10px;">
        <p style="margin:0 0 6px 0;"><strong>WPM:</strong> ${wpm.toFixed(2)}</p>
        <p style="margin:0 0 6px 0;"><strong>経過秒数:</strong> ${elapsedSec}</p>
        <p style="margin:0;"><strong>総単語数:</strong> ${totalWords}</p>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn-plain" id="review-btn">くわしく見る</button>
        <button class="btn-plain btn-primary" id="close-btn">結果画面を閉じる</button>
      </div>
    </div>
  `;

  // イベント登録
  const reviewBtn = document.getElementById('review-btn');
  if(reviewBtn) reviewBtn.addEventListener('click', showDetailedReview);
  const closeBtn = document.getElementById('close-btn');
  if(closeBtn) closeBtn.addEventListener('click', ()=> {
    // ホームに戻す（既存の renderHomeを使う）
    if(typeof renderHome === 'function') renderHome();
    else document.getElementById('content').innerHTML = `<div class="card"><h2>ホーム</h2></div>`;
  });
}

function showDetailedReview(){
  let html = `<div class="card"><h2>テスト見直し</h2>`;
  answers.forEach((a, idx) => {
  let status, color;

  if (!a.selected) {
    status = "未解答";
    color = "gray";
  } else if (a.correct) {
    status = "⭕ 正解";
    color = "green";
  } else {
    status = "❌ 不正解";
    color = "red";
  }

  html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
    <p><strong>Q${idx+1}:</strong> ${escapeHtml(a.question || '')}</p>
    <p><strong>あなたの解答:</strong> ${escapeHtml(a.selected || 'なし')}</p>
    <p style="color:${color}; font-weight:bold;">${status}</p>
  </div>`;
});



  html += `<div style="text-align:right; margin-top:12px;">
      <button class="btn-plain btn-primary" id="back-result-btn">結果画面に戻る</button>
    </div></div>`;
  document.getElementById('content').innerHTML = html;
  const backBtn = document.getElementById('back-result-btn');
  if(backBtn) backBtn.addEventListener('click', ()=> {
    // 再レンダリング（結果の数値はグローバル変数に残っている）
    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;
    let rank = "ノーマル";
    let rankColor = "#2c3e50";
    if(obtainedScore > 80){ rank = "プラチナ"; rankColor = "#bcd"; }
    else if(obtainedScore > 67){ rank = "ゴールド"; rankColor = "#ffd700"; }
    else if(obtainedScore > 52){ rank = "シルバー"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 43){ rank = "ブロンズ"; rankColor = "#cd7f32"; }

    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });
  });
}

function stopTest(){
  testActive = false;
  if(testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
  const el = document.getElementById('test-timer');
  if (el) el.classList.add('hidden');
}

// helper: escapeHtml to keep layout safe
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
// ===== テスト実装部分（改良版）ここまで =====




    // ===== 問題一覧（管理者） & 編集機能 =====
    async function loadPartsList(){
      try{
        const q = query(collection(db,'parts'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        let html = `<div class="card"><h2>問題一覧</h2>`;
        if (snap.empty) {
          html += `<div style="margin-top:12px;padding:12px;border:1px dashed #eef3f5;border-radius:8px;color:#666">保存された問題がありません。</div>`;
        } else {
          snap.forEach(documentSnap => {
            const d = documentSnap.data();
            html += `<div class="part-item">
              <div style="font-weight:700">ID: ${documentSnap.id}</div>
              <div style="color:#555;margin-top:6px">${escapeHtml((d.passage||'').slice(0,200))}${(d.passage||'').length>200?'...':''}</div>
              <div style="margin-top:8px;">設問数: ${(d.questions||[]).length}</div>
              <div class="part-actions">
                <button class="btn-plain btn-primary" data-action="edit" data-id="${documentSnap.id}">編集</button>
                <button class="btn-plain btn-danger" data-action="delete" data-id="${documentSnap.id}">削除</button>
              </div>
            </div>`;
          });
        }
        html += `</div>`;
        document.getElementById('content').innerHTML = html;

        // attach handlers
        Array.from(document.querySelectorAll('button[data-action]')).forEach(b=>{
          b.addEventListener('click', async ()=>{
            const action = b.getAttribute('data-action');
            const id = b.getAttribute('data-id');
            if(action === 'delete'){
              if(confirm('この問題を削除しますか？')){
                try {
                  await deleteDoc(doc(db,'parts',id));
                  alert('削除しました');
                  loadPartsList(); // immediate refresh
                } catch(err) {
                  console.error(err);
                  alert('削除に失敗しました: ' + (err.message || err));
                }
              }
            } else if(action === 'edit'){
              editPart(id);
            }
          });
        });
      }catch(err){
        console.error(err);
        alert('一覧取得に失敗しました');
      }
    }

    // editPart: load doc and render create-form populated, then update on save
    async function editPart(id){
      try{
        const docRef = doc(db,'parts',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('該当のPartが見つかりません');
          return;
        }
        const d = snap.data();

        // render same create form but we fill values and change save handler to update
        document.getElementById('content').innerHTML = `
          <div class="card">
            <h2>問題編集</h2>
            <div>
              <label>英文（Passage）</label>
              <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
            </div>
            <div id="questions-area" style="margin-top:12px;"></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <button id="add-question" class="btn-plain btn-primary">設問を追加</button>
              <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">変更を保存</button>
            </div>
          </div>
        `;
        document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
        // populate
        document.getElementById('part-passage').value = d.passage || '';
        const qArea = document.getElementById('questions-area');
        qArea.innerHTML = '';
        (d.questions || []).forEach(qobj=>{
          const div = document.createElement('div');
          div.className = 'q-block';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>設問</strong>
              <div>
                <button class="btn-plain btn-danger btn-delete-q" type="button">設問を削除</button>
              </div>
            </div>
            <input class="q-text" type="text" placeholder="設問文を入力" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
            <div class="choices-area" style="margin-top:8px;"></div>
            <div style="margin-top:6px;">
              <button class="btn-plain btn-secondary btn-add-choice" type="button">選択肢を追加</button>
            </div>
          `;
          qArea.appendChild(div);
          div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
          div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
          div.querySelector('.q-text').value = qobj.text || '';
          const choicesArea = div.querySelector('.choices-area');
          choicesArea.innerHTML = '';
          (qobj.choices || []).forEach(ch=>{
            addChoiceRow(div, { text: ch.text, score: ch.score, correct: ch.correct });
          });
        });

        // save (update) handler
        const saveBtn = document.getElementById('save-part');
        const handler = async ()=>{
          const passage = document.getElementById('part-passage').value.trim();
          const questions = [];
          document.querySelectorAll('.q-block').forEach(q=>{
            const text = q.querySelector('.q-text').value.trim();
            const choices = [];
            q.querySelectorAll('.choice-row').forEach(c=>{
              const chText = c.querySelector('.choice-text').value.trim();
              const chScore = Number(c.querySelector('.choice-score').value || 0);
              const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
              choices.push({ text: chText, score: chScore, correct: chCorrect });
            });
            if(text) questions.push({ text, choices });
          });
          if(questions.length===0){ alert('設問を入力してください'); return; }
          try{
            await updateDoc(docRef, { passage, questions, updatedAt: new Date() });
            alert('更新しました');
            loadPartsList(); // immediate reflect in list
          }catch(err){
            console.error(err);
            alert('更新に失敗しました: ' + (err.message||err));
          } finally {
            saveBtn.removeEventListener('click', handler);
          }
        };
        saveBtn.addEventListener('click', handler);

      }catch(err){
        console.error(err);
        alert('編集ロードに失敗しました');
      }
    }

/* ================= 文法特訓（管理者作成 + 学習者向け 50 問特訓） ================= */

// === 文法特訓用タイマー（グローバル） ===
let grammarTimerInterval = null;
let grammarRemaining = 0;

// タイマー表示更新（#test-timer を使う）
function updateGrammarTimer(){
  const el = document.getElementById('test-timer');
  if(!el) return;
  const mm = String(Math.floor(grammarRemaining / 60)).padStart(2,'0');
  const ss = String(grammarRemaining % 60).padStart(2,'0');
  el.textContent = `文法残り: ${mm}:${ss}`;
}

// ----- バナポ操作ヘルパー -----
// users/<userid>.banapo に加算するシンプル実装
async function addBanapo(amount){
  if(!currentUser || !currentUser.id) return;
  amount = Number(amount || 0);
  if(amount <= 0) return;
  try{
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    if(snap.exists()){
      const d = snap.data();
      const cur = Number(d.banapo || 0) || 0;
      await updateDoc(uRef, { banapo: cur + amount });
    } else {
      // ユーザードキュメントがなければ作る（mergeで他項目を壊さない）
      await setDoc(uRef, { username: currentUser.id, banapo: amount }, { merge: true });
    }
    // ヘッダー表示があれば更新
    if(typeof refreshHeaderBanapoDisplay === 'function') {
      try { refreshHeaderBanapoDisplay(); } catch(e){ /* ignore */ }
    } else {
      // 互換性のため、いくつかのIDを試して更新
      const el = document.getElementById('banapo-amount') || document.getElementById('banapo-display') || document.getElementById('banapo-val') || document.getElementById('banapo-number');
      if(el){
        // 非同期に最新値を取りに行く
        const snap2 = await getDoc(uRef);
        const newVal = snap2.exists() ? Number(snap2.data().banapo || 0) : 0;
        el.textContent = `${newVal} bnp`;
      }
    }
  }catch(err){
    console.warn('addBanapo error', err);
  }
}

// ----- 管理用画面（そのまま） -----
async function renderGrammarAdminHome(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>文法問題作成（管理者）</h2>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-add-card">
          <h3>追加作成</h3>
          <p>新しい文法問題を追加します</p>
        </div>
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-edit-card">
          <h3>編集 / 削除</h3>
          <p>既存問題を一覧・編集・削除します</p>
        </div>
      </div>
    </div>
  `;
  document.getElementById('grammar-add-card').addEventListener('click', renderGrammarAddForm);
  document.getElementById('grammar-edit-card').addEventListener('click', renderGrammarEditList);
}

function sanitizeCsvToArray(s){
  if(!s) return [];
  return s.split(',').map(x=>x.trim()).filter(Boolean);
}

function renderGrammarAddForm(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>文法問題を追加</h2>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label>形式:
          <select id="g-type">
            <option value="multiple">択一 (multiple)</option>
            <option value="reorder">並べ替え (reorder)</option>
            <option value="fill">適語補充 (fill)</option>
            <option value="translate">和文英訳 (translate)</option>
          </select>
        </label>
        <label>設問文:<br>
  <textarea id="g-question" rows="4" style="width:100%; padding:8px; resize:vertical;"></textarea>
</label>
        <label id="label-choices">選択肢 / 単語 (カンマ区切り):<br><textarea id="g-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
        <label>正解 (並び・単語はカンマ区切りで):<br><input type="text" id="g-answer" style="width:100%; padding:8px;" /></label>
        <label>スコア:<br><input type="number" id="g-score" value="1" style="width:120px; padding:6px;" /></label>
        <div style="display:flex;gap:8px;">
          <button id="g-save" class="btn-plain btn-primary">保存</button>
          <button id="g-cancel" class="btn-plain">キャンセル</button>
        </div>
        <div style="font-size:12px;color:#666">
          ※「並べ替え」は choices にカードの語を、answer に正しい順をカンマ区切りで入れてください。<br>
          ※「適語補充」「和文英訳」は answer に正答文字列（複数可）をカンマ区切りで入力。
        </div>
      </div>
    </div>
  `;

  // 保存
  document.getElementById('g-save').addEventListener('click', async ()=>{
    const type = document.getElementById('g-type').value;
    const question = (document.getElementById('g-question')||{value:''}).value.trim();
    const choices = sanitizeCsvToArray((document.getElementById('g-choices')||{value:''}).value);
    const answer = sanitizeCsvToArray((document.getElementById('g-answer')||{value:''}).value);
    const score = Number((document.getElementById('g-score')||{value:1}).value) || 1;
    if(!question){ alert('設問を入力してください'); return; }
    try{
      await addDoc(collection(db,'grammarQuestions'), {
        type, question, choices, answer, score, createdBy: currentUser ? currentUser.id : 'unknown', createdAt: new Date()
      });
      alert('保存しました');
      renderGrammarAdminHome();
    }catch(err){
      console.error('grammar save err', err);
      alert('保存に失敗しました: ' + (err.message || err));
    }
  });

  document.getElementById('g-cancel').addEventListener('click', ()=> renderGrammarAdminHome());
}

// 既存の renderGrammarEditList をこの関数で丸ごと置き換えてください
async function renderGrammarEditList(){
  try{
    const container = document.getElementById('content');
    if(!container) return;

    // UI（検索ボックス＋一覧領域）
    container.innerHTML = `
      <div class="card">
        <h2>文法問題 一覧（編集）</h2>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <input type="text" id="grammar-search-input" placeholder="キーワードで検索（設問・形式・選択肢を部分一致）..." style="flex:1;padding:8px;">
          <button id="grammar-search-clear" class="btn-plain" style="white-space:nowrap;">クリア</button>
        </div>

        <div id="grammar-meta" style="margin-top:8px;color:#666;font-size:13px;"></div>
        <div id="grammar-list" style="margin-top:12px;"></div>
      </div>
    `;

    const listEl = document.getElementById('grammar-list');
    const metaEl = document.getElementById('grammar-meta');
    const inputEl = document.getElementById('grammar-search-input');
    const clearBtn = document.getElementById('grammar-search-clear');

    // Firestore から全件取得（管理者が扱う想定なので一度に取得してクライアント側で絞る）
    const qRef = query(collection(db,'grammarQuestions'), orderBy('createdAt','desc'));
    const snap = await getDocs(qRef);
    const allQuestions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    // 空チェック
    if(allQuestions.length === 0){
      listEl.innerHTML = `<div style="padding:12px;color:#666">問題がありません。</div>`;
      metaEl.textContent = `合計: 0 問`;
      return;
    }

    // 描画関数（配列を受け取って一覧を描画）
    function renderList(arr){
      if(!arr || arr.length === 0){
        listEl.innerHTML = `<div style="padding:12px;color:#666">該当する問題はありません。</div>`;
        metaEl.textContent = `表示: 0 / 合計: ${allQuestions.length} 問`;
        return;
      }

      metaEl.textContent = `表示: ${arr.length} / 合計: ${allQuestions.length} 問`;
      listEl.innerHTML = arr.map(item => {
        const d = item || {};
        return `
          <div style="border:1px solid #eef3f5;padding:8px;margin-top:8px;border-radius:6px;">
            <div><strong>${escapeHtml(d.type||'')}</strong> — ${escapeHtml((d.question||'').slice(0,200))}</div>
            <div style="margin-top:6px;font-size:13px;color:#666">
              スコア: ${escapeHtml(String(d.score || ''))} • 作成者: ${escapeHtml(d.createdBy || '')}
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn-plain btn-primary" data-action="edit" data-id="${d.id}">編集</button>
              <button class="btn-plain btn-danger" data-action="delete" data-id="${d.id}">削除</button>
            </div>
          </div>
        `;
      }).join('');

      // イベントを付与（描画の度に再登録）
      Array.from(listEl.querySelectorAll('button[data-action]')).forEach(btn=>{
        btn.addEventListener('click', async () => {
          const action = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');
          if(action === 'delete'){
            if(!confirm('削除してよいですか？')) return;
            try{
              await deleteDoc(doc(db,'grammarQuestions',id));
              alert('削除しました');
              // ローカル配列から削除して再描画
              const idx = allQuestions.findIndex(x => x.id === id);
              if(idx !== -1) allQuestions.splice(idx, 1);
              renderList(allQuestions);
            }catch(err){
              console.error(err);
              alert('削除に失敗しました');
            }
          } else if(action === 'edit'){
            // 既存の編集フォーム開く関数を再利用
            openGrammarEditForm(id);
          }
        });
      });
    }

    // 最初は全件表示
    renderList(allQuestions);

    // 検索（デバウンス付きで部分一致。設問・形式・選択肢を検索対象）
    let timeoutId = null;
    inputEl.addEventListener('input', (ev) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        const kw = (ev.target.value || '').trim().toLowerCase();
        if(kw === ''){
          renderList(allQuestions);
          return;
        }
        const filtered = allQuestions.filter(item => {
          const q = String(item.question || '').toLowerCase();
          if(q.includes(kw)) return true;
          const t = String(item.type || '').toLowerCase();
          if(t.includes(kw)) return true;
          if(Array.isArray(item.choices) && item.choices.join(' ').toLowerCase().includes(kw)) return true;
          // 追加: 作成者やスコアなどを検索対象にしたければここに足せます
          return false;
        });
        renderList(filtered);
      }, 180); // 180ms デバウンス
    });

    // クリアボタン
    clearBtn.addEventListener('click', () => {
      inputEl.value = '';
      renderList(allQuestions);
      inputEl.focus();
    });

  }catch(err){
    console.error('renderGrammarEditList err', err);
    alert('一覧取得に失敗しました');
  }
}


async function openGrammarEditForm(id){
  try{
    const docRef = doc(db,'grammarQuestions',id);
    const snap = await getDoc(docRef);
    if(!snap.exists()){ alert('該当が見つかりません'); return; }
    const d = snap.data();
    document.getElementById('content').innerHTML = `
      <div class="card">
        <h2>編集: ${escapeHtml(d.question||'')}</h2>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label>形式:
            <select id="eg-type">
              <option value="multiple">multiple</option>
              <option value="reorder">reorder</option>
              <option value="fill">fill</option>
              <option value="translate">translate</option>
            </select>
          </label>
          <label>設問文:<br>
  <textarea id="eg-question" rows="4" style="width:100%;padding:8px; resize:vertical;"></textarea>
</label>
          <label>選択肢 / 単語 (カンマ区切り):<textarea id="eg-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
          <label>正解 (カンマ区切り):<input id="eg-answer" style="width:100%;padding:8px;" /></label>
          <label>スコア:<input id="eg-score" type="number" style="width:120px;padding:6px;" /></label>
          <div style="display:flex;gap:8px;">
            <button id="eg-save" class="btn-plain btn-primary">保存</button>
            <button id="eg-cancel" class="btn-plain">キャンセル</button>
          </div>
        </div>
      </div>
    `;
    // populate
    document.getElementById('eg-type').value = d.type || 'multiple';
    document.getElementById('eg-question').value = d.question || '';
    document.getElementById('eg-choices').value = (d.choices||[]).join(', ');
    document.getElementById('eg-answer').value = (d.answer||[]).join(', ');
    document.getElementById('eg-score').value = d.score || 1;

    document.getElementById('eg-save').addEventListener('click', async ()=>{
      const type = document.getElementById('eg-type').value;
      const question = document.getElementById('eg-question').value.trim();
      const choices = sanitizeCsvToArray(document.getElementById('eg-choices').value);
      const answer = sanitizeCsvToArray(document.getElementById('eg-answer').value);
      const score = Number(document.getElementById('eg-score').value) || 1;
      if(!question){ alert('設問を入力してください'); return; }
      try{
        await updateDoc(docRef, { type, question, choices, answer, score, updatedAt: new Date() });
        alert('更新しました');
        renderGrammarEditList();
      }catch(err){ console.error(err); alert('更新に失敗しました'); }
    });
    document.getElementById('eg-cancel').addEventListener('click', renderGrammarEditList);

  }catch(err){
    console.error(err);
    alert('編集ロードに失敗しました');
  }
}

/* ===== 学習者向け: 文法特訓（50問ランダム・重複なし） ===== */
async function startGrammarTraining(){
  try{
    const snap = await getDocs(collection(db,'grammarQuestions'));
    let questions = [];
    snap.forEach(s => questions.push({ id: s.id, ...s.data() }));
    if(questions.length === 0){ alert('文法問題がまだ登録されていません。'); return; }

    // シャッフル
    questions = questions.sort(()=>Math.random()-0.5).slice(0,50);

    // 状態
    let idx = 0;
    let score = 0;
    const answersRecord = [];
    const startTime = Date.now();

    // UI: show timer in header
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.remove('hidden');

    // disable menus while training
    disableMenus(true);

    // --- タイマー初期化（5分 = 300秒） ---
    grammarRemaining = 5 * 60;
    updateGrammarTimer();
    if(grammarTimerInterval) { clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    grammarTimerInterval = setInterval(()=> {
      grammarRemaining--;
      updateGrammarTimer();
      if(grammarRemaining <= 0){
        // タイムアップ: 強制終了
        // move index to end and renderQ once (renderQ will handle save & cleanup)
        idx = questions.length;
        try { renderQ(); } catch(e){ /* ignore */ }
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
      }
    }, 1000);

    // render 関数
    async function renderQ(){
      // 終了分岐
      if(idx >= questions.length){
        // clear timer & hide
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
        if(testTimerEl) testTimerEl.classList.add('hidden');
        // allow menus again
        disableMenus(false);

        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        // 保存（結果を DB に追加し、バナポを加算）
        await saveGrammarResult(score, elapsed, answersRecord);
        // 表示
        renderGrammarResult(score, elapsed, answersRecord);
        return;
      }

      const q = questions[idx];
      let html = `
        <div class="card">
          <h2>Q${idx+1}/${questions.length}</h2>
          <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(q.question||'')}</div>
          <div style="margin-top:12px;" id="g-body"></div>
          <div style="margin-top:12px;text-align:right;">
            <button class="btn-plain" id="g-skip">スキップ</button>
            <button class="btn-plain btn-primary" id="g-submit">回答</button>
          </div>
        </div>
      `;
      document.getElementById('content').innerHTML = html;

      const body = document.getElementById('g-body');

      if(q.type === 'multiple'){
        // ラジオで表示
        (q.choices || []).forEach((c, i)=>{
          const div = document.createElement('div');
          div.innerHTML = `<label><input type="radio" name="g-choice" value="${escapeHtml(c)}" data-correct="${(q.answer||[]).includes(c) ? 'true' : 'false'}" data-score="${q.score||1}"> ${escapeHtml(c)}</label>`;
          body.appendChild(div);
        });
      } else if(q.type === 'reorder'){
        // ----- 並べ替え UI: 語群（可選） と 解答欄（黒枠） を分けて表示 -----
        const avail = document.createElement('div');
        avail.id = 'g-avail';
        avail.style.display = 'flex';
        avail.style.flexWrap = 'wrap';
        avail.style.gap = '6px';
        avail.style.marginBottom = '8px';

        (q.choices || []).forEach((w,i)=>{
          const b = document.createElement('button');
          b.className = 'btn-plain';
          b.type = 'button';
          b.textContent = w;
          b.dataset.word = w;
          b.style.cursor = 'pointer';
          b.addEventListener('click', ()=> {
            const picked = document.getElementById('g-picked');
            const newb = document.createElement('button');
            newb.className = 'btn-plain';
            newb.type = 'button';
            newb.textContent = w;
            newb.dataset.word = w;
            newb.style.cursor = 'pointer';
            newb.addEventListener('click', ()=> {
              const availEl = document.getElementById('g-avail');
              if(availEl) availEl.appendChild(b);
              const pickedEl = document.getElementById('g-picked');
              if(pickedEl) pickedEl.removeChild(newb);
            });
            const pickedEl = document.getElementById('g-picked');
            if(pickedEl) pickedEl.appendChild(newb);
            if(b.parentElement) b.parentElement.removeChild(b);
          });
          avail.appendChild(b);
        });

        const picked = document.createElement('div');
        picked.id = 'g-picked';
        picked.style.minHeight = '40px';
        picked.style.display = 'flex';
        picked.style.flexWrap = 'wrap';
        picked.style.gap = '6px';
        picked.style.border = '2px solid #000';
        picked.style.padding = '8px';
        picked.style.marginTop = '8px';
        picked.style.background = '#fff';

        const resetWrap = document.createElement('div');
        resetWrap.style.marginTop = '8px';
        resetWrap.innerHTML = `<button class="btn-plain" id="g-reset">リセット</button>`;

        body.appendChild(document.createElement('div'));
        body.appendChild(avail);
        body.appendChild(resetWrap);
        body.appendChild(picked);

        document.getElementById('g-reset').addEventListener('click', ()=> {
          const pickedEl = document.getElementById('g-picked');
          const availEl = document.getElementById('g-avail');
          if(!pickedEl || !availEl) return;
          while(pickedEl.firstChild){
            const nb = pickedEl.firstChild;
            const w = nb.dataset.word;
            const ob = document.createElement('button');
            ob.className = 'btn-plain';
            ob.type = 'button';
            ob.textContent = w;
            ob.dataset.word = w;
            ob.style.cursor = 'pointer';
            ob.addEventListener('click', ()=> {
              const newb = document.createElement('button');
              newb.className = 'btn-plain';
              newb.type = 'button';
              newb.textContent = w;
              newb.dataset.word = w;
              newb.style.cursor = 'pointer';
              newb.addEventListener('click', ()=> {
                pickedEl.removeChild(newb);
                availEl.appendChild(ob);
              });
              pickedEl.appendChild(newb);
              availEl.removeChild(ob);
            });
            availEl.appendChild(ob);
            pickedEl.removeChild(nb);
          }
        });

      } else if(q.type === 'fill'){
        body.innerHTML = `<input type="text" id="g-fill" style="width:100%;padding:8px;" placeholder="単語を入力" />`;
      } else if(q.type === 'translate'){
        body.innerHTML = `<textarea id="g-translate" style="width:100%;padding:8px;" rows="4" placeholder="英文を入力"></textarea>`;
      }

      // スキップ
      document.getElementById('g-skip').addEventListener('click', ()=> {
        answersRecord.push({
  question: q.question,
  selected: null,        // 統一キー名
  isCorrect: false,      // 未解答は false
  score: 0,
  correctAnswer: q.answer || []
});
        idx++;
        renderQ();
      });

      // 提出
      document.getElementById('g-submit').addEventListener('click', ()=> {
        let userAns = null;
        let correct = false;
        let addScore = 0;
        if(q.type === 'multiple'){
          const sel = document.querySelector('input[name="g-choice"]:checked');
          if(sel){
            userAns = sel.value;
            correct = (sel.dataset.correct === 'true');
            addScore = correct ? Number(sel.dataset.score||q.score||1) : 0;
          } else {
            userAns = null;
            correct = false;
            addScore = 0;
          }
        } else if(q.type === 'reorder'){
          const pickedEl = document.getElementById('g-picked');
          const arr = Array.from(pickedEl.children).map(b => b.dataset.word);
          userAns = arr;
          const target = q.answer || [];
          const eq = (a,b) => a.length===b.length && a.every((v,i)=>String(v).trim() === String(b[i]).trim());
          correct = eq(arr, target);
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'fill'){
          const v = (document.getElementById('g-fill')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'translate'){
          const v = (document.getElementById('g-translate')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        }

        answersRecord.push({
  question: q.question,
  selected: userAns,          // 選んだ値（文字列 or 配列）
  isCorrect: !!correct,       // 真偽を明示
  score: addScore,
  correctAnswer: q.answer || []
});
        score += addScore;

        // （重要）ここでは個別にバナポ加算しない。終了時に合計で加算する。
        idx++;
        renderQ();
      });

    } // renderQ 関数 end

    // 最初を表示
    renderQ();

  }catch(err){
    console.error('startGrammarTraining err', err);
    alert('文法特訓の開始に失敗しました: ' + (err && err.message ? err.message : err));
    // 安全処理
    if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.add('hidden');
    disableMenus(false);
  }
}

// 保存（結果を DB に追加し、バナポを加算）
// 既存の saveGrammarResult と置き換えてください
async function saveGrammarResult(score, elapsedSec, answersRecord){
  try{
    const uid = currentUser ? currentUser.id : 'guest';
    // results ドキュメントに、互換性のために testType と type の両方を入れておく
    await addDoc(collection(db,'results'), {
      uid,
      type: '文法特訓',
      testType: 'grammar',
      score,
      elapsed: elapsedSec,
      answers: answersRecord,
      createdAt: new Date()
    });
    // 終了時に一度だけバナポを加算（スコアをそのまま加算）
    try { 
      if(typeof addBnp === 'function') {
        await addBnp(score);
      }
    } catch(e){ console.warn('addBnp at end failed', e); }
  }catch(err){
    console.warn('saveGrammarResult failed', err);
  }
}

// 結果表示
function renderGrammarResult(score, elapsedSec, answersRecord){
  // 結果画面を描画
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>文法特訓 結果</h2>
      <p>獲得スコア: ${score}</p>
      <p>経過秒数: ${elapsedSec} 秒</p>
      <div style="text-align:right;margin-top:12px;">
        <button id="g-to-home" class="btn-plain">ホームに戻る</button>
        <button id="g-review" class="btn-plain btn-primary">詳細を見る</button>
      </div>
    </div>
  `;

  // ホームへ戻る
  const toHomeBtn = document.getElementById('g-to-home');
  if(toHomeBtn){
    toHomeBtn.addEventListener('click', ()=> {
      if(typeof renderHome === 'function') renderHome();
      else document.getElementById('content').innerHTML = `<div class="card"><h2>ホーム</h2></div>`;
    });
  }

  // 「詳細を見る」
  const reviewBtn = document.getElementById('g-review');
  if(reviewBtn){
    reviewBtn.addEventListener('click', async ()=> {
      try {
        // 最新の自分の結果を取得
        const qSnap = await getDocs(query(collection(db,'results'), orderBy('createdAt','desc')));
        let found = null;
        qSnap.forEach(docSnap=>{
          if(found) return;
          const d = docSnap.data();
          if(d.uid !== (currentUser ? currentUser.id : 'guest')) return;
          if((d.testType && d.testType === 'grammar') || (d.type && d.type === '文法特訓')){
            found = { id: docSnap.id, data: d };
          }
        });

        if(!found){ alert('詳細が見つかりません'); return; }

        // answers を正規化して表示
        const arr = Array.isArray(found.data.answers) ? found.data.answers : [];

        function _normalizeAnswer(a){
          if(!a) return { question:'', selected:null, isCorrect:false, score:0, correctAnswer:[] };
          const question = a.question || a.q || '';
          const selected = ('selected' in a) ? a.selected
                        : ('userAnswer' in a) ? a.userAnswer
                        : ('selectedAnswer' in a) ? a.selectedAnswer
                        : null;
          const isCorrect = ('isCorrect' in a) ? !!a.isCorrect
                         : ('correct' in a) ? !!a.correct
                         : false;
          const correctAnswer = a.correctAnswer || a.correctAnswers || a.answer || a.correct || [];
          return {
            question,
            selected,
            isCorrect,
            score: a.score || 0,
            correctAnswer: Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)]
          };
        }

        let html = `<div class="card"><h2>文法特訓：詳細</h2>`;
        arr.forEach((raw,i)=>{
          const n = _normalizeAnswer(raw);
          const isUnanswered = (
            n.selected === null ||
            n.selected === undefined ||
            (typeof n.selected === 'string' && n.selected.trim() === '') ||
            (Array.isArray(n.selected) && n.selected.length === 0)
          );
          let statusText, color;
          if(isUnanswered){
            statusText = '未解答';
            color = 'gray';
          } else if(n.isCorrect){
            statusText = '⭕ 正解';
            color = 'green';
          } else {
            statusText = '❌ 不正解';
            color = 'red';
          }

          const yourAnsDisplay = Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'なし');
          const correctAnsDisplay = (n.correctAnswer || []).map(x => escapeHtml(String(x))).join(' / ');

          html += `<div style="margin:6px 0;padding:8px;border-left:4px solid ${color};">
            <p><strong>Q${i+1}:</strong> ${escapeHtml(n.question||'')}</p>
            <p>あなたの解答: ${escapeHtml(yourAnsDisplay)}</p>
            <p style="color:${color};font-weight:bold">${statusText}</p>
          </div>`;
        });
        html += `<div style="text-align:right;margin-top:12px;">
          <button id="back-to-results" class="btn-plain btn-primary">結果へ戻る</button>
        </div></div>`;

        // 詳細画面を描画
        document.getElementById('content').innerHTML = html;

        // 戻るボタン
        const backBtn = document.getElementById('back-to-results');
        if(backBtn){
          backBtn.addEventListener('click', ()=> {
            renderGrammarResult(found.data.score, found.data.elapsed, found.data.answers || []);
          });
        }

      } catch(err){
        console.error('g review err', err);
        alert('詳細の取得に失敗しました: ' + (err && err.message ? err.message : err));
      }
    });
  }
}


/* ================= end: 文法特訓 ================= */





    // ===== 初表示はログイン画面（何も変更しない） =====
    // end of module

    // ★★ ここから追加: 「start-speed」ボタンを確実に拾うハンドラ（最小追加部分） ★★
    document.addEventListener('click', async (e) => {
      try {
        if (e.target && e.target.id === 'start-speed') {
          console.log('[debug] start-speed clicked');
          if (confirm('テストを開始します。制限時間は15分です。')) {
            if (typeof startTest === 'function') {
              await startTest();
            } else {
              console.error('startTest is not defined');
              alert('内部エラー: startTestが定義されていません。コンソールを確認してください。');
            }
          }
        }
      } catch (err) {
        console.error('start-speed handler error', err);
        alert('テスト開始処理でエラーが発生しました: ' + (err && err.message ? err.message : err));
      }
    });
    // ★★ 追加ここまで ★★

    /* ============== ここから新規追加: ホーム画面とお知らせ機能 ============== */
    /* 追加ポリシー:
       - ひな形A1 の既存コードは一切変更していません（上書き、削除なし）。
       - 以下は「追加実装」のみで、ログイン直後にホームを表示するために既存の showMain() の動作をラップしています。
       - Firestore に notices コレクションを使います。ドキュメント構造:
         { title, body, createdBy, createdAt }
    */

    // ラップして元の showMain を拡張: ログイン直後にホームを表示する
    if (typeof showMain === 'function') {
      const __orig_showMain = showMain;
      showMain = function(...args){
        __orig_showMain.apply(this, args);
        // 表示が切り替わった直後にホームを表示
        renderHome();
      };
    }

    // ロゴクリックでホームへ戻る
    const logoEl = document.querySelector('.logo');
    if (logoEl) {
      logoEl.style.cursor = 'pointer';
      logoEl.addEventListener('click', (e) => {
        e.preventDefault();
        renderHome();
      });
    }

// ホーム画面描画
function renderHome() {
  const today = new Date();
  const privateExamDate = new Date('2026-02-10');
  const publicExamDate = new Date('2026-03-11');

  const privateDiff = Math.ceil((privateExamDate - today) / (1000 * 60 * 60 * 24));
  const publicDiff = Math.ceil((publicExamDate - today) / (1000 * 60 * 60 * 24));

  document.getElementById('content').innerHTML = `
    <div class="home-layout">
      <div class="card home-card">
        <h2>ようこそ、${currentUser ? escapeHtml(currentUser.nickname || currentUser.id) : 'ゲスト'} さん。</h2>
        <p></p>

      </div>

      <div class="exam-side">
        <div class="exam-card private-exam">
          <h3>私立入試まで</h3>
          <div class="exam-days">${privateDiff}日</div>
          <div class="exam-date">（2026年2月10日 火）</div>
        </div>

        <div class="exam-card public-exam">
          <h3>公立入試まで</h3>
          <div class="exam-days">${publicDiff}日</div>
          <div class="exam-date">（2026年3月11日 水）</div>
        </div>
      </div>
    </div>

    <div class="card" id="notices-card">
      <h3>おしらせ</h3>
      <div id="notices-list" style="margin-top:12px;"></div>
      <div id="notice-admin-controls" style="margin-top:12px;"></div>
    </div>
  `;

  // スタイル
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    /* レイアウト */
    .home-layout {
      display: flex;
      flex-wrap: wrap;
      align-items: stretch;
      gap: 20px;
      justify-content: center;
      margin: 20px auto 32px;
      max-width: 1200px;
    }

    .home-card {
      flex: 1 1 320px;
      background: linear-gradient(135deg, #ffffff, #fafafa);
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .home-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .exam-side {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1 1 300px;
    }

    /* カードデザイン */
    .exam-card {
      background: #ffffff;
      border-radius: 14px;
      text-align: center;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.07);
      border: 1px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .exam-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

    .exam-card h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .exam-days {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .exam-date {
      font-size: 14px;
      color: #666;
    }

    /* 色テーマ */
    .private-exam {
      background: linear-gradient(135deg, #ffeef3, #fff7fa);
      border-color: #f8b6c7;
      color: #c62f63;
    }

.maple-img {
  position: absolute;
  bottom: 12px;
  right: 12px;
  width: 90px;
  height: auto;
  opacity: 0.95;
  pointer-events: none; /* クリックをブロックしないように */
}

/* .home-card に position: relative を追加して基準にする */
.home-card {
  position: relative;
}


    .public-exam {
      background: linear-gradient(135deg, #edf6ff, #f6fbff);
      border-color: #9ac8f5;
      color: #3178c6;
    }
  `;
  document.head.appendChild(styleTag);

  // お知らせ表示
  loadNotices();
  renderNoticeAdminControlsIfAllowed();
}



// 管理者なら投稿UIを表示
function renderNoticeAdminControlsIfAllowed() {
  const ctrl = document.getElementById('notice-admin-controls');
  if (!ctrl) return;
  ctrl.innerHTML = '';

  if (currentUser && currentUser.role === 'admin') {
    ctrl.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="new-notice-title" placeholder="タイトル" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%" />
        <textarea id="new-notice-body" placeholder="本文" rows="4" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%"></textarea>
        <div style="display:flex;gap:8px">
          <button id="btn-create-notice" class="btn-plain btn-primary">投稿</button>
          <button id="btn-refresh-notice" class="btn-plain">更新</button>
        </div>
      </div>
    `;
    document.getElementById('btn-create-notice').addEventListener('click', createNotice);
    document.getElementById('btn-refresh-notice').addEventListener('click', loadNotices);
  }
}


// お知らせを読み込んで表示
async function loadNotices() {
  try {
    const q = query(collection(db, 'notices'), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    const listEl = document.getElementById('notices-list');
    if (!listEl) return;

    if (snap.empty) {
      listEl.innerHTML = `
        <div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">
          現在お知らせはありません。
        </div>`;
      return;
    }

    let html = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
      const dateStr = createdAt ? createdAt.toLocaleString() : '';
      html += `
        <div style="padding:12px;border-bottom:1px solid #f0f4f6;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(d.title || '（無題）')}</div>
            <div style="font-size:12px;color:#666">
              ${escapeHtml(d.createdBy || '')}${dateStr ? ' • ' + escapeHtml(dateStr) : ''}
            </div>
          </div>
          <div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(d.body || '')}</div>
          <div style="margin-top:8px;" data-notice-id="${docSnap.id}"></div>
        </div>
      `;
    });

    listEl.innerHTML = html;

    // 管理者なら編集・削除ボタンを表示
    if (currentUser && currentUser.role === 'admin') {
      const noticeWrappers = listEl.querySelectorAll('div[data-notice-id]');
      noticeWrappers.forEach(wrapper => {
        const id = wrapper.getAttribute('data-notice-id');
        wrapper.innerHTML = `
          <div style="display:flex;gap:8px">
            <button class="btn-plain" data-notice-action="edit" data-id="${id}">編集</button>
            <button class="btn-plain btn-danger" data-notice-action="delete" data-id="${id}">削除</button>
          </div>
        `;
      });

      // イベント割り当て
      Array.from(listEl.querySelectorAll('button[data-notice-action]')).forEach(b => {
        b.addEventListener('click', async () => {
          const action = b.getAttribute('data-notice-action');
          const id = b.getAttribute('data-id');
          if (action === 'delete') {
            if (confirm('お知らせを削除しますか？')) {
              try {
                await deleteDoc(doc(db, 'notices', id));
                alert('削除しました');
                loadNotices();
              } catch (err) {
                console.error(err);
                alert('削除に失敗しました: ' + (err.message || err));
              }
            }
          } else if (action === 'edit') {
            openEditNoticeDialog(id);
          }
        });
      });
    }

  } catch (err) {
    console.error(err);
    alert('お知らせの取得に失敗しました: ' + (err.message || err));
  }
}


    // お知らせ作成
    async function createNotice(){
      const title = (document.getElementById('new-notice-title') || {value:''}).value.trim();
      const body = (document.getElementById('new-notice-body') || {value:''}).value.trim();
      if(!title && !body){ alert('タイトルまたは本文を入力してください'); return; }
      try{
        await addDoc(collection(db,'notices'), {
          title,
          body,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        // clear inputs
        document.getElementById('new-notice-title').value = '';
        document.getElementById('new-notice-body').value = '';
        // 即時反映
        loadNotices();
        alert('投稿しました');
      }catch(err){
        console.error(err);
        alert('投稿に失敗しました: ' + (err.message || err));
      }
    }

    // 編集ダイアログ（簡易）を出し、更新する
    async function openEditNoticeDialog(id){
      try{
        const docRef = doc(db,'notices',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('該当のお知らせが見つかりません');
          return;
        }
        const d = snap.data();
        // 簡易モーダル表示（DOM上に生成）
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.left = '0';
        overlay.style.top = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = `
          <div style="background:#fff;padding:16px;border-radius:8px;max-width:720px;width:90%;">
            <h3>お知らせ編集</h3>
            <input id="edit-notice-title" style="width:100%;padding:8px;border:1px solid #d0d7dc;border-radius:6px" value="${escapeHtml(d.title||'')}" />
            <textarea id="edit-notice-body" rows="6" style="width:100%;margin-top:8px;padding:8px;border:1px solid #d0d7dc;border-radius:6px">${escapeHtml(d.body||'')}</textarea>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
              <button id="cancel-edit" class="btn-plain">キャンセル</button>
              <button id="save-edit" class="btn-plain btn-primary">保存</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('#cancel-edit').addEventListener('click', ()=> overlay.remove());
        overlay.querySelector('#save-edit').addEventListener('click', async ()=>{
          const newTitle = (overlay.querySelector('#edit-notice-title')||{value:''}).value.trim();
          const newBody = (overlay.querySelector('#edit-notice-body')||{value:''}).value.trim();
          try{
            await updateDoc(docRef, { title: newTitle, body: newBody, updatedAt: new Date() });
            alert('更新しました');
            overlay.remove();
            loadNotices(); // 即時反映
          }catch(err){
            console.error(err);
            alert('更新に失敗しました: ' + (err.message || err));
          }
        });
      }catch(err){
        console.error(err);
        alert('編集ロードに失敗しました: ' + (err.message || err));
      }
    }

/* ===== 追加機能: ユーザー情報 / 音声コンテンツ / 学習の記録 ===== */

// storage の参照は先頭 import で読み込んでいる想定 (getStorage, storageRef, uploadBytes, getDownloadURL, deleteObject)
const storage = getStorage(app); // app は既存で初期化済み

// ヘッダのニックネーム表示を更新（Firestore users/<userid> の nickname を使用）
async function refreshHeaderNickname(){
  if(!currentUser) return;
  try {
    const uRef = doc(db, 'users', currentUser.id);
    const snap = await getDoc(uRef);
    let nickname = currentUser.id;
    if(snap.exists()){
      const data = snap.data();
      if(data && data.nickname) nickname = data.nickname;
    } else {
      // 初回: username を nickname にセット
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      nickname = currentUser.id;
    }
    currentUser.nickname = nickname;
    const nameEl = document.getElementById('user-name');
    if(nameEl) nameEl.textContent = nickname;
  } catch(err){
    console.error('refreshHeaderNickname error', err);
  }
}

// ----- バナポ関連 -----
// storage は別途（既に app 初期化済み）
// 1日ボーナス用のヘルパー: YYYY-MM-DD 文字列を返す
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ヘッダーの bnp 表示を更新
async function refreshBnpDisplay(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let bnp = 0;
    if(snap.exists()){
      const data = snap.data();
      if(data && typeof data.bnp === 'number') bnp = data.bnp;
    } else {
      // 初期ドキュメント作成（username / nickname は既に set されている可能性あり）
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id, bnp: 0 }, { merge: true });
      bnp = 0;
    }
    // update UI
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(bnp);
    // also keep local copy
    currentUser.bnp = bnp;
  } catch(err){
    console.error('refreshBnpDisplay error', err);
  }
}

// bnp を加算（負の値で減算も可能）
// returns the new bnp value (number)
async function addBnp(amount){
  try {
    if(!currentUser) return null;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let current = 0;
    if(snap.exists()){
      const data = snap.data();
      current = (data && typeof data.bnp === 'number') ? data.bnp : 0;
    }
    const next = current + Number(amount || 0);
    // マージで書き戻し
    await setDoc(uRef, { bnp: next }, { merge: true });
    // UI 更新
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(next);
    currentUser.bnp = next;
    return next;
  } catch(err){
    console.error('addBnp error', err);
    return null;
  }
}

// ログイン時 1日一回ボーナス +10bnp（lastLoginBonus に日付を保存）
async function creditDailyLoginBonusIfNeeded(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    const today = todayStr();
    let last = null;
    if(snap.exists()){
      const data = snap.data();
      last = data && data.lastLoginBonus ? data.lastLoginBonus : null;
    }
    if(last !== today){
      // give 10bnp
      await addBnp(10);
      // record the date
      await setDoc(uRef, { lastLoginBonus: today }, { merge: true });
      console.log('daily login bonus granted');
    } else {
      console.log('daily login bonus already granted today');
    }
  } catch(err){
    console.error('creditDailyLoginBonusIfNeeded error', err);
  }
}

// ----- ユーザー情報画面 -----
async function renderUserInfo(){
  if(!currentUser) return;
  const uRef = doc(db, 'users', currentUser.id);
  let data = {};
  try {
    const snap = await getDoc(uRef);
    if(snap.exists()) data = snap.data();
    else {
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      data = { username: currentUser.id, nickname: currentUser.id };
    }
  } catch(err){
    console.error('renderUserInfo load error', err);
    data = { username: currentUser.id, nickname: currentUser.id };
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ユーザー情報</h2>
      <p><strong>ユーザー名</strong>: <span id="ui-username">${escapeHtml(data.username || currentUser.id)}</span></p>
      <p><strong>パスワード</strong>: <span id="ui-password">${escapeHtml(users[currentUser.id] ? users[currentUser.id].password : '')}</span></p>
      <p><strong>ニックネーム</strong>: <input id="ui-nickname" value="${escapeHtml(data.nickname || currentUser.id)}" /> <button id="ui-nickname-save" class="btn-plain btn-primary">保存</button></p>
    </div>
  `;

  document.getElementById('ui-nickname-save').addEventListener('click', async ()=>{
    const newNick = (document.getElementById('ui-nickname') || {value:''}).value.trim() || currentUser.id;
    try {
      await setDoc(uRef, { nickname: newNick }, { merge: true });
      currentUser.nickname = newNick;
      const nameEl = document.getElementById('user-name');
      if(nameEl) nameEl.textContent = newNick;
      alert('ニックネームを保存しました');
    } catch(err){
      console.error('save nickname error', err);
      alert('保存に失敗しました: ' + (err.message || err));
    }
  });
}

// ----- 音声コンテンツ画面 -----
async function renderAudioContent(){
  if(!currentUser) return;

  const isAdmin = currentUser.role === 'admin';
  const uploadUi = isAdmin ? `
    <div style="margin-bottom:12px;">
      <input type="text" id="audio-title" placeholder="タイトルを入力" style="padding:6px;border-radius:6px;border:1px solid #d0d7dc;width:60%" />
      <input type="file" id="audio-file" accept="audio/mp3" style="margin-left:8px;" />
      <button id="audio-upload-btn" class="btn-plain btn-primary">アップロード</button>
    </div>
  ` : '';

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>音声コンテンツ</h2>
      ${uploadUi}
      <div id="audio-items">読み込み中...</div>
    </div>
  `;

  // アップロード処理（管理者のみ）
  if(isAdmin){
    document.getElementById('audio-upload-btn').addEventListener('click', async ()=>{
      const fileInput = document.getElementById('audio-file');
      const title = (document.getElementById('audio-title')||{value:''}).value.trim() || (fileInput.files[0] ? fileInput.files[0].name : '無題');
      if(!fileInput.files || fileInput.files.length === 0){ alert('ファイルを選択してください (mp3)'); return; }
      const file = fileInput.files[0];
      if(file.type !== 'audio/mpeg' && !file.name.endsWith('.mp3')){ alert('mp3ファイルを選択してください'); return; }
      const storagePath = `audio/${Date.now()}_${file.name}`;
      try {
        const sRef = ref(storage, storagePath);
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        await addDoc(collection(db,'audio'), {
          title,
          path: storagePath,
          url,
          uploadedBy: currentUser.id,
          createdAt: new Date()
        });
        alert('アップロード完了');
        renderAudioContent();
      } catch(err){
        console.error('audio upload error', err);
        alert('アップロードに失敗しました: ' + (err.message || err));
      }
    });
  }

  // 音声一覧を取得して表示
  try {
    const qAudio = query(collection(db,'audio'), orderBy('createdAt','desc'));
    const snap = await getDocs(qAudio);
    const container = document.getElementById('audio-items');
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">音声コンテンツはまだありません。</div>`;
      return;
    }
    let html = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      html += `<div style="padding:8px 0;border-bottom:1px solid #f0f4f6;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(d.title||'（無題）')}</div>
            <div style="font-size:12px;color:#666">${escapeHtml(d.uploadedBy||'')} ${d.createdAt ? ' • ' + new Date(d.createdAt.seconds*1000).toLocaleString() : ''}</div>
          </div>
          <div>
            <button class="btn-plain play-audio-btn" data-url="${escapeHtml(d.url||'')}" data-id="${id}">再生</button>
            ${isAdmin ? `<button class="btn-plain btn-danger del-audio-btn" data-id="${id}">削除</button>` : ''}
          </div>
        </div>
        <div class="audio-player" id="player-${id}" style="margin-top:8px;"></div>
      </div>`;
    });
    container.innerHTML = html;

    // 再生ボタン
    Array.from(container.querySelectorAll('.play-audio-btn')).forEach(btn => {
      btn.addEventListener('click', (e)=>{
        const url = btn.getAttribute('data-url');
        const id = btn.getAttribute('data-id');
        const playerDiv = document.getElementById(`player-${id}`);
        if(playerDiv){
          playerDiv.innerHTML = `<audio controls src="${url}">お使いのブラウザは audio タグをサポートしていません。</audio>`;
        }
      });
    });

    // 管理者の削除処理（Firestore doc と Storage のオブジェクト削除）
    if(isAdmin){
      Array.from(container.querySelectorAll('.del-audio-btn')).forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          if(!confirm('この音声を削除しますか？')) return;
          try {
            const dSnap = await getDoc(doc(db,'audio',id));
            if(dSnap.exists()){
              const d = dSnap.data();
              if(d && d.path){
                try {
                  const sRef = storageRef(storage, d.path);
                  await deleteObject(sRef); // storage オブジェクトの削除
                } catch(e){ console.warn('storage delete error', e); }
              }
            }
            await deleteDoc(doc(db,'audio',id));
            alert('削除しました');
            renderAudioContent();
          } catch(err){
            console.error('delete audio error', err);
            alert('削除に失敗しました: ' + (err.message || err));
          }
        });
      });
    }
  } catch(err){
    console.error('load audio list error', err);
    const container = document.getElementById('audio-items');
    if(container) container.innerHTML = `<div style="color:#666">音声の読み込みに失敗しました</div>`;
  }
}

// ----- 学習の記録（読み取り表示の雛形） -----
async function renderStudyLog(){
  if(!currentUser) return;
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>学習の記録</h2>
      <div id="studylog-list">読み込み中...</div>
      <div style="margin-top:12px;">（記録の追加は後で拡張できます）</div>
    </div>
  `;
  try {
    const qLog = query(collection(db,'studyLogs'), orderBy('createdAt','desc'));
    const snap = await getDocs(qLog);
    const container = document.getElementById('studylog-list');
    if(snap.empty){ container.innerHTML = '<div style="color:#666">記録はありません。</div>'; return; }
    let html = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      html += `<div style="padding:8px;border-bottom:1px solid #f0f4f6;">
        <div style="font-weight:700">${escapeHtml(d.title || '学習')}</div>
        <div style="font-size:13px;color:#666">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : ''} • ${escapeHtml(d.user||'')}</div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.note||'')}</div>
      </div>`;
    });
    container.innerHTML = html;
  } catch(err){
    console.error('renderStudyLog error', err);
    const container = document.getElementById('studylog-list');
    if(container) container.innerHTML = '<div style="color:#666">読み込みに失敗しました</div>';
  }
}

// ----- サイドメニュークリックを紐づける（追加した li のイベント登録） -----
const menuUserInfoEl = document.getElementById('menu-userinfo');
if(menuUserInfoEl) menuUserInfoEl.addEventListener('click', ()=> { if(!testActive) renderUserInfo(); });

const menuAudioEl = document.getElementById('menu-audio');
if(menuAudioEl) menuAudioEl.addEventListener('click', ()=> { if(!testActive) renderAudioContent(); });

const menuStudyLogEl = document.getElementById('menu-studylog');
if(menuStudyLogEl) menuStudyLogEl.addEventListener('click', ()=> { if(!testActive) renderStudyLog(); });

// ----- showMain をラップしてログイン時にニックネームを更新してホーム表示 -----
if (typeof showMain === 'function') {
  const __orig_showMain = showMain;
  showMain = function(...args){
    __orig_showMain.apply(this, args);
    // ニックネームを読み取ってからホームを描画（失敗してもホームは描画）
    refreshHeaderNickname()
      .then(()=>{
        renderHome();
      })
      .catch(()=>{
        renderHome();
      })
      .finally(()=>{
        // ここから追加 --- ▼
        refreshBnpDisplay().catch(()=>{});
        creditDailyLoginBonusIfNeeded().catch(()=>{});
        // ここまで追加 --- ▲
      });
  };
}

    /* ============== ここまでお知らせ機能 ============== */
// ----- 管理者画面: ユーザー管理 -----
async function renderUserManagement(){
  if(!currentUser || currentUser.role !== 'admin'){
    alert('管理者のみアクセス可能です');
    return;
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ユーザー管理（管理者用）</h2>
      <div style="margin-bottom:12px;">
        <input id="um-filter" placeholder="ユーザーIDで絞り込み" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:40%" />
        <button id="um-refresh" class="btn-plain" style="margin-left:8px;">再読み込み</button>
      </div>
      <div id="um-list">読み込み中...</div>
    </div>
  `;

  document.getElementById('um-refresh').addEventListener('click', loadUserList);
  document.getElementById('um-filter').addEventListener('input', ()=> { loadUserList(); });

  await loadUserList();
}

async function loadUserList(){
  const container = document.getElementById('um-list');
  if(!container) return;
  container.innerHTML = '読み込み中...';

  try {
    const qSnap = await getDocs(collection(db,'users'));
    const filter = (document.getElementById('um-filter')||{value:''}).value.trim().toLowerCase();

    let rows = [];
    qSnap.forEach(d => {
      const item = { id: d.id, ...d.data() };
      if(item.bnp == null) item.bnp = 0;
      if(item.nickname == null) item.nickname = item.username || item.id;
      if(filter && !String(item.id).toLowerCase().includes(filter) && !String(item.username||'').toLowerCase().includes(filter)) return;
      rows.push(item);
    });

    if(rows.length === 0){
      container.innerHTML = '<div style="color:#666">ユーザーが見つかりません。</div>';
      return;
    }

    let html = `<table style="width:100%;border-collapse:collapse;"><thead>
      <tr style="text-align:left;border-bottom:1px solid #eef3f5;">
        <th style="padding:8px;">ユーザーID</th>
        <th>ニックネーム</th>
        <th>BNP</th>
        <th>操作</th>
      </tr></thead><tbody>`;
    rows.forEach(u=>{
      html += `<tr data-uid="${escapeHtml(u.id)}" style="border-bottom:1px solid #f7f9fa;">
        <td style="padding:8px;vertical-align:top;">${escapeHtml(u.id)}</td>
        <td style="vertical-align:top;">
          <input class="um-nickname" value="${escapeHtml(u.nickname||'')}" style="padding:6px;border:1px solid #d0d7dc;border-radius:6px;" />
          <button class="btn-plain um-save-nick" style="margin-left:6px;">保存</button>
        </td>
        <td style="vertical-align:top;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="um-bnp-value" style="min-width:80px;font-weight:bold;">${Number(u.bnp||0)}</div>
            <input type="number" class="um-bnpdelta" value="10" style="width:80px;padding:6px;border-radius:6px;border:1px solid #d0d7dc;" />
            <button class="btn-plain um-add">付与</button>
            <button class="btn-plain btn-danger um-sub">没収</button>
          </div>
        </td>
        <td style="vertical-align:top;">
          <button class="btn-plain um-set" style="margin-right:6px;">直接設定</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;

    // attach handlers
    Array.from(container.querySelectorAll('.um-save-nick')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newNick = tr.querySelector('.um-nickname').value.trim() || uid;
        try {
          await updateDoc(doc(db,'users',uid), { nickname: newNick });
          alert('ニックネームを保存しました');
          if(currentUser && currentUser.id === uid){ currentUser.nickname = newNick; const el = document.getElementById('user-name'); if(el) el.textContent = newNick; }
        } catch(err){ console.error(err); alert('保存に失敗しました'); }
      });
    });

    Array.from(container.querySelectorAll('.um-add')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('増減量を入力してください'); return; }
        if(!confirm(`${uid} に ${delta} bnp を付与しますか？`)) return;
        await changeUserBnp(uid, delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-sub')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('増減量を入力してください'); return; }
        if(!confirm(`${uid} から ${delta} bnp を没収しますか？`)) return;
        await changeUserBnp(uid, -delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-set')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newVal = Number(prompt(`${uid} の bnp をいくつに設定しますか？`, tr.querySelector('.um-bnp-value').textContent) || 0);
        if(isNaN(newVal)){ alert('数値を入力してください'); return; }
        if(!confirm(`${uid} の bnp を ${newVal} に設定しますか？`)) return;
        try {
          await updateDoc(doc(db,'users',uid), { bnp: newVal });
          tr.querySelector('.um-bnp-value').textContent = newVal;
          if(currentUser && currentUser.id === uid){ refreshHeaderBnp(); } // update header if self
        } catch(err){ console.error(err); alert('更新に失敗しました'); }
      });
    });

  } catch(err){
    console.error('loadUserList error', err);
    container.innerHTML = `<div style="color:#666">読み込みに失敗しました</div>`;
  }
}

// bnp を変更する共通処理（読み取り→加算→保存）
async function changeUserBnp(uid, delta, trElement){
  try {
    const uRef = doc(db,'users',uid);
    const snap = await getDoc(uRef);
    let currentVal = 0;
    if(snap.exists()) currentVal = Number(snap.data().bnp || 0);
    const newVal = currentVal + Number(delta || 0);
    await updateDoc(uRef, { bnp: newVal });
    if(trElement){
      trElement.querySelector('.um-bnp-value').textContent = newVal;
    }
    if(currentUser && currentUser.id === uid){
      refreshHeaderBnp();
    }
    alert('更新しました');
  } catch(err){
    console.error(err);
    alert('更新に失敗しました: ' + (err.message || err));
  }
}
// ✅ ページ再読み込みや閉じる前に警告を出す
window.addEventListener("beforeunload", function (event) {
  // ログイン中だけ警告を出す（currentUserが存在するとき）
  if (typeof currentUser !== "undefined" && currentUser) {
    const message = "再読み込みするとログアウトされます。よろしいですか？";
    event.preventDefault();
    event.returnValue = message; // Chrome / Edge 対応
    return message; // Safari 対応
  }
});

  </script>


</body>
</html>







