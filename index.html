<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>La Estacion YMD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* === ãƒ‡ã‚¶ã‚¤ãƒ³ã¯å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ï¼ˆè¦‹ãŸç›®ãã®ã¾ã¾ï¼‰ === */
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      color: #333;
    }
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #e9ecef;
    }
    .login-box {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 300px;
    }
    .login-box h2 { margin-bottom: 1rem; }
    .login-box input {
      width: 100%;
      padding: 0.6rem;
      margin: 0.5rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .login-box button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 1rem;
      border: none;
      border-radius: 6px;
      background: #28a745;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    .login-box button:hover { background: #218838; }
    .error { color: red; font-size: 0.9rem; margin-top: 0.5rem; }

    /* ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯çµ¶å¯¾ã«å¤‰ãˆãªã„ï¼‰ */
    #main-page { display: none; height: 100vh; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2c3e50;
      color: #fff;
      padding: 0.8rem 1.2rem;
    }
    .logo { font-size: 1.2rem; font-weight: bold; }
    .user-info { display:flex; align-items:center; gap:1rem; }
    #session-timer { font-size: 0.95rem; color:#f1c40f; } /* è¿½åŠ è¡¨ç¤ºï¼ˆè¦‹ãŸç›®ã«æº¶ã‘ã‚‹ã‚ˆã†æ§ãˆã‚ï¼‰ */
    #test-timer { font-size:0.95rem; color:#2ecc71; font-weight:bold; margin-left:8px; } /* ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼ï¼ˆå³ä¸Šè¡¨ç¤ºï¼‰ */
    .logout-btn {
      background: #e74c3c;
      border: none;
      padding: 0.4rem 0.8rem;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn:hover { background: #c0392b; }

    main { display:flex; height: calc(100vh - 50px); }
    nav {
      width: 200px;
      background: #34495e;
      color: #fff;
      padding-top: 1rem;
    }
    nav ul { list-style:none; padding:0; margin:0; }
    nav ul li {
      padding: 0.8rem 1rem;
      cursor: pointer;
    }
    nav ul li:hover { background: #3d566e; }
    nav ul li.disabled { opacity: 0.4; pointer-events: none; } /* ãƒ†ã‚¹ãƒˆä¸­ã¯ç„¡åŠ¹åŒ– */
    section { flex: 1; padding: 2rem; overflow-y: auto; }

    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:16px; }
    .q-block{ border:1px solid #e7eef2; padding:12px; border-radius:8px; margin-bottom:12px; background:#fbfdff; }
    .choice-row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .choice-row input[type="text"]{ flex:1; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row input[type="number"]{ width:100px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row select{ width:120px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .btn-plain{ padding:8px 10px; border-radius:6px; border:0; cursor:pointer; }
    .btn-primary{ background:#2c3e50; color:#fff; }
    .btn-danger{ background:#e74c3c; color:#fff; }
    .hidden{ display:none !important; }

    /* small helper for edit buttons list */
    .part-item { border:1px solid #eef3f5; padding:12px; border-radius:8px; margin-bottom:12px; background:#fff; }
    .part-actions { margin-top:8px; display:flex; gap:8px; }

    /* ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .trophy-anim {
      animation: shine 2s infinite linear;
      display: inline-block;
    }
    @keyframes shine {
      0%   { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
      25%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      50%  { transform: scale(1.2) rotate(5deg); filter: drop-shadow(0 0 12px rgba(255,255,255,1)); }
      75%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
    }

/* --- bnp pill --- */
#bnp-display{
  background: #fff;
  color: #2c3e50;
  padding: 6px 30px;
  border-radius: 999px; /* åŠå††å½¢ */
  display:inline-flex;
  align-items:center;
  gap:8px;
  min-width:88px;
  justify-content:flex-end; /* æ•°å­—ã¯å³å¯„ã› */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-weight:700;
  margin-right: 8px; /* user-info å†…ã®ä½™ç™½ */
}
#bnp-value{ font-size:1.05em; }
#bnp-unit{ font-size:0.85em; color:#666; padding-left:4px; }

/* æ–‡æ³•ç‰¹è¨“ã®è¨­å•æ–‡ â†’ ã‚¹ãƒšãƒ¼ã‚¹ã‚„æ”¹è¡Œã‚’ä¿æŒ */
.grammar-question-text {
  white-space: pre-wrap;
}

/* ä¸¦ã¹æ›¿ãˆå•é¡Œã®UI */
#answer-area {
  border:2px solid black;
  padding:8px;
  min-height:40px;
  margin-bottom:10px;
}


  </style>

  <!-- Font Awesome èª­ã¿è¾¼ã¿ï¼ˆãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼‰ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>


<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <div id="login-page">
    <div class="login-box">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <form id="login-form">
        <input type="text" id="login-id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" required>
        <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
        <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
      <div id="login-error" class="error"></div>
      <div style="margin-top:8px;font-size:12px;color:#666">
        IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <div id="main-page">
    <header>
      <div class="logo">ğŸ“˜ La Estacion YMD</div>
      <div class="user-info" aria-live="polite">
<!-- æ—¢å­˜ã® .user-info ã®ä¸€ç•ªä¸Šï¼ˆã¾ãŸã¯ user-name ã®å·¦ï¼‰ã«è¿½åŠ  -->
<div id="bnp-display" title="ç²å¾—ãƒãƒŠãƒ">
  <span id="bnp-value">0</span>
  <span id="bnp-unit"> bnp</span>
</div>
        <span id="user-name">â€”</span>
        <span id="session-timer">æ®‹ã‚Š: 60:00</span>
        <span id="test-timer" class="hidden">ãƒ†ã‚¹ãƒˆæ®‹ã‚Š: 15:00</span> <!-- ãƒ†ã‚¹ãƒˆä¸­ã®ã¿è¡¨ç¤º -->
        <button id="logout-btn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <main>
      <nav>
        <ul>
          <li id="menu-userinfo">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</li>
          <li id="menu-test">ãƒ†ã‚¹ãƒˆ</li>
          <li id="menu-history">éå»ã®æˆç¸¾</li>
          <li id="menu-audio">éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</li>
          <li id="menu-studylog">å­¦ç¿’ã®è¨˜éŒ²</li>
          <li id="menu-create" class="hidden">å•é¡Œä½œæˆ</li>
          <li id="menu-list" class="hidden">å•é¡Œä¸€è¦§</li>
          <li id="menu-grammar-admin" class="hidden">æ–‡æ³•å•é¡Œä½œæˆ</li>
          <li id="menu-useradmin" class="hidden">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</li>
        </ul>
      </nav>
      <section id="content">
        <div class="card"><h2>ã‚ˆã†ã“ãï¼</h2><p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK + æ©Ÿèƒ½è¿½åŠ ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";



    const firebaseConfig = {
      apiKey: "AIzaSyAIg8mvIn8K5qDfP_ozemtZRqKIEioTfMY",
      authDomain: "la-estacion-ymd.firebaseapp.com",
      projectId: "la-estacion-ymd",
      storageBucket: "la-estacion-ymd.firebasestorage.app",
      messagingSenderId: "996153459691",
      appId: "1:996153459691:web:5d9054f92f521fb8388fae",
      measurementId: "G-QKD7SC860Y"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºå®šæƒ…å ± ===
    const users = {
      "aduser0110": { password: "ad84536172", role: "admin" },
      "user0110":   { password: "assalam", role: "user" },
      "user011001": { password: "assalam", role: "user" },
      "user011002": { password: "assalam", role: "user" },
      "user011003": { password: "assalam", role: "user" },
      "user011004": { password: "assalam", role: "user" },
      "user011005": { password: "assalam", role: "user" },
      "user011006": { password: "assalam", role: "user" },
      "user011007": { password: "assalam", role: "user" }
    };

    let currentUser = null;

    // ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆæ—¢å­˜ä»•æ§˜ï¼‰ =====
    let idleSeconds = 60 * 60;
    let idleInterval = null;
    function startSessionCountdown(){
      idleSeconds = 60 * 60;
      if(idleInterval) clearInterval(idleInterval);
      updateSessionDisplay();
      idleInterval = setInterval(()=>{
        idleSeconds--;
        updateSessionDisplay();
        if(idleSeconds <= 0){
          clearInterval(idleInterval);
          idleInterval = null;
          alert('60åˆ†ç„¡æ“ä½œã®ãŸã‚è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚');
          doLogout();
        }
      }, 1000);
    }
    function updateSessionDisplay(){
      const mm = String(Math.floor(idleSeconds/60)).padStart(2,'0');
      const ss = String(idleSeconds % 60).padStart(2,'0');
      const el = document.getElementById('session-timer');
      if(el) el.textContent = `æ®‹ã‚Š: ${mm}:${ss}`;
    }
    function resetIdle(){ idleSeconds = 60 * 60; updateSessionDisplay(); }
    ['mousemove','keydown','click','touchstart','scroll'].forEach(ev=>{
      document.addEventListener(ev, ()=>{ if(currentUser) resetIdle(); }, {passive:true});
    });

    // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
    document.getElementById('login-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = document.getElementById('login-id').value.trim();
      const pw = document.getElementById('login-password').value.trim();
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';
      if(!id || !pw){ errEl.textContent = 'IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
      if(users[id] && users[id].password === pw){
        currentUser = { id, role: users[id].role };
        showMain();
      } else {
        errEl.textContent = 'IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
      }
    });

    // ===== è¡¨ç¤ºåˆ‡æ›¿ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ï¼‰ =====
    function showMain(){
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-page').style.display = 'block';
      document.getElementById('user-name').textContent = currentUser.id;
      // ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
      if(currentUser.role === 'admin'){
        document.getElementById('menu-create').classList.remove('hidden');
        document.getElementById('menu-list').classList.remove('hidden');
        document.getElementById('menu-useradmin').classList.remove('hidden');
        document.getElementById('menu-grammar-admin').classList.remove('hidden');
      } else {
        document.getElementById('menu-create').classList.add('hidden');
        document.getElementById('menu-list').classList.add('hidden');
        document.getElementById('menu-useradmin').classList.add('hidden');
        document.getElementById('menu-grammar-admin').classList.add('hidden');
      }
      // start session countdown
      startSessionCountdown();
      // default content (test menu)
      renderTestMenu();
    }

    // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
    document.getElementById('logout-btn').addEventListener('click', ()=> {
      if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) doLogout();
    });
    function doLogout(){
      // stop test if running
      if(testActive) {
        stopTest(); // stop timers and UI
      }
      currentUser = null;
      if(idleInterval){ clearInterval(idleInterval); idleInterval = null; }
      document.getElementById('main-page').style.display = 'none';
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('login-form').reset();
      // reset display
      document.getElementById('session-timer').textContent = 'æ®‹ã‚Š: 60:00';
      document.getElementById('content').innerHTML = `<div class="card"><h2>ã‚ˆã†ã“ãï¼</h2><p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>`;
    }

    // ===== ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‹•ä½œï¼ˆãã®ã¾ã¾ï¼‰ =====
    document.getElementById('menu-test').addEventListener('click', ()=> { if(!testActive) renderTestMenu(); });
    document.getElementById('menu-history').addEventListener('click', ()=> { if(!testActive) renderHistory(); });
    document.getElementById('menu-create').addEventListener('click', ()=> { if(!testActive) renderCreateForm(); });
    document.getElementById('menu-list').addEventListener('click', ()=> { if(!testActive) loadPartsList(); });
    document.getElementById('menu-useradmin').addEventListener('click', ()=> { if(!testActive) renderUserManagement(); });
    document.getElementById('menu-grammar-admin').addEventListener('click', ()=> { if(!testActive) renderGrammarAdminHome(); });


    // ===== ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆé››å½¢ï¼‰ =====
    function renderTestMenu(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ãƒ†ã‚¹ãƒˆ</h2>
      <div class="card" style="padding:12px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="min-width:200px;flex:1" class="card">
            <h3 style="margin:0 0 8px 0">é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ</h3>
            <button class="btn-plain btn-primary" id="start-speed">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
          </div>
          <div style="min-width:200px;flex:1" class="card">
            <h3 style="margin:0 0 8px 0">æ–‡æ³•ç‰¹è¨“</h3>
            <button class="btn-plain btn-primary" id="start-grammar">ç‰¹è¨“é–‹å§‹</button>
          </div>
        </div>
      </div>
    </div>
  `;
  // æ—¢å­˜ã® start-speed ãƒãƒ³ãƒ‰ãƒ©ã¯æ®‹ã™ï¼ˆA2 ã®ä»–ã®å ´æ‰€ã§ã‚‚æ‹¾ã£ã¦ã„ã‚‹ãŒäºŒé‡ç™»éŒ²ã‚’é¿ã‘ã‚‹ï¼‰
  const startBtn = document.getElementById('start-speed');
  if(startBtn) startBtn.addEventListener('click', async ()=> {
    if(confirm('ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚åˆ¶é™æ™‚é–“ã¯15åˆ†ã§ã™ã€‚')) await startTest();
  });

  const grammarBtn = document.getElementById('start-grammar');
  if(grammarBtn) grammarBtn.addEventListener('click', async ()=> {
    if(confirm('æ–‡æ³•ç‰¹è¨“ã‚’é–‹å§‹ã—ã¾ã™ã€‚50å•é€£ç¶šã§å‡ºé¡Œã•ã‚Œã¾ã™ã€‚')) {
      await startGrammarTraining();
    }
  });
}

    // ---------- éå»ã®æˆç¸¾ï¼ˆãƒ†ã‚¹ãƒˆç¨®åˆ¥é¸æŠ + å±¥æ­´è¡¨ç¤ºï¼‰ ----------
function renderHistory(){
  // ã¾ãšç¨®åˆ¥é¸æŠã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>éå»ã®æˆç¸¾</h2>
      <p>é–²è¦§ã—ãŸã„ãƒ†ã‚¹ãƒˆã®ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
      <div id="history-type-cards" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
        <div class="card" style="flex:1;min-width:180px;cursor:pointer" data-type="é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ">é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer" data-type="æ–‡æ³•ç‰¹è¨“">æ–‡æ³•ç‰¹è¨“</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer;opacity:0.6">å˜èªãƒ†ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰</div>
        <div class="card" style="flex:1;min-width:180px;cursor:pointer;opacity:0.6">ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç‰¹è¨“ï¼ˆæœªå®Ÿè£…ï¼‰</div>
      </div>
      <div id="history-list" style="margin-top:16px;"></div>
    </div>
  `;

  // æœ‰åŠ¹ãªã‚«ãƒ¼ãƒ‰ã ã‘ã‚¯ãƒªãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–ï¼ˆä»Šã¯ã€Œé€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆã€ã ã‘ï¼‰
  const cardContainer = document.getElementById('history-type-cards');
  if(!cardContainer) return;
  const cards = cardContainer.querySelectorAll('div[data-type]');
  cards.forEach(card => {
    card.addEventListener('click', () => {
      // è¦‹ãŸç›®ã®é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ
      cards.forEach(c=> c.style.boxShadow = 'none');
      card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
      // èª­ã¿è¾¼ã¿
      const type = card.getAttribute('data-type');
      loadHistory(type);
    });
  });
}

// --- å›ç­”ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ­£è¦åŒ–ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ ---
function normalizeAnswer(a){
  // a: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¥ã‚‹å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå¤ã„å½¢å¼ãƒ»æ–°ã—ã„å½¢å¼ã©ã¡ã‚‰ã§ã‚‚ï¼‰
  const selected = (a && (a.selected !== undefined ? a.selected : (a.userAnswer !== undefined ? a.userAnswer : (a.selectedValue !== undefined ? a.selectedValue : null)))) || null;
  const correctAnswers = (a && (a.correctAnswer || a.correctAnswers || a.answer || []));
  // isCorrect ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã° correct (boolean) ã‚’ä½¿ã†
  let isCorrect = (a && typeof a.isCorrect === 'boolean') ? a.isCorrect : (a && typeof a.correct === 'boolean' ? a.correct : null);

  if(isCorrect === null){
    // è‡ªå‹•åˆ¤å®šï¼ˆselected ãŒ null => æœªè§£ç­”ã¨ã™ã‚‹ï¼‰
    if(selected === null || selected === undefined || selected === ''){
      isCorrect = false;
    } else {
      // selected ãŒé…åˆ—ã‹ã©ã†ã‹ã§åˆ¤å®šã‚’åˆ†ã‘ã‚‹
      if(Array.isArray(correctAnswers) && Array.isArray(selected)){
        // é…åˆ—åŒå£«ã‚’ãƒˆãƒªãƒ ã—ã¦æ¯”è¼ƒï¼ˆé †åºã¾ã§ä¸€è‡´ï¼‰
        const eq = selected.length === correctAnswers.length &&
                   selected.every((v,i)=>String(v).trim().toLowerCase() === String(correctAnswers[i]).trim().toLowerCase());
        isCorrect = !!eq;
      } else if(Array.isArray(correctAnswers)){
        // correctAnswers ã®ã„ãšã‚Œã‹ã« selected ãŒä¸€è‡´ã™ã‚Œã°æ­£è§£
        isCorrect = correctAnswers.some(c => String(c).trim().toLowerCase() === String(selected).trim().toLowerCase());
      } else {
        isCorrect = false;
      }
    }
  }

  return {
    question: a && (a.question || a.q || '') || '',
    selected,
    correctAnswers: Array.isArray(correctAnswers) ? correctAnswers : (correctAnswers ? [correctAnswers] : []),
    isCorrect: !!isCorrect,
    score: (a && (a.score || 0)) || 0
  };
}

async function showSavedResult(docId){
  if(!docId) return;
  const content = document.getElementById('content');
  if(!content) return;
  content.innerHTML = `<div class="card"><h2>è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...</h2></div>`;

  try{
    const dSnap = await getDoc(doc(db,'results',docId));
    if(!dSnap.exists()){
      content.innerHTML = `<div class="card"><h2>è©²å½“ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2></div>`;
      return;
    }
    const d = dSnap.data();
    const created = formatDateForDisplay(d.createdAt);

    let html = `<div class="card">
      <h2>ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°</h2>
      <div style="margin-top:8px;">
        <p><strong>ãƒ†ã‚¹ãƒˆç¨®åˆ¥:</strong> ${escapeHtml(d.testType || d.type || '')}</p>
        <p><strong>ã‚¹ã‚³ã‚¢:</strong> ${escapeHtml(String(d.score || 0))} ç‚¹</p>
        <p><strong>WPM:</strong> ${Number(d.wpm || 0).toFixed(2)}</p>
        <p><strong>çµŒéç§’æ•°:</strong> ${escapeHtml(String(d.elapsed || 0))} ç§’</p>
        <p><strong>ç·å˜èªæ•°:</strong> ${escapeHtml(String(d.totalWords != null ? d.totalWords : ''))}</p>
        <p style="color:#999;"><strong>ä¿å­˜æ—¥æ™‚:</strong> ${escapeHtml(created)}</p>
      </div>
      <hr style="margin:12px 0;" />
      <h3>è¨­å•ã”ã¨ã®è§£ç­”</h3>
    `;

    const answersRaw = Array.isArray(d.answers) ? d.answers : [];
    if(answersRaw.length === 0){
      html += `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">è¨­å•ã”ã¨ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    } else {
      answersRaw.forEach((a, idx) => {
        const n = normalizeAnswer(a);
        const status = n.selected === null || n.selected === undefined || n.selected === '' ? 'æœªè§£ç­”' : (n.isCorrect ? 'â­• æ­£è§£' : 'âŒ ä¸æ­£è§£');
        const color = n.selected === null || n.selected === undefined || n.selected === '' ? 'gray' : (n.isCorrect ? 'green' : 'red');

        html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
          <p><strong>Q${idx+1}:</strong> ${escapeHtml(n.question || '')}</p>
          <p><strong>ã‚ãªãŸã®è§£ç­”:</strong> ${escapeHtml(Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'ãªã—'))}</p>
          <p><strong>æ­£ã—ã„ç­”ãˆ:</strong> ${escapeHtml((n.correctAnswers || []).join(' / '))}</p>
          <p style="color:${color}; font-weight:bold;">${status}</p>
        </div>`;
      });
    }

    html += `<div style="text-align:right; margin-top:12px;">
        <button class="btn-plain btn-primary" id="back-history-btn">ä¸€è¦§ã«æˆ»ã‚‹</button>
      </div></div>`;

    content.innerHTML = html;

    document.getElementById('back-history-btn').addEventListener('click', ()=> {
      renderHistory();
    });

  }catch(err){
    console.error('showSavedResult error', err);
    content.innerHTML = `<div class="card"><h2>èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2><div style="color:#c00">${escapeHtml(err.message || err)}</div></div>`;
  }
}



// ãƒ˜ãƒ«ãƒ‘: createdAt ãŒ Timestamp ã‹ Date ã‹åˆ¤å®šã—ã¦è¡¨ç¤ºç”¨ã«æ–‡å­—åˆ—åŒ–
function formatDateForDisplay(createdAt){
  if(!createdAt) return '';
  // Firestore Timestamp ã®å ´åˆ
  if(typeof createdAt.toDate === 'function') {
    return createdAt.toDate().toLocaleString();
  }
  // Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ ISO æ–‡å­—åˆ—ç­‰
  try {
    const d = (createdAt instanceof Date) ? createdAt : new Date(createdAt);
    return isNaN(d.getTime()) ? '' : d.toLocaleString();
  } catch(e){ return ''; }
}

async function loadHistory(type){
  if(!currentUser){
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }
  const container = document.getElementById('history-list');
  if(!container) return;
  container.innerHTML = '<div style="color:#666">èª­ã¿è¾¼ã¿ä¸­...</div>';

  try{
    const q = query(
      collection(db,'results'),
      where('uid','==', currentUser.id),
      where('type','==', type),
      orderBy('createdAt','desc')
    );
    const snap = await getDocs(q);
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">è©²å½“ã™ã‚‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const created = formatDateForDisplay(d.createdAt);
      html += `
        <div style="padding:12px;border:1px solid #eef3f5;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(type)}</div>
            <div style="font-size:14px;color:#666;margin-top:6px;">${escapeHtml(String(d.score || 0))} ç‚¹ â€¢ WPM: ${Number(d.wpm || 0).toFixed(2)} â€¢ ${escapeHtml(String(d.elapsed || 0))} ç§’</div>
            <div style="font-size:12px;color:#999;margin-top:6px;">${escapeHtml(created)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn-plain" data-id="${docSnap.id}" data-action="detail">ãã‚ã—ãè¦‹ã‚‹</button>
            <button class="btn-plain" data-id="${docSnap.id}" data-action="download" style="display:none">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;

    // attach handlers
    container.querySelectorAll('button[data-action="detail"]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSavedResult(btn.getAttribute('data-id')));
    });

  }catch(err){
    console.error('loadHistory error', err);
    container.innerHTML = `<div style="color:#c00">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(err.message || err)}</div>`;
  }
}

    // ===== å•é¡Œä½œæˆï¼ˆä»¥å‰ã®ã²ãªå½¢ãã®ã¾ã¾ï¼‰ =====
    function renderCreateForm(){
      document.getElementById('content').innerHTML = `
        <div class="card">
          <h2>å•é¡Œä½œæˆï¼ˆç®¡ç†è€…ï¼‰</h2>
          <div>
            <label>è‹±æ–‡ï¼ˆPassageï¼‰</label>
            <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
          </div>
          <div id="questions-area" style="margin-top:12px;"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="add-question" class="btn-plain btn-primary">è¨­å•ã‚’è¿½åŠ </button>
            <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">ä¿å­˜</button>
          </div>
        </div>
      `;
      document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
      document.getElementById('save-part').addEventListener('click', ()=> savePartToFirestore());
      addQuestionBlock();
    }

    function addQuestionBlock(){
      const qArea = document.getElementById('questions-area');
      const div = document.createElement('div');
      div.className = 'q-block';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>è¨­å•</strong>
          <div>
            <button class="btn-plain btn-danger btn-delete-q" type="button">è¨­å•ã‚’å‰Šé™¤</button>
          </div>
        </div>
        <input class="q-text" type="text" placeholder="è¨­å•æ–‡ã‚’å…¥åŠ›" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
        <div class="choices-area" style="margin-top:8px;"></div>
        <div style="margin-top:6px;">
          <button class="btn-plain btn-secondary btn-add-choice" type="button">é¸æŠè‚¢ã‚’è¿½åŠ </button>
        </div>
      `;
      qArea.appendChild(div);
      div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
      div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
      // add two default choices
      addChoiceRow(div); addChoiceRow(div);
    }

    function addChoiceRow(qBlock, choice=null){
      const area = qBlock.querySelector('.choices-area');
      const div = document.createElement('div');
      div.className = 'choice-row';
      div.innerHTML = `
        <input type="text" class="choice-text" placeholder="é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆ"/>
        <input type="number" class="choice-score" placeholder="ã‚¹ã‚³ã‚¢" value="0" />
        <select class="choice-correct">
          <option value="false">ä¸æ­£è§£</option>
          <option value="true">æ­£è§£</option>
        </select>
        <button class="btn-plain btn-danger btn-del-choice" type="button">å‰Šé™¤</button>
      `;
      area.appendChild(div);
      div.querySelector('.btn-del-choice').addEventListener('click', ()=> div.remove());
      if(choice){
        div.querySelector('.choice-text').value = choice.text || '';
        div.querySelector('.choice-score').value = (choice.score!=null) ? choice.score : 0;
        div.querySelector('.choice-correct').value = choice.correct ? 'true' : 'false';
      }
    }

    // ===== Firestore: ä¿å­˜ï¼ˆaddDocï¼‰ =====
    async function savePartToFirestore(){
      const passage = document.getElementById('part-passage').value.trim();
      if(!passage){ alert('è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const qNodes = document.querySelectorAll('.q-block');
      const questions = [];
      qNodes.forEach(q=>{
        const text = q.querySelector('.q-text').value.trim();
        const choices = [];
        q.querySelectorAll('.choice-row').forEach(c=>{
          const chText = c.querySelector('.choice-text').value.trim();
          const chScore = Number(c.querySelector('.choice-score').value || 0);
          const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
          choices.push({ text: chText, score: chScore, correct: chCorrect });
        });
        if(text) questions.push({ text, choices });
      });
      if(questions.length===0){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      try{
        await addDoc(collection(db,'parts'), {
          passage,
          questions,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        renderCreateForm();
      }catch(err){
        console.error(err);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

   

// ===== ãƒ†ã‚¹ãƒˆå®Ÿè£…éƒ¨åˆ†ï¼ˆæ”¹è‰¯ãƒ»ç½®æ›ç”¨ï¼‰ =====
let testActive = false;
let testStartTime = 0;
let testRemaining = 0;
let testTimerInterval = null;
let partPool = []; // all parts from Firestore
let usedIds = [];
let totalWords = 0;
let obtainedScore = 0;
let fullScore = 0;
let answers = []; // è§£ç­”ãƒ­ã‚°ã‚’ä¿å­˜

function disableMenus(flag){
  ['menu-test','menu-history','menu-create','menu-list'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(flag) el.classList.add('disabled'); else el.classList.remove('disabled');
  });
}

async function startTest(){
  console.log('DEBUG: startTest called');
  const snap = await getDocs(collection(db,'parts'));
  partPool = [];
  snap.forEach(doc => partPool.push({ id: doc.id, ...doc.data() }));
  if(partPool.length === 0){ alert('ã¾ã å•é¡ŒãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

  // init
  testActive = true;
  usedIds = [];
  totalWords = 0;
  obtainedScore = 0;
  fullScore = 0;
  answers = [];
  testStartTime = Date.now();
  testRemaining = 15 * 60; // 15 minutes

  const testTimerEl = document.getElementById('test-timer');
  if (testTimerEl) testTimerEl.classList.remove('hidden');

  updateTestTimerDisplay();
  if(testTimerInterval) clearInterval(testTimerInterval);
  testTimerInterval = setInterval(()=>{
    testRemaining--;
    updateTestTimerDisplay();
    if(testRemaining <= 0){
      // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã¯çµæœã¸
      endTest().catch(err => console.error('endTest error on timeout', err));
    }
  }, 1000);
  disableMenus(true);
  showNextPart();
}

function updateTestTimerDisplay(){
  const mm = String(Math.floor(testRemaining / 60)).padStart(2, '0');
  const ss = String(testRemaining % 60).padStart(2, '0');
  const el = document.getElementById('test-timer');
  if (el) el.textContent = `ãƒ†ã‚¹ãƒˆæ®‹ã‚Š: ${mm}:${ss}`;
}

function pickRandomPart(){
  const remaining = partPool.filter(p => !usedIds.includes(p.id));
  if(remaining.length === 0) return null;
  const idx = Math.floor(Math.random() * remaining.length);
  return remaining[idx];
}

function showNextPart(){
  if(!testActive) return;
  const part = pickRandomPart();
  if(!part){
    // no more parts â†’ çµæœã¸
    endTest().catch(err => console.error('endTest error (no more parts)', err));
    return;
  }
  usedIds.push(part.id);

  // compute word count for this part and add
  const words = (part.passage || '').trim().split(/\s+/).filter(Boolean).length;
  totalWords += words;

  // compute this part's max score
  let partMax = 0;
  (part.questions || []).forEach(q=>{
    (q.choices || []).forEach(c=>{
      if(typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'){
        partMax += Number(c.score || 0);
      }
    });
  });
  fullScore += partMax;

  // render part
  let html = `<div class="card"><h2>Part</h2><div style="white-space:pre-line;margin-bottom:12px">${escapeHtml(part.passage||'')}</div>`;
  (part.questions || []).forEach((q, qi) => {
    html += `<div class="q-block"><p>${escapeHtml(q.text||'')}</p>`;
    (q.choices || []).forEach((c, ci) => {
      const scoreAttr = Number(c.score || 0);
      const correctAttr = (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true') ? 'true' : 'false';
      // data-text ã¯ç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆï¼‰ã‚’å…¥ã‚Œã¦ãŠã
      html += `<div><label><input type="radio" name="q${qi}" data-score="${scoreAttr}" data-correct="${correctAttr}" data-text="${escapeHtml(c.text||'')}"> ${escapeHtml(c.text||'')}</label></div>`;
    });
    html += `</div>`;
  });
  html += `<div style="text-align:right;margin-top:10px;"><button class="btn-plain btn-primary" id="next-part-btn">æ¬¡ã®Partã¸</button></div></div>`;
  document.getElementById('content').innerHTML = html;

  // next handler
  const nextBtn = document.getElementById('next-part-btn');
  if(!nextBtn){
    console.warn('next-part-btn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  nextBtn.addEventListener('click', ()=> {
    console.log('DEBUG: next-part clicked for part id', part.id);
    const qCount = (part.questions || []).length;
    for(let qi=0; qi<qCount; qi++){
      const sel = document.querySelector(`input[name="q${qi}"]:checked`);
      if(sel){
        const s = Number(sel.dataset.score || 0);
        obtainedScore += s;
        const correct = (sel.dataset.correct === "true");
        const selected = sel.dataset.text || null;

        // æ­£ã—ã„ç­”ãˆã‚’æŠ½å‡ºï¼ˆé…åˆ—ï¼‰
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected,
          correct,
          score: s,
          correctAnswer: correctAnswers
        });
      } else {
        // æœªè§£ç­”
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected: null,
          correct: false,
          score: 0,
          correctAnswer: correctAnswers
        });
      }
    }

    // æ®‹ã‚Šã®ãƒ‘ãƒ¼ãƒˆãŒã‚ã‚Œã°æ¬¡ã¸ã€ãªã‘ã‚Œã° endTest
    const remaining = partPool.filter(p => !usedIds.includes(p.id));
    if(remaining.length === 0){
      endTest().catch(err => console.error('endTest error from next handler', err));
    } else {
      showNextPart();
    }
  }, { once: true }); // è¤‡æ•°ãƒã‚¤ãƒ³ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚ once:true
}

async function endTest(){
  try {
    console.log('DEBUG: endTest start');
    if(!testActive) return;
    stopTest();

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;

    // ãƒ©ãƒ³ã‚¯åˆ¤å®šï¼ˆã”æŒ‡å®šã®é–¾å€¤ã¯ã€Œè¶…ãˆã‚‹ã¨ã€ãªã®ã§ > ã‚’ä½¿ç”¨ï¼‰
    let rank = "ãƒãƒ¼ãƒãƒ«";
    let rankColor = "#2c3e50";
    if(obtainedScore > 80){ rank = "ãƒ—ãƒ©ãƒãƒŠ"; rankColor = "#bcd"; } // è–„ã„è‰²
    else if(obtainedScore > 67){ rank = "ã‚´ãƒ¼ãƒ«ãƒ‰"; rankColor = "#ffd700"; }
    else if(obtainedScore > 52){ rank = "ã‚·ãƒ«ãƒãƒ¼"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 43){ rank = "ãƒ–ãƒ­ãƒ³ã‚º"; rankColor = "#cd7f32"; }

    // ã¾ãšç”»é¢ã‚’è¡¨ç¤ºï¼ˆä¿å­˜ã¯å¾Œå›ã—ï¼‰
    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });

    // éåŒæœŸã§ä¿å­˜ï¼ˆå¤±æ•—ã—ã¦ã‚‚æç”»ã¯æ­¢ã‚ãªã„ï¼‰
    (async () => {
      try {
        const uid = currentUser ? currentUser.id : 'guest';
        await addDoc(collection(db,"results"),{
          uid,
          type: "é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ", // â† è¿½åŠ : ãƒ†ã‚¹ãƒˆç¨®åˆ¥
          score: obtainedScore,
          fullScore,
          elapsed: elapsedSec,
          wpm,
          rank,
          answers,
          createdAt: new Date()
        });
        await addBnp(obtainedScore);
        console.log('results saved');
      } catch(saveErr){
        console.warn('results save failed', saveErr);
      }
    })();

    disableMenus(false);
  } catch (err) {
    console.error('endTest å†…ã§ä¾‹å¤–:', err);
    alert('çµæœè¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Console ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ' + (err && err.message ? err.message : err));
  }
}

// çµæœç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åˆ†é›¢ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸æˆ»ã‚‹éš›ã« endTest ã‚’å†å®Ÿè¡Œã—ãªã„ãŸã‚ï¼‰
function renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords }){
  // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ã¦ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚’è¡¨ç¤º
  let trophyHtml = "";
  if(rank !== "ãƒ–ãƒ­ãƒ³ã‚º"){ // ãƒ–ãƒ­ãƒ³ã‚ºä»¥ä¸Šã ã‘è¡¨ç¤º
    let size = "80px";
    if(rank === "ã‚·ãƒ«ãƒãƒ¼"){ size = "90px"; }
    if(rank === "ã‚´ãƒ¼ãƒ«ãƒ‰"){ size = "100px"; }
    if(rank === "ãƒ—ãƒ©ãƒãƒŠ"){ size = "110px"; }

    trophyHtml = `
      <div style="font-size:${size}; color:${rankColor}; text-align:center; margin-bottom:10px;">
        <i class="fas fa-trophy trophy-anim"></i>
      </div>
    `;
  }

  document.getElementById('content').innerHTML = `
    <div class="card" style="border:3px solid ${rankColor}; text-align:center; padding:20px;">
      <h2 style="color:${rankColor}; margin:0 0 8px 0;">${escapeHtml(rank)}</h2>
      ${trophyHtml}
      <div style="font-size:2.8em; font-weight:bold; color:${rankColor}; margin:10px 0;">
        ${obtainedScore}
      </div>
      <div style="text-align:right; margin-top:10px;">
        <p style="margin:0 0 6px 0;"><strong>WPM:</strong> ${wpm.toFixed(2)}</p>
        <p style="margin:0 0 6px 0;"><strong>çµŒéç§’æ•°:</strong> ${elapsedSec}</p>
        <p style="margin:0;"><strong>ç·å˜èªæ•°:</strong> ${totalWords}</p>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn-plain" id="review-btn">ãã‚ã—ãè¦‹ã‚‹</button>
        <button class="btn-plain btn-primary" id="close-btn">çµæœç”»é¢ã‚’é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  const reviewBtn = document.getElementById('review-btn');
  if(reviewBtn) reviewBtn.addEventListener('click', showDetailedReview);
  const closeBtn = document.getElementById('close-btn');
  if(closeBtn) closeBtn.addEventListener('click', ()=> {
    // ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆæ—¢å­˜ã® renderHomeã‚’ä½¿ã†ï¼‰
    if(typeof renderHome === 'function') renderHome();
    else document.getElementById('content').innerHTML = `<div class="card"><h2>ãƒ›ãƒ¼ãƒ </h2></div>`;
  });
}

function showDetailedReview(){
  let html = `<div class="card"><h2>ãƒ†ã‚¹ãƒˆè¦‹ç›´ã—</h2>`;
  answers.forEach((a, idx) => {
  let status, color;

  if (!a.selected) {
    status = "æœªè§£ç­”";
    color = "gray";
  } else if (a.correct) {
    status = "â­• æ­£è§£";
    color = "green";
  } else {
    status = "âŒ ä¸æ­£è§£";
    color = "red";
  }

  html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
    <p><strong>Q${idx+1}:</strong> ${escapeHtml(a.question || '')}</p>
    <p><strong>ã‚ãªãŸã®è§£ç­”:</strong> ${escapeHtml(a.selected || 'ãªã—')}</p>
    <p><strong>æ­£ã—ã„ç­”ãˆ:</strong> ${a.correctAnswer ? a.correctAnswer.map(x=>escapeHtml(x)).join(' / ') : ''}</p>
    <p style="color:${color}; font-weight:bold;">${status}</p>
  </div>`;
});



  html += `<div style="text-align:right; margin-top:12px;">
      <button class="btn-plain btn-primary" id="back-result-btn">çµæœç”»é¢ã«æˆ»ã‚‹</button>
    </div></div>`;
  document.getElementById('content').innerHTML = html;
  const backBtn = document.getElementById('back-result-btn');
  if(backBtn) backBtn.addEventListener('click', ()=> {
    // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆçµæœã®æ•°å€¤ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ®‹ã£ã¦ã„ã‚‹ï¼‰
    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;
    let rank = "ãƒãƒ¼ãƒãƒ«";
    let rankColor = "#2c3e50";
    if(obtainedScore > 80){ rank = "ãƒ—ãƒ©ãƒãƒŠ"; rankColor = "#bcd"; }
    else if(obtainedScore > 67){ rank = "ã‚´ãƒ¼ãƒ«ãƒ‰"; rankColor = "#ffd700"; }
    else if(obtainedScore > 52){ rank = "ã‚·ãƒ«ãƒãƒ¼"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 43){ rank = "ãƒ–ãƒ­ãƒ³ã‚º"; rankColor = "#cd7f32"; }

    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });
  });
}

function stopTest(){
  testActive = false;
  if(testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
  const el = document.getElementById('test-timer');
  if (el) el.classList.add('hidden');
}

// helper: escapeHtml to keep layout safe
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
// ===== ãƒ†ã‚¹ãƒˆå®Ÿè£…éƒ¨åˆ†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ã“ã“ã¾ã§ =====




    // ===== å•é¡Œä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰ & ç·¨é›†æ©Ÿèƒ½ =====
    async function loadPartsList(){
      try{
        const q = query(collection(db,'parts'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        let html = `<div class="card"><h2>å•é¡Œä¸€è¦§</h2>`;
        if (snap.empty) {
          html += `<div style="margin-top:12px;padding:12px;border:1px dashed #eef3f5;border-radius:8px;color:#666">ä¿å­˜ã•ã‚ŒãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        } else {
          snap.forEach(documentSnap => {
            const d = documentSnap.data();
            html += `<div class="part-item">
              <div style="font-weight:700">ID: ${documentSnap.id}</div>
              <div style="color:#555;margin-top:6px">${escapeHtml((d.passage||'').slice(0,200))}${(d.passage||'').length>200?'...':''}</div>
              <div style="margin-top:8px;">è¨­å•æ•°: ${(d.questions||[]).length}</div>
              <div class="part-actions">
                <button class="btn-plain btn-primary" data-action="edit" data-id="${documentSnap.id}">ç·¨é›†</button>
                <button class="btn-plain btn-danger" data-action="delete" data-id="${documentSnap.id}">å‰Šé™¤</button>
              </div>
            </div>`;
          });
        }
        html += `</div>`;
        document.getElementById('content').innerHTML = html;

        // attach handlers
        Array.from(document.querySelectorAll('button[data-action]')).forEach(b=>{
          b.addEventListener('click', async ()=>{
            const action = b.getAttribute('data-action');
            const id = b.getAttribute('data-id');
            if(action === 'delete'){
              if(confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
                try {
                  await deleteDoc(doc(db,'parts',id));
                  alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                  loadPartsList(); // immediate refresh
                } catch(err) {
                  console.error(err);
                  alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
                }
              }
            } else if(action === 'edit'){
              editPart(id);
            }
          });
        });
      }catch(err){
        console.error(err);
        alert('ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // editPart: load doc and render create-form populated, then update on save
    async function editPart(id){
      try{
        const docRef = doc(db,'parts',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('è©²å½“ã®PartãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const d = snap.data();

        // render same create form but we fill values and change save handler to update
        document.getElementById('content').innerHTML = `
          <div class="card">
            <h2>å•é¡Œç·¨é›†</h2>
            <div>
              <label>è‹±æ–‡ï¼ˆPassageï¼‰</label>
              <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
            </div>
            <div id="questions-area" style="margin-top:12px;"></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <button id="add-question" class="btn-plain btn-primary">è¨­å•ã‚’è¿½åŠ </button>
              <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">å¤‰æ›´ã‚’ä¿å­˜</button>
            </div>
          </div>
        `;
        document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
        // populate
        document.getElementById('part-passage').value = d.passage || '';
        const qArea = document.getElementById('questions-area');
        qArea.innerHTML = '';
        (d.questions || []).forEach(qobj=>{
          const div = document.createElement('div');
          div.className = 'q-block';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>è¨­å•</strong>
              <div>
                <button class="btn-plain btn-danger btn-delete-q" type="button">è¨­å•ã‚’å‰Šé™¤</button>
              </div>
            </div>
            <input class="q-text" type="text" placeholder="è¨­å•æ–‡ã‚’å…¥åŠ›" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
            <div class="choices-area" style="margin-top:8px;"></div>
            <div style="margin-top:6px;">
              <button class="btn-plain btn-secondary btn-add-choice" type="button">é¸æŠè‚¢ã‚’è¿½åŠ </button>
            </div>
          `;
          qArea.appendChild(div);
          div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
          div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
          div.querySelector('.q-text').value = qobj.text || '';
          const choicesArea = div.querySelector('.choices-area');
          choicesArea.innerHTML = '';
          (qobj.choices || []).forEach(ch=>{
            addChoiceRow(div, { text: ch.text, score: ch.score, correct: ch.correct });
          });
        });

        // save (update) handler
        const saveBtn = document.getElementById('save-part');
        const handler = async ()=>{
          const passage = document.getElementById('part-passage').value.trim();
          const questions = [];
          document.querySelectorAll('.q-block').forEach(q=>{
            const text = q.querySelector('.q-text').value.trim();
            const choices = [];
            q.querySelectorAll('.choice-row').forEach(c=>{
              const chText = c.querySelector('.choice-text').value.trim();
              const chScore = Number(c.querySelector('.choice-score').value || 0);
              const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
              choices.push({ text: chText, score: chScore, correct: chCorrect });
            });
            if(text) questions.push({ text, choices });
          });
          if(questions.length===0){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          try{
            await updateDoc(docRef, { passage, questions, updatedAt: new Date() });
            alert('æ›´æ–°ã—ã¾ã—ãŸ');
            loadPartsList(); // immediate reflect in list
          }catch(err){
            console.error(err);
            alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message||err));
          } finally {
            saveBtn.removeEventListener('click', handler);
          }
        };
        saveBtn.addEventListener('click', handler);

      }catch(err){
        console.error(err);
        alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

/* ================= æ–‡æ³•ç‰¹è¨“ï¼ˆç®¡ç†è€…ä½œæˆ + å­¦ç¿’è€…å‘ã‘ 50 å•ç‰¹è¨“ï¼‰ ================= */

// === æ–‡æ³•ç‰¹è¨“ç”¨ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰ ===
let grammarTimerInterval = null;
let grammarRemaining = 0;

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆ#test-timer ã‚’ä½¿ã†ï¼‰
function updateGrammarTimer(){
  const el = document.getElementById('test-timer');
  if(!el) return;
  const mm = String(Math.floor(grammarRemaining / 60)).padStart(2,'0');
  const ss = String(grammarRemaining % 60).padStart(2,'0');
  el.textContent = `æ–‡æ³•æ®‹ã‚Š: ${mm}:${ss}`;
}

// ----- ãƒãƒŠãƒæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼ -----
// users/<userid>.banapo ã«åŠ ç®—ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…
async function addBanapo(amount){
  if(!currentUser || !currentUser.id) return;
  amount = Number(amount || 0);
  if(amount <= 0) return;
  try{
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    if(snap.exists()){
      const d = snap.data();
      const cur = Number(d.banapo || 0) || 0;
      await updateDoc(uRef, { banapo: cur + amount });
    } else {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã‘ã‚Œã°ä½œã‚‹ï¼ˆmergeã§ä»–é …ç›®ã‚’å£Šã•ãªã„ï¼‰
      await setDoc(uRef, { username: currentUser.id, banapo: amount }, { merge: true });
    }
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºãŒã‚ã‚Œã°æ›´æ–°
    if(typeof refreshHeaderBanapoDisplay === 'function') {
      try { refreshHeaderBanapoDisplay(); } catch(e){ /* ignore */ }
    } else {
      // äº’æ›æ€§ã®ãŸã‚ã€ã„ãã¤ã‹ã®IDã‚’è©¦ã—ã¦æ›´æ–°
      const el = document.getElementById('banapo-amount') || document.getElementById('banapo-display') || document.getElementById('banapo-val') || document.getElementById('banapo-number');
      if(el){
        // éåŒæœŸã«æœ€æ–°å€¤ã‚’å–ã‚Šã«è¡Œã
        const snap2 = await getDoc(uRef);
        const newVal = snap2.exists() ? Number(snap2.data().banapo || 0) : 0;
        el.textContent = `${newVal} bnp`;
      }
    }
  }catch(err){
    console.warn('addBanapo error', err);
  }
}

// ----- ç®¡ç†ç”¨ç”»é¢ï¼ˆãã®ã¾ã¾ï¼‰ -----
async function renderGrammarAdminHome(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•å•é¡Œä½œæˆï¼ˆç®¡ç†è€…ï¼‰</h2>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-add-card">
          <h3>è¿½åŠ ä½œæˆ</h3>
          <p>æ–°ã—ã„æ–‡æ³•å•é¡Œã‚’è¿½åŠ ã—ã¾ã™</p>
        </div>
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-edit-card">
          <h3>ç·¨é›† / å‰Šé™¤</h3>
          <p>æ—¢å­˜å•é¡Œã‚’ä¸€è¦§ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã—ã¾ã™</p>
        </div>
      </div>
    </div>
  `;
  document.getElementById('grammar-add-card').addEventListener('click', renderGrammarAddForm);
  document.getElementById('grammar-edit-card').addEventListener('click', renderGrammarEditList);
}

function sanitizeCsvToArray(s){
  if(!s) return [];
  return s.split(',').map(x=>x.trim()).filter(Boolean);
}

function renderGrammarAddForm(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•å•é¡Œã‚’è¿½åŠ </h2>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label>å½¢å¼:
          <select id="g-type">
            <option value="multiple">æŠä¸€ (multiple)</option>
            <option value="reorder">ä¸¦ã¹æ›¿ãˆ (reorder)</option>
            <option value="fill">é©èªè£œå…… (fill)</option>
            <option value="translate">å’Œæ–‡è‹±è¨³ (translate)</option>
          </select>
        </label>
        <label>è¨­å•æ–‡:<br>
  <textarea id="g-question" rows="4" style="width:100%; padding:8px; resize:vertical;"></textarea>
</label>
        <label id="label-choices">é¸æŠè‚¢ / å˜èª (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<br><textarea id="g-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
        <label>æ­£è§£ (ä¸¦ã³ãƒ»å˜èªã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§):<br><input type="text" id="g-answer" style="width:100%; padding:8px;" /></label>
        <label>ã‚¹ã‚³ã‚¢:<br><input type="number" id="g-score" value="1" style="width:120px; padding:6px;" /></label>
        <div style="display:flex;gap:8px;">
          <button id="g-save" class="btn-plain btn-primary">ä¿å­˜</button>
          <button id="g-cancel" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div style="font-size:12px;color:#666">
          â€»ã€Œä¸¦ã¹æ›¿ãˆã€ã¯ choices ã«ã‚«ãƒ¼ãƒ‰ã®èªã‚’ã€answer ã«æ­£ã—ã„é †ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥ã‚Œã¦ãã ã•ã„ã€‚<br>
          â€»ã€Œé©èªè£œå……ã€ã€Œå’Œæ–‡è‹±è¨³ã€ã¯ answer ã«æ­£ç­”æ–‡å­—åˆ—ï¼ˆè¤‡æ•°å¯ï¼‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã€‚
        </div>
      </div>
    </div>
  `;

  // ä¿å­˜
  document.getElementById('g-save').addEventListener('click', async ()=>{
    const type = document.getElementById('g-type').value;
    const question = (document.getElementById('g-question')||{value:''}).value.trim();
    const choices = sanitizeCsvToArray((document.getElementById('g-choices')||{value:''}).value);
    const answer = sanitizeCsvToArray((document.getElementById('g-answer')||{value:''}).value);
    const score = Number((document.getElementById('g-score')||{value:1}).value) || 1;
    if(!question){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    try{
      await addDoc(collection(db,'grammarQuestions'), {
        type, question, choices, answer, score, createdBy: currentUser ? currentUser.id : 'unknown', createdAt: new Date()
      });
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      renderGrammarAdminHome();
    }catch(err){
      console.error('grammar save err', err);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  });

  document.getElementById('g-cancel').addEventListener('click', ()=> renderGrammarAdminHome());
}

async function renderGrammarEditList(){
  try{
    const q = query(collection(db,'grammarQuestions'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    let html = `<div class="card"><h2>æ–‡æ³•å•é¡Œ ä¸€è¦§ï¼ˆç·¨é›†ï¼‰</h2>`;
    if(snap.empty){
      html += `<div style="padding:12px;color:#666">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    } else {
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        html += `<div style="border:1px solid #eef3f5;padding:8px;margin-top:8px;border-radius:6px;">
          <div><strong>${escapeHtml(d.type||'')}</strong> â€” ${escapeHtml((d.question||'').slice(0,200))}</div>
          <div style="margin-top:6px;font-size:13px;color:#666">ã‚¹ã‚³ã‚¢: ${escapeHtml(String(d.score||'' || ''))} â€¢ ä½œæˆè€…: ${escapeHtml(d.createdBy||'')}</div>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button class="btn-plain btn-primary" data-action="edit" data-id="${docSnap.id}">ç·¨é›†</button>
            <button class="btn-plain btn-danger" data-action="delete" data-id="${docSnap.id}">å‰Šé™¤</button>
          </div>
        </div>`;
      });
    }
    html += `</div>`;
    document.getElementById('content').innerHTML = html;

    Array.from(document.querySelectorAll('button[data-action]')).forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if(action === 'delete'){
          if(!confirm('å‰Šé™¤ã—ã¦ã‚ˆã„ã§ã™ã‹ï¼Ÿ')) return;
          try{
            await deleteDoc(doc(db,'grammarQuestions',id));
            alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            renderGrammarEditList();
          }catch(err){ console.error(err); alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        } else if(action === 'edit'){
          openGrammarEditForm(id);
        }
      });
    });

  }catch(err){
    console.error('renderGrammarEditList err', err);
    alert('ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

async function openGrammarEditForm(id){
  try{
    const docRef = doc(db,'grammarQuestions',id);
    const snap = await getDoc(docRef);
    if(!snap.exists()){ alert('è©²å½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    const d = snap.data();
    document.getElementById('content').innerHTML = `
      <div class="card">
        <h2>ç·¨é›†: ${escapeHtml(d.question||'')}</h2>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label>å½¢å¼:
            <select id="eg-type">
              <option value="multiple">multiple</option>
              <option value="reorder">reorder</option>
              <option value="fill">fill</option>
              <option value="translate">translate</option>
            </select>
          </label>
          <label>è¨­å•æ–‡:<br>
  <textarea id="eg-question" rows="4" style="width:100%;padding:8px; resize:vertical;"></textarea>
</label>
          <label>é¸æŠè‚¢ / å˜èª (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<textarea id="eg-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
          <label>æ­£è§£ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<input id="eg-answer" style="width:100%;padding:8px;" /></label>
          <label>ã‚¹ã‚³ã‚¢:<input id="eg-score" type="number" style="width:120px;padding:6px;" /></label>
          <div style="display:flex;gap:8px;">
            <button id="eg-save" class="btn-plain btn-primary">ä¿å­˜</button>
            <button id="eg-cancel" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    `;
    // populate
    document.getElementById('eg-type').value = d.type || 'multiple';
    document.getElementById('eg-question').value = d.question || '';
    document.getElementById('eg-choices').value = (d.choices||[]).join(', ');
    document.getElementById('eg-answer').value = (d.answer||[]).join(', ');
    document.getElementById('eg-score').value = d.score || 1;

    document.getElementById('eg-save').addEventListener('click', async ()=>{
      const type = document.getElementById('eg-type').value;
      const question = document.getElementById('eg-question').value.trim();
      const choices = sanitizeCsvToArray(document.getElementById('eg-choices').value);
      const answer = sanitizeCsvToArray(document.getElementById('eg-answer').value);
      const score = Number(document.getElementById('eg-score').value) || 1;
      if(!question){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{
        await updateDoc(docRef, { type, question, choices, answer, score, updatedAt: new Date() });
        alert('æ›´æ–°ã—ã¾ã—ãŸ');
        renderGrammarEditList();
      }catch(err){ console.error(err); alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    });
    document.getElementById('eg-cancel').addEventListener('click', renderGrammarEditList);

  }catch(err){
    console.error(err);
    alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/* ===== å­¦ç¿’è€…å‘ã‘: æ–‡æ³•ç‰¹è¨“ï¼ˆ50å•ãƒ©ãƒ³ãƒ€ãƒ ãƒ»é‡è¤‡ãªã—ï¼‰ ===== */
async function startGrammarTraining(){
  try{
    const snap = await getDocs(collection(db,'grammarQuestions'));
    let questions = [];
    snap.forEach(s => questions.push({ id: s.id, ...s.data() }));
    if(questions.length === 0){ alert('æ–‡æ³•å•é¡ŒãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    questions = questions.sort(()=>Math.random()-0.5).slice(0,50);

    // çŠ¶æ…‹
    let idx = 0;
    let score = 0;
    const answersRecord = [];
    const startTime = Date.now();

    // UI: show timer in header
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.remove('hidden');

    // disable menus while training
    disableMenus(true);

    // --- ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–ï¼ˆ5åˆ† = 300ç§’ï¼‰ ---
    grammarRemaining = 5 * 60;
    updateGrammarTimer();
    if(grammarTimerInterval) { clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    grammarTimerInterval = setInterval(()=> {
      grammarRemaining--;
      updateGrammarTimer();
      if(grammarRemaining <= 0){
        // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—: å¼·åˆ¶çµ‚äº†
        // move index to end and renderQ once (renderQ will handle save & cleanup)
        idx = questions.length;
        try { renderQ(); } catch(e){ /* ignore */ }
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
      }
    }, 1000);

    // render é–¢æ•°
    async function renderQ(){
      // çµ‚äº†åˆ†å²
      if(idx >= questions.length){
        // clear timer & hide
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
        if(testTimerEl) testTimerEl.classList.add('hidden');
        // allow menus again
        disableMenus(false);

        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        // ä¿å­˜ï¼ˆçµæœã‚’ DB ã«è¿½åŠ ã—ã€ãƒãƒŠãƒã‚’åŠ ç®—ï¼‰
        await saveGrammarResult(score, elapsed, answersRecord);
        // è¡¨ç¤º
        renderGrammarResult(score, elapsed, answersRecord);
        return;
      }

      const q = questions[idx];
      let html = `
        <div class="card">
          <h2>Q${idx+1}/${questions.length}</h2>
          <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(q.question||'')}</div>
          <div style="margin-top:12px;" id="g-body"></div>
          <div style="margin-top:12px;text-align:right;">
            <button class="btn-plain" id="g-skip">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button class="btn-plain btn-primary" id="g-submit">å›ç­”</button>
          </div>
        </div>
      `;
      document.getElementById('content').innerHTML = html;

      const body = document.getElementById('g-body');

      if(q.type === 'multiple'){
        // ãƒ©ã‚¸ã‚ªã§è¡¨ç¤º
        (q.choices || []).forEach((c, i)=>{
          const div = document.createElement('div');
          div.innerHTML = `<label><input type="radio" name="g-choice" value="${escapeHtml(c)}" data-correct="${(q.answer||[]).includes(c) ? 'true' : 'false'}" data-score="${q.score||1}"> ${escapeHtml(c)}</label>`;
          body.appendChild(div);
        });
      } else if(q.type === 'reorder'){
        // ----- ä¸¦ã¹æ›¿ãˆ UI: èªç¾¤ï¼ˆå¯é¸ï¼‰ ã¨ è§£ç­”æ¬„ï¼ˆé»’æ ï¼‰ ã‚’åˆ†ã‘ã¦è¡¨ç¤º -----
        const avail = document.createElement('div');
        avail.id = 'g-avail';
        avail.style.display = 'flex';
        avail.style.flexWrap = 'wrap';
        avail.style.gap = '6px';
        avail.style.marginBottom = '8px';

        (q.choices || []).forEach((w,i)=>{
          const b = document.createElement('button');
          b.className = 'btn-plain';
          b.type = 'button';
          b.textContent = w;
          b.dataset.word = w;
          b.style.cursor = 'pointer';
          b.addEventListener('click', ()=> {
            const picked = document.getElementById('g-picked');
            const newb = document.createElement('button');
            newb.className = 'btn-plain';
            newb.type = 'button';
            newb.textContent = w;
            newb.dataset.word = w;
            newb.style.cursor = 'pointer';
            newb.addEventListener('click', ()=> {
              const availEl = document.getElementById('g-avail');
              if(availEl) availEl.appendChild(b);
              const pickedEl = document.getElementById('g-picked');
              if(pickedEl) pickedEl.removeChild(newb);
            });
            const pickedEl = document.getElementById('g-picked');
            if(pickedEl) pickedEl.appendChild(newb);
            if(b.parentElement) b.parentElement.removeChild(b);
          });
          avail.appendChild(b);
        });

        const picked = document.createElement('div');
        picked.id = 'g-picked';
        picked.style.minHeight = '40px';
        picked.style.display = 'flex';
        picked.style.flexWrap = 'wrap';
        picked.style.gap = '6px';
        picked.style.border = '2px solid #000';
        picked.style.padding = '8px';
        picked.style.marginTop = '8px';
        picked.style.background = '#fff';

        const resetWrap = document.createElement('div');
        resetWrap.style.marginTop = '8px';
        resetWrap.innerHTML = `<button class="btn-plain" id="g-reset">ãƒªã‚»ãƒƒãƒˆ</button>`;

        body.appendChild(document.createElement('div'));
        body.appendChild(avail);
        body.appendChild(resetWrap);
        body.appendChild(picked);

        document.getElementById('g-reset').addEventListener('click', ()=> {
          const pickedEl = document.getElementById('g-picked');
          const availEl = document.getElementById('g-avail');
          if(!pickedEl || !availEl) return;
          while(pickedEl.firstChild){
            const nb = pickedEl.firstChild;
            const w = nb.dataset.word;
            const ob = document.createElement('button');
            ob.className = 'btn-plain';
            ob.type = 'button';
            ob.textContent = w;
            ob.dataset.word = w;
            ob.style.cursor = 'pointer';
            ob.addEventListener('click', ()=> {
              const newb = document.createElement('button');
              newb.className = 'btn-plain';
              newb.type = 'button';
              newb.textContent = w;
              newb.dataset.word = w;
              newb.style.cursor = 'pointer';
              newb.addEventListener('click', ()=> {
                pickedEl.removeChild(newb);
                availEl.appendChild(ob);
              });
              pickedEl.appendChild(newb);
              availEl.removeChild(ob);
            });
            availEl.appendChild(ob);
            pickedEl.removeChild(nb);
          }
        });

      } else if(q.type === 'fill'){
        body.innerHTML = `<input type="text" id="g-fill" style="width:100%;padding:8px;" placeholder="å˜èªã‚’å…¥åŠ›" />`;
      } else if(q.type === 'translate'){
        body.innerHTML = `<textarea id="g-translate" style="width:100%;padding:8px;" rows="4" placeholder="è‹±æ–‡ã‚’å…¥åŠ›"></textarea>`;
      }

      // ã‚¹ã‚­ãƒƒãƒ—
      document.getElementById('g-skip').addEventListener('click', ()=> {
        answersRecord.push({
  question: q.question,
  selected: null,        // çµ±ä¸€ã‚­ãƒ¼å
  isCorrect: false,      // æœªè§£ç­”ã¯ false
  score: 0,
  correctAnswer: q.answer || []
});
        idx++;
        renderQ();
      });

      // æå‡º
      document.getElementById('g-submit').addEventListener('click', ()=> {
        let userAns = null;
        let correct = false;
        let addScore = 0;
        if(q.type === 'multiple'){
          const sel = document.querySelector('input[name="g-choice"]:checked');
          if(sel){
            userAns = sel.value;
            correct = (sel.dataset.correct === 'true');
            addScore = correct ? Number(sel.dataset.score||q.score||1) : 0;
          } else {
            userAns = null;
            correct = false;
            addScore = 0;
          }
        } else if(q.type === 'reorder'){
          const pickedEl = document.getElementById('g-picked');
          const arr = Array.from(pickedEl.children).map(b => b.dataset.word);
          userAns = arr;
          const target = q.answer || [];
          const eq = (a,b) => a.length===b.length && a.every((v,i)=>String(v).trim() === String(b[i]).trim());
          correct = eq(arr, target);
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'fill'){
          const v = (document.getElementById('g-fill')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'translate'){
          const v = (document.getElementById('g-translate')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        }

        answersRecord.push({
  question: q.question,
  selected: userAns,          // é¸ã‚“ã å€¤ï¼ˆæ–‡å­—åˆ— or é…åˆ—ï¼‰
  isCorrect: !!correct,       // çœŸå½ã‚’æ˜ç¤º
  score: addScore,
  correctAnswer: q.answer || []
});
        score += addScore;

        // ï¼ˆé‡è¦ï¼‰ã“ã“ã§ã¯å€‹åˆ¥ã«ãƒãƒŠãƒåŠ ç®—ã—ãªã„ã€‚çµ‚äº†æ™‚ã«åˆè¨ˆã§åŠ ç®—ã™ã‚‹ã€‚
        idx++;
        renderQ();
      });

    } // renderQ é–¢æ•° end

    // æœ€åˆã‚’è¡¨ç¤º
    renderQ();

  }catch(err){
    console.error('startGrammarTraining err', err);
    alert('æ–‡æ³•ç‰¹è¨“ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err));
    // å®‰å…¨å‡¦ç†
    if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.add('hidden');
    disableMenus(false);
  }
}

// ä¿å­˜ï¼ˆçµæœã‚’ DB ã«è¿½åŠ ã—ã€ãƒãƒŠãƒã‚’åŠ ç®—ï¼‰
// æ—¢å­˜ã® saveGrammarResult ã¨ç½®ãæ›ãˆã¦ãã ã•ã„
async function saveGrammarResult(score, elapsedSec, answersRecord){
  try{
    const uid = currentUser ? currentUser.id : 'guest';
    // results ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€äº’æ›æ€§ã®ãŸã‚ã« testType ã¨ type ã®ä¸¡æ–¹ã‚’å…¥ã‚Œã¦ãŠã
    await addDoc(collection(db,'results'), {
      uid,
      type: 'æ–‡æ³•ç‰¹è¨“',
      testType: 'grammar',
      score,
      elapsed: elapsedSec,
      answers: answersRecord,
      createdAt: new Date()
    });
    // çµ‚äº†æ™‚ã«ä¸€åº¦ã ã‘ãƒãƒŠãƒã‚’åŠ ç®—ï¼ˆã‚¹ã‚³ã‚¢ã‚’ãã®ã¾ã¾åŠ ç®—ï¼‰
    try { 
      if(typeof addBanapo === 'function') {
        await addBanapo(score);
      }
    } catch(e){ console.warn('addBanapo at end failed', e); }
  }catch(err){
    console.warn('saveGrammarResult failed', err);
  }
}

// çµæœè¡¨ç¤º
function renderGrammarResult(score, elapsedSec, answersRecord){
  // çµæœç”»é¢ã‚’æç”»
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•ç‰¹è¨“ çµæœ</h2>
      <p>ç²å¾—ã‚¹ã‚³ã‚¢: ${score}</p>
      <p>çµŒéç§’æ•°: ${elapsedSec} ç§’</p>
      <div style="text-align:right;margin-top:12px;">
        <button id="g-to-home" class="btn-plain">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        <button id="g-review" class="btn-plain btn-primary">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  `;

  // ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
  const toHomeBtn = document.getElementById('g-to-home');
  if(toHomeBtn){
    toHomeBtn.addEventListener('click', ()=> {
      if(typeof renderHome === 'function') renderHome();
      else document.getElementById('content').innerHTML = `<div class="card"><h2>ãƒ›ãƒ¼ãƒ </h2></div>`;
    });
  }

  // ã€Œè©³ç´°ã‚’è¦‹ã‚‹ã€
  const reviewBtn = document.getElementById('g-review');
  if(reviewBtn){
    reviewBtn.addEventListener('click', async ()=> {
      try {
        // æœ€æ–°ã®è‡ªåˆ†ã®çµæœã‚’å–å¾—
        const qSnap = await getDocs(query(collection(db,'results'), orderBy('createdAt','desc')));
        let found = null;
        qSnap.forEach(docSnap=>{
          if(found) return;
          const d = docSnap.data();
          if(d.uid !== (currentUser ? currentUser.id : 'guest')) return;
          if((d.testType && d.testType === 'grammar') || (d.type && d.type === 'æ–‡æ³•ç‰¹è¨“')){
            found = { id: docSnap.id, data: d };
          }
        });

        if(!found){ alert('è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

        // answers ã‚’æ­£è¦åŒ–ã—ã¦è¡¨ç¤º
        const arr = Array.isArray(found.data.answers) ? found.data.answers : [];

        function _normalizeAnswer(a){
          if(!a) return { question:'', selected:null, isCorrect:false, score:0, correctAnswer:[] };
          const question = a.question || a.q || '';
          const selected = ('selected' in a) ? a.selected
                        : ('userAnswer' in a) ? a.userAnswer
                        : ('selectedAnswer' in a) ? a.selectedAnswer
                        : null;
          const isCorrect = ('isCorrect' in a) ? !!a.isCorrect
                         : ('correct' in a) ? !!a.correct
                         : false;
          const correctAnswer = a.correctAnswer || a.correctAnswers || a.answer || a.correct || [];
          return {
            question,
            selected,
            isCorrect,
            score: a.score || 0,
            correctAnswer: Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)]
          };
        }

        let html = `<div class="card"><h2>æ–‡æ³•ç‰¹è¨“ï¼šè©³ç´°</h2>`;
        arr.forEach((raw,i)=>{
          const n = _normalizeAnswer(raw);
          const isUnanswered = (
            n.selected === null ||
            n.selected === undefined ||
            (typeof n.selected === 'string' && n.selected.trim() === '') ||
            (Array.isArray(n.selected) && n.selected.length === 0)
          );
          let statusText, color;
          if(isUnanswered){
            statusText = 'æœªè§£ç­”';
            color = 'gray';
          } else if(n.isCorrect){
            statusText = 'â­• æ­£è§£';
            color = 'green';
          } else {
            statusText = 'âŒ ä¸æ­£è§£';
            color = 'red';
          }

          const yourAnsDisplay = Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'ãªã—');
          const correctAnsDisplay = (n.correctAnswer || []).map(x => escapeHtml(String(x))).join(' / ');

          html += `<div style="margin:6px 0;padding:8px;border-left:4px solid ${color};">
            <p><strong>Q${i+1}:</strong> ${escapeHtml(n.question||'')}</p>
            <p>ã‚ãªãŸã®è§£ç­”: ${escapeHtml(yourAnsDisplay)}</p>
            <p>æ­£ç­”: ${correctAnsDisplay}</p>
            <p style="color:${color};font-weight:bold">${statusText}</p>
          </div>`;
        });
        html += `<div style="text-align:right;margin-top:12px;">
          <button id="back-to-results" class="btn-plain btn-primary">çµæœã¸æˆ»ã‚‹</button>
        </div></div>`;

        // è©³ç´°ç”»é¢ã‚’æç”»
        document.getElementById('content').innerHTML = html;

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        const backBtn = document.getElementById('back-to-results');
        if(backBtn){
          backBtn.addEventListener('click', ()=> {
            renderGrammarResult(found.data.score, found.data.elapsed, found.data.answers || []);
          });
        }

      } catch(err){
        console.error('g review err', err);
        alert('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err));
      }
    });
  }
}


/* ================= end: æ–‡æ³•ç‰¹è¨“ ================= */





    // ===== åˆè¡¨ç¤ºã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ˆä½•ã‚‚å¤‰æ›´ã—ãªã„ï¼‰ =====
    // end of module

    // â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ : ã€Œstart-speedã€ãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«æ‹¾ã†ãƒãƒ³ãƒ‰ãƒ©ï¼ˆæœ€å°è¿½åŠ éƒ¨åˆ†ï¼‰ â˜…â˜…
    document.addEventListener('click', async (e) => {
      try {
        if (e.target && e.target.id === 'start-speed') {
          console.log('[debug] start-speed clicked');
          if (confirm('ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚åˆ¶é™æ™‚é–“ã¯15åˆ†ã§ã™ã€‚')) {
            if (typeof startTest === 'function') {
              await startTest();
            } else {
              console.error('startTest is not defined');
              alert('å†…éƒ¨ã‚¨ãƒ©ãƒ¼: startTestãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
          }
        }
      } catch (err) {
        console.error('start-speed handler error', err);
        alert('ãƒ†ã‚¹ãƒˆé–‹å§‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err));
      }
    });
    // â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…

    /* ============== ã“ã“ã‹ã‚‰æ–°è¦è¿½åŠ : ãƒ›ãƒ¼ãƒ ç”»é¢ã¨ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ ============== */
    /* è¿½åŠ ãƒãƒªã‚·ãƒ¼:
       - ã²ãªå½¢A1 ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ï¼ˆä¸Šæ›¸ãã€å‰Šé™¤ãªã—ï¼‰ã€‚
       - ä»¥ä¸‹ã¯ã€Œè¿½åŠ å®Ÿè£…ã€ã®ã¿ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«æ—¢å­˜ã® showMain() ã®å‹•ä½œã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚
       - Firestore ã« notices ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ :
         { title, body, createdBy, createdAt }
    */

    // ãƒ©ãƒƒãƒ—ã—ã¦å…ƒã® showMain ã‚’æ‹¡å¼µ: ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹
    if (typeof showMain === 'function') {
      const __orig_showMain = showMain;
      showMain = function(...args){
        __orig_showMain.apply(this, args);
        // è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤º
        renderHome();
      };
    }

    // ãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
    const logoEl = document.querySelector('.logo');
    if (logoEl) {
      logoEl.style.cursor = 'pointer';
      logoEl.addEventListener('click', (e) => {
        e.preventDefault();
        renderHome();
      });
    }

    // ãƒ›ãƒ¼ãƒ ç”»é¢æç”»
    function renderHome(){
      // ãƒ›ãƒ¼ãƒ ã¯ã€ŒãŠã—ã‚‰ã›ã€ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ
      document.getElementById('content').innerHTML = `
        <div class="card">
          <h2>ãƒ›ãƒ¼ãƒ </h2>
          <p>ã‚ˆã†ã“ãã€${currentUser ? escapeHtml(currentUser.nickname || currentUser.id) : 'ã‚²ã‚¹ãƒˆ'} ã•ã‚“ã€‚</p>
        </div>
        <div class="card" id="notices-card">
          <h3>ãŠã—ã‚‰ã›</h3>
          <div id="notices-list" style="margin-top:12px;"></div>
          <div id="notice-admin-controls" style="margin-top:12px;"></div>
        </div>
      `;
      loadNotices(); // æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
      renderNoticeAdminControlsIfAllowed();
    }

    // ç®¡ç†è€…ãªã‚‰æŠ•ç¨¿UIã‚’è¡¨ç¤º
    function renderNoticeAdminControlsIfAllowed(){
      const ctrl = document.getElementById('notice-admin-controls');
      if(!ctrl) return;
      ctrl.innerHTML = '';
      if(currentUser && currentUser.role === 'admin'){
        // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
        ctrl.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="new-notice-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%" />
            <textarea id="new-notice-body" placeholder="æœ¬æ–‡" rows="4" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%"></textarea>
            <div style="display:flex;gap:8px">
              <button id="btn-create-notice" class="btn-plain btn-primary">æŠ•ç¨¿</button>
              <button id="btn-refresh-notice" class="btn-plain">æ›´æ–°</button>
            </div>
          </div>
        `;
        document.getElementById('btn-create-notice').addEventListener('click', createNotice);
        document.getElementById('btn-refresh-notice').addEventListener('click', loadNotices);
      } else {
        // éç®¡ç†è€…å‘ã‘ã«ã¯ä½•ã‚‚ã—ãªã„ï¼ˆé–²è¦§ã®ã¿ï¼‰
        ctrl.innerHTML = '';
      }
    }

    // notices ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    async function loadNotices(){
      try{
        const q = query(collection(db,'notices'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        const listEl = document.getElementById('notices-list');
        if(!listEl) return;
        if(snap.empty){
          listEl.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          return;
        }
        let html = '';
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : (d.createdAt ? new Date(d.createdAt) : null);
          const dateStr = createdAt ? createdAt.toLocaleString() : '';
          html += `<div style="padding:12px;border-bottom:1px solid #f0f4f6;margin-bottom:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">${escapeHtml(d.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>
                <div style="font-size:12px;color:#666">${escapeHtml(d.createdBy||'')}${dateStr? ' â€¢ ' + escapeHtml(dateStr):''}</div>
              </div>
              <div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(d.body||'')}</div>
              <div style="margin-top:8px;" data-notice-id="${docSnap.id}"></div>
            </div>`;
        });
        listEl.innerHTML = html;

        // è¿½åŠ : ç®¡ç†è€…ã¯å„ãŠçŸ¥ã‚‰ã›ã«ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if(currentUser && currentUser.role === 'admin'){
          const noticeWrappers = listEl.querySelectorAll('div[data-notice-id]');
          noticeWrappers.forEach(wrapper=>{
            const id = wrapper.getAttribute('data-notice-id');
            wrapper.innerHTML = `
              <div style="display:flex;gap:8px">
                <button class="btn-plain" data-notice-action="edit" data-id="${id}">ç·¨é›†</button>
                <button class="btn-plain btn-danger" data-notice-action="delete" data-id="${id}">å‰Šé™¤</button>
              </div>
            `;
          });
          // attach actions
          Array.from(listEl.querySelectorAll('button[data-notice-action]')).forEach(b=>{
            b.addEventListener('click', async ()=>{
              const action = b.getAttribute('data-notice-action');
              const id = b.getAttribute('data-id');
              if(action === 'delete'){
                if(confirm('ãŠçŸ¥ã‚‰ã›ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
                  try{
                    await deleteDoc(doc(db,'notices',id));
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadNotices(); // å³æ™‚åæ˜ 
                  }catch(err){
                    console.error(err);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
                  }
                }
              } else if(action === 'edit'){
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
                openEditNoticeDialog(id);
              }
            });
          });
        }
      }catch(err){
        console.error(err);
        alert('ãŠçŸ¥ã‚‰ã›ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

    // ãŠçŸ¥ã‚‰ã›ä½œæˆ
    async function createNotice(){
      const title = (document.getElementById('new-notice-title') || {value:''}).value.trim();
      const body = (document.getElementById('new-notice-body') || {value:''}).value.trim();
      if(!title && !body){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{
        await addDoc(collection(db,'notices'), {
          title,
          body,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        // clear inputs
        document.getElementById('new-notice-title').value = '';
        document.getElementById('new-notice-body').value = '';
        // å³æ™‚åæ˜ 
        loadNotices();
        alert('æŠ•ç¨¿ã—ã¾ã—ãŸ');
      }catch(err){
        console.error(err);
        alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

    // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆç°¡æ˜“ï¼‰ã‚’å‡ºã—ã€æ›´æ–°ã™ã‚‹
    async function openEditNoticeDialog(id){
      try{
        const docRef = doc(db,'notices',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('è©²å½“ã®ãŠçŸ¥ã‚‰ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const d = snap.data();
        // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆDOMä¸Šã«ç”Ÿæˆï¼‰
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.left = '0';
        overlay.style.top = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = `
          <div style="background:#fff;padding:16px;border-radius:8px;max-width:720px;width:90%;">
            <h3>ãŠçŸ¥ã‚‰ã›ç·¨é›†</h3>
            <input id="edit-notice-title" style="width:100%;padding:8px;border:1px solid #d0d7dc;border-radius:6px" value="${escapeHtml(d.title||'')}" />
            <textarea id="edit-notice-body" rows="6" style="width:100%;margin-top:8px;padding:8px;border:1px solid #d0d7dc;border-radius:6px">${escapeHtml(d.body||'')}</textarea>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
              <button id="cancel-edit" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="save-edit" class="btn-plain btn-primary">ä¿å­˜</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('#cancel-edit').addEventListener('click', ()=> overlay.remove());
        overlay.querySelector('#save-edit').addEventListener('click', async ()=>{
          const newTitle = (overlay.querySelector('#edit-notice-title')||{value:''}).value.trim();
          const newBody = (overlay.querySelector('#edit-notice-body')||{value:''}).value.trim();
          try{
            await updateDoc(docRef, { title: newTitle, body: newBody, updatedAt: new Date() });
            alert('æ›´æ–°ã—ã¾ã—ãŸ');
            overlay.remove();
            loadNotices(); // å³æ™‚åæ˜ 
          }catch(err){
            console.error(err);
            alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
          }
        });
      }catch(err){
        console.error(err);
        alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

/* ===== è¿½åŠ æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± / éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ / å­¦ç¿’ã®è¨˜éŒ² ===== */

// storage ã®å‚ç…§ã¯å…ˆé ­ import ã§èª­ã¿è¾¼ã‚“ã§ã„ã‚‹æƒ³å®š (getStorage, storageRef, uploadBytes, getDownloadURL, deleteObject)
const storage = getStorage(app); // app ã¯æ—¢å­˜ã§åˆæœŸåŒ–æ¸ˆã¿

// ãƒ˜ãƒƒãƒ€ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆFirestore users/<userid> ã® nickname ã‚’ä½¿ç”¨ï¼‰
async function refreshHeaderNickname(){
  if(!currentUser) return;
  try {
    const uRef = doc(db, 'users', currentUser.id);
    const snap = await getDoc(uRef);
    let nickname = currentUser.id;
    if(snap.exists()){
      const data = snap.data();
      if(data && data.nickname) nickname = data.nickname;
    } else {
      // åˆå›: username ã‚’ nickname ã«ã‚»ãƒƒãƒˆ
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      nickname = currentUser.id;
    }
    currentUser.nickname = nickname;
    const nameEl = document.getElementById('user-name');
    if(nameEl) nameEl.textContent = nickname;
  } catch(err){
    console.error('refreshHeaderNickname error', err);
  }
}

// ----- ãƒãƒŠãƒé–¢é€£ -----
// storage ã¯åˆ¥é€”ï¼ˆæ—¢ã« app åˆæœŸåŒ–æ¸ˆã¿ï¼‰
// 1æ—¥ãƒœãƒ¼ãƒŠã‚¹ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼: YYYY-MM-DD æ–‡å­—åˆ—ã‚’è¿”ã™
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ãƒ˜ãƒƒãƒ€ãƒ¼ã® bnp è¡¨ç¤ºã‚’æ›´æ–°
async function refreshBnpDisplay(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let bnp = 0;
    if(snap.exists()){
      const data = snap.data();
      if(data && typeof data.bnp === 'number') bnp = data.bnp;
    } else {
      // åˆæœŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆusername / nickname ã¯æ—¢ã« set ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id, bnp: 0 }, { merge: true });
      bnp = 0;
    }
    // update UI
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(bnp);
    // also keep local copy
    currentUser.bnp = bnp;
  } catch(err){
    console.error('refreshBnpDisplay error', err);
  }
}

// bnp ã‚’åŠ ç®—ï¼ˆè² ã®å€¤ã§æ¸›ç®—ã‚‚å¯èƒ½ï¼‰
// returns the new bnp value (number)
async function addBnp(amount){
  try {
    if(!currentUser) return null;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let current = 0;
    if(snap.exists()){
      const data = snap.data();
      current = (data && typeof data.bnp === 'number') ? data.bnp : 0;
    }
    const next = current + Number(amount || 0);
    // ãƒãƒ¼ã‚¸ã§æ›¸ãæˆ»ã—
    await setDoc(uRef, { bnp: next }, { merge: true });
    // UI æ›´æ–°
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(next);
    currentUser.bnp = next;
    return next;
  } catch(err){
    console.error('addBnp error', err);
    return null;
  }
}

// ãƒ­ã‚°ã‚¤ãƒ³æ™‚ 1æ—¥ä¸€å›ãƒœãƒ¼ãƒŠã‚¹ +10bnpï¼ˆlastLoginBonus ã«æ—¥ä»˜ã‚’ä¿å­˜ï¼‰
async function creditDailyLoginBonusIfNeeded(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    const today = todayStr();
    let last = null;
    if(snap.exists()){
      const data = snap.data();
      last = data && data.lastLoginBonus ? data.lastLoginBonus : null;
    }
    if(last !== today){
      // give 10bnp
      await addBnp(10);
      // record the date
      await setDoc(uRef, { lastLoginBonus: today }, { merge: true });
      console.log('daily login bonus granted');
    } else {
      console.log('daily login bonus already granted today');
    }
  } catch(err){
    console.error('creditDailyLoginBonusIfNeeded error', err);
  }
}

// ----- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç”»é¢ -----
async function renderUserInfo(){
  if(!currentUser) return;
  const uRef = doc(db, 'users', currentUser.id);
  let data = {};
  try {
    const snap = await getDoc(uRef);
    if(snap.exists()) data = snap.data();
    else {
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      data = { username: currentUser.id, nickname: currentUser.id };
    }
  } catch(err){
    console.error('renderUserInfo load error', err);
    data = { username: currentUser.id, nickname: currentUser.id };
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
      <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</strong>: <span id="ui-username">${escapeHtml(data.username || currentUser.id)}</span></p>
      <p><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</strong>: <span id="ui-password">${escapeHtml(users[currentUser.id] ? users[currentUser.id].password : '')}</span></p>
      <p><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </strong>: <input id="ui-nickname" value="${escapeHtml(data.nickname || currentUser.id)}" /> <button id="ui-nickname-save" class="btn-plain btn-primary">ä¿å­˜</button></p>
    </div>
  `;

  document.getElementById('ui-nickname-save').addEventListener('click', async ()=>{
    const newNick = (document.getElementById('ui-nickname') || {value:''}).value.trim() || currentUser.id;
    try {
      await setDoc(uRef, { nickname: newNick }, { merge: true });
      currentUser.nickname = newNick;
      const nameEl = document.getElementById('user-name');
      if(nameEl) nameEl.textContent = newNick;
      alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch(err){
      console.error('save nickname error', err);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  });
}

// ----- éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ -----
async function renderAudioContent(){
  if(!currentUser) return;

  const isAdmin = currentUser.role === 'admin';
  const uploadUi = isAdmin ? `
    <div style="margin-bottom:12px;">
      <input type="text" id="audio-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" style="padding:6px;border-radius:6px;border:1px solid #d0d7dc;width:60%" />
      <input type="file" id="audio-file" accept="audio/mp3" style="margin-left:8px;" />
      <button id="audio-upload-btn" class="btn-plain btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  ` : '';

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
      ${uploadUi}
      <div id="audio-items">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  `;

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  if(isAdmin){
    document.getElementById('audio-upload-btn').addEventListener('click', async ()=>{
      const fileInput = document.getElementById('audio-file');
      const title = (document.getElementById('audio-title')||{value:''}).value.trim() || (fileInput.files[0] ? fileInput.files[0].name : 'ç„¡é¡Œ');
      if(!fileInput.files || fileInput.files.length === 0){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ (mp3)'); return; }
      const file = fileInput.files[0];
      if(file.type !== 'audio/mpeg' && !file.name.endsWith('.mp3')){ alert('mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      const storagePath = `audio/${Date.now()}_${file.name}`;
      try {
        const sRef = ref(storage, storagePath);
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        await addDoc(collection(db,'audio'), {
          title,
          path: storagePath,
          url,
          uploadedBy: currentUser.id,
          createdAt: new Date()
        });
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†');
        renderAudioContent();
      } catch(err){
        console.error('audio upload error', err);
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    });
  }

  // éŸ³å£°ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  try {
    const qAudio = query(collection(db,'audio'), orderBy('createdAt','desc'));
    const snap = await getDocs(qAudio);
    const container = document.getElementById('audio-items');
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }
    let html = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      html += `<div style="padding:8px 0;border-bottom:1px solid #f0f4f6;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(d.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>
            <div style="font-size:12px;color:#666">${escapeHtml(d.uploadedBy||'')} ${d.createdAt ? ' â€¢ ' + new Date(d.createdAt.seconds*1000).toLocaleString() : ''}</div>
          </div>
          <div>
            <button class="btn-plain play-audio-btn" data-url="${escapeHtml(d.url||'')}" data-id="${id}">å†ç”Ÿ</button>
            ${isAdmin ? `<button class="btn-plain btn-danger del-audio-btn" data-id="${id}">å‰Šé™¤</button>` : ''}
          </div>
        </div>
        <div class="audio-player" id="player-${id}" style="margin-top:8px;"></div>
      </div>`;
    });
    container.innerHTML = html;

    // å†ç”Ÿãƒœã‚¿ãƒ³
    Array.from(container.querySelectorAll('.play-audio-btn')).forEach(btn => {
      btn.addEventListener('click', (e)=>{
        const url = btn.getAttribute('data-url');
        const id = btn.getAttribute('data-id');
        const playerDiv = document.getElementById(`player-${id}`);
        if(playerDiv){
          playerDiv.innerHTML = `<audio controls src="${url}">ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</audio>`;
        }
      });
    });

    // ç®¡ç†è€…ã®å‰Šé™¤å‡¦ç†ï¼ˆFirestore doc ã¨ Storage ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ï¼‰
    if(isAdmin){
      Array.from(container.querySelectorAll('.del-audio-btn')).forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          if(!confirm('ã“ã®éŸ³å£°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          try {
            const dSnap = await getDoc(doc(db,'audio',id));
            if(dSnap.exists()){
              const d = dSnap.data();
              if(d && d.path){
                try {
                  const sRef = storageRef(storage, d.path);
                  await deleteObject(sRef); // storage ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤
                } catch(e){ console.warn('storage delete error', e); }
              }
            }
            await deleteDoc(doc(db,'audio',id));
            alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            renderAudioContent();
          } catch(err){
            console.error('delete audio error', err);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
          }
        });
      });
    }
  } catch(err){
    console.error('load audio list error', err);
    const container = document.getElementById('audio-items');
    if(container) container.innerHTML = `<div style="color:#666">éŸ³å£°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
  }
}

// ----- å­¦ç¿’ã®è¨˜éŒ²ï¼ˆèª­ã¿å–ã‚Šè¡¨ç¤ºã®é››å½¢ï¼‰ -----
async function renderStudyLog(){
  if(!currentUser) return;
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>å­¦ç¿’ã®è¨˜éŒ²</h2>
      <div id="studylog-list">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div style="margin-top:12px;">ï¼ˆè¨˜éŒ²ã®è¿½åŠ ã¯å¾Œã§æ‹¡å¼µã§ãã¾ã™ï¼‰</div>
    </div>
  `;
  try {
    const qLog = query(collection(db,'studyLogs'), orderBy('createdAt','desc'));
    const snap = await getDocs(qLog);
    const container = document.getElementById('studylog-list');
    if(snap.empty){ container.innerHTML = '<div style="color:#666">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
    let html = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      html += `<div style="padding:8px;border-bottom:1px solid #f0f4f6;">
        <div style="font-weight:700">${escapeHtml(d.title || 'å­¦ç¿’')}</div>
        <div style="font-size:13px;color:#666">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : ''} â€¢ ${escapeHtml(d.user||'')}</div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.note||'')}</div>
      </div>`;
    });
    container.innerHTML = html;
  } catch(err){
    console.error('renderStudyLog error', err);
    const container = document.getElementById('studylog-list');
    if(container) container.innerHTML = '<div style="color:#666">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// ----- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚’ç´ã¥ã‘ã‚‹ï¼ˆè¿½åŠ ã—ãŸ li ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼‰ -----
const menuUserInfoEl = document.getElementById('menu-userinfo');
if(menuUserInfoEl) menuUserInfoEl.addEventListener('click', ()=> { if(!testActive) renderUserInfo(); });

const menuAudioEl = document.getElementById('menu-audio');
if(menuAudioEl) menuAudioEl.addEventListener('click', ()=> { if(!testActive) renderAudioContent(); });

const menuStudyLogEl = document.getElementById('menu-studylog');
if(menuStudyLogEl) menuStudyLogEl.addEventListener('click', ()=> { if(!testActive) renderStudyLog(); });

// ----- showMain ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¦ãƒ›ãƒ¼ãƒ è¡¨ç¤º -----
if (typeof showMain === 'function') {
  const __orig_showMain = showMain;
  showMain = function(...args){
    __orig_showMain.apply(this, args);
    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’èª­ã¿å–ã£ã¦ã‹ã‚‰ãƒ›ãƒ¼ãƒ ã‚’æç”»ï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ›ãƒ¼ãƒ ã¯æç”»ï¼‰
    refreshHeaderNickname()
      .then(()=>{
        renderHome();
      })
      .catch(()=>{
        renderHome();
      })
      .finally(()=>{
        // ã“ã“ã‹ã‚‰è¿½åŠ  --- â–¼
        refreshBnpDisplay().catch(()=>{});
        creditDailyLoginBonusIfNeeded().catch(()=>{});
        // ã“ã“ã¾ã§è¿½åŠ  --- â–²
      });
  };
}

    /* ============== ã“ã“ã¾ã§ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ ============== */
// ----- ç®¡ç†è€…ç”»é¢: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -----
async function renderUserManagement(){
  if(!currentUser || currentUser.role !== 'admin'){
    alert('ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™');
    return;
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆç®¡ç†è€…ç”¨ï¼‰</h2>
      <div style="margin-bottom:12px;">
        <input id="um-filter" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§çµã‚Šè¾¼ã¿" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:40%" />
        <button id="um-refresh" class="btn-plain" style="margin-left:8px;">å†èª­ã¿è¾¼ã¿</button>
      </div>
      <div id="um-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  `;

  document.getElementById('um-refresh').addEventListener('click', loadUserList);
  document.getElementById('um-filter').addEventListener('input', ()=> { loadUserList(); });

  await loadUserList();
}

async function loadUserList(){
  const container = document.getElementById('um-list');
  if(!container) return;
  container.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

  try {
    const qSnap = await getDocs(collection(db,'users'));
    const filter = (document.getElementById('um-filter')||{value:''}).value.trim().toLowerCase();

    let rows = [];
    qSnap.forEach(d => {
      const item = { id: d.id, ...d.data() };
      if(item.bnp == null) item.bnp = 0;
      if(item.nickname == null) item.nickname = item.username || item.id;
      if(filter && !String(item.id).toLowerCase().includes(filter) && !String(item.username||'').toLowerCase().includes(filter)) return;
      rows.push(item);
    });

    if(rows.length === 0){
      container.innerHTML = '<div style="color:#666">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    let html = `<table style="width:100%;border-collapse:collapse;"><thead>
      <tr style="text-align:left;border-bottom:1px solid #eef3f5;">
        <th style="padding:8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
        <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
        <th>BNP</th>
        <th>æ“ä½œ</th>
      </tr></thead><tbody>`;
    rows.forEach(u=>{
      html += `<tr data-uid="${escapeHtml(u.id)}" style="border-bottom:1px solid #f7f9fa;">
        <td style="padding:8px;vertical-align:top;">${escapeHtml(u.id)}</td>
        <td style="vertical-align:top;">
          <input class="um-nickname" value="${escapeHtml(u.nickname||'')}" style="padding:6px;border:1px solid #d0d7dc;border-radius:6px;" />
          <button class="btn-plain um-save-nick" style="margin-left:6px;">ä¿å­˜</button>
        </td>
        <td style="vertical-align:top;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="um-bnp-value" style="min-width:80px;font-weight:bold;">${Number(u.bnp||0)}</div>
            <input type="number" class="um-bnpdelta" value="10" style="width:80px;padding:6px;border-radius:6px;border:1px solid #d0d7dc;" />
            <button class="btn-plain um-add">ä»˜ä¸</button>
            <button class="btn-plain btn-danger um-sub">æ²¡å</button>
          </div>
        </td>
        <td style="vertical-align:top;">
          <button class="btn-plain um-set" style="margin-right:6px;">ç›´æ¥è¨­å®š</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;

    // attach handlers
    Array.from(container.querySelectorAll('.um-save-nick')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newNick = tr.querySelector('.um-nickname').value.trim() || uid;
        try {
          await updateDoc(doc(db,'users',uid), { nickname: newNick });
          alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          if(currentUser && currentUser.id === uid){ currentUser.nickname = newNick; const el = document.getElementById('user-name'); if(el) el.textContent = newNick; }
        } catch(err){ console.error(err); alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    });

    Array.from(container.querySelectorAll('.um-add')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('å¢—æ¸›é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã« ${delta} bnp ã‚’ä»˜ä¸ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await changeUserBnp(uid, delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-sub')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('å¢—æ¸›é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã‹ã‚‰ ${delta} bnp ã‚’æ²¡åã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await changeUserBnp(uid, -delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-set')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newVal = Number(prompt(`${uid} ã® bnp ã‚’ã„ãã¤ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`, tr.querySelector('.um-bnp-value').textContent) || 0);
        if(isNaN(newVal)){ alert('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã® bnp ã‚’ ${newVal} ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`)) return;
        try {
          await updateDoc(doc(db,'users',uid), { bnp: newVal });
          tr.querySelector('.um-bnp-value').textContent = newVal;
          if(currentUser && currentUser.id === uid){ refreshHeaderBnp(); } // update header if self
        } catch(err){ console.error(err); alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    });

  } catch(err){
    console.error('loadUserList error', err);
    container.innerHTML = `<div style="color:#666">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
  }
}

// bnp ã‚’å¤‰æ›´ã™ã‚‹å…±é€šå‡¦ç†ï¼ˆèª­ã¿å–ã‚Šâ†’åŠ ç®—â†’ä¿å­˜ï¼‰
async function changeUserBnp(uid, delta, trElement){
  try {
    const uRef = doc(db,'users',uid);
    const snap = await getDoc(uRef);
    let currentVal = 0;
    if(snap.exists()) currentVal = Number(snap.data().bnp || 0);
    const newVal = currentVal + Number(delta || 0);
    await updateDoc(uRef, { bnp: newVal });
    if(trElement){
      trElement.querySelector('.um-bnp-value').textContent = newVal;
    }
    if(currentUser && currentUser.id === uid){
      refreshHeaderBnp();
    }
    alert('æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(err){
    console.error(err);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
  }
}

  </script>


</body>
</html>

